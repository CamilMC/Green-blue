---
title: "TOC_model_1995"
author: "Camille Crapart"
date: "2023-04-21"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center", collapse = T)
options(knitr.kable.NA="", knitr.table.format = "html")
```

```{r libraries}
library(raster)
library(sf)
library(dplyr)
library(ggplot2)
library(colorspace)

library(spdep)
library(spatialreg)


```

# Northern Lakes Survey Data 1995


## Data from NOFA database

The data used here has been prepared in @Crapart2023.

```{r load-data, eval = F}
catchment.poly <- readRDS("catchment.poly.Rdata")
toc.df <- readRDS("toc.df.Rdata")
runoff <- readRDS("runoff.fennoscandia.rds")
```

## Historical land-cover data

HILDA data are downloaded from https://www.wur.nl/en/research-results/chair-groups/environmental-sciences/laboratory-of-geo-information-science-and-remote-sensing/models/hilda/hilda-data-downloads.html

```{r extract-data-hilda, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster()
raster(hilda.raster)

hilda.1999 <- raster::extract(hilda.raster, layer = 11, catchment.poly[1,])

saveRDS(hilda.1999, "hilda.1999.fns.rds")

```

Hilda categories:

* 77: Water
* 66: Other land
* 55: Grass/schrubland
* 45: Forest, mixed
* 44: Forest, deciduous broad leaf
* 43: Forest: deciduous needle
* 42: Forest, evergreen borad leaf
* 41: Forest, evergreen needle
* 40: Forest, other
* 33: Pasture
* 22: Cropland
* 11: Urban

```{r tabulate-hilda, eval = F}
hilda.1999 <- readRDS("hilda.1999.fns.rds")
hilda.tab <- sapply(hilda.1999, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- catchment.poly$ebint
saveRDS(hilda.tab.prop,"hilda.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") %>% tibble::rownames_to_column(var = "ebint")
saveRDS(forest,"forest.rds")
```

## Sulfur deposition data

Sulfur data is historical date modelled with the NorESM model, downloaded from CIMP5, kg/m2/s

Research criteria: 

* CIMP5 models
* historical
* r1i1p1
* NorESM1

```{r extract-sulfur, eval = F}
catchment.poly <- readRDS("catchment.poly.Rdata")

dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1681:1812)) %>% mean() # year 1990-2000
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1681:1812)) %>% mean() 
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1681:1812)) %>% mean() 
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1681:1812)) %>% mean() 

dryso2.df <- extract(dryso2, catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("ebint","dso2")
dryso4.df <- extract(dryso4, catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("ebint","dso4")
wetso2.df <- extract(wetso2, catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("ebint","wso2")
wetso4.df <- extract(wetso4, catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("ebint","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "ebint") %>% merge(wetso2.df, by = "ebint") %>% merge(wetso4.df, by = "ebint")
sdep.df$tsdep <- rowSums(sdep.df@data[,c(2:5)])

saveRDS(sdep.df, "sdep.df.1995.rds")
```

## Runoff, 10 years average

```{r runoff-1995, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1681:1812))
runoff.mean <- runoff.stack %>% mean() 

runoff.1995 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1995) <- c("ebint","runoff")
saveRDS(runoff.1995,"runoff.1995.rds")
```

## Merge df

```{r merge-data, eval = F}
catchment.poly <- readRDS("catchment.poly.Rdata")
toc.df <- readRDS("toc.df.Rdata")

toc.df$uncertain<- with(toc.df, ifelse(dist_closest_ebint/dist_2nd_closest_ebint > 0.5, FALSE, TRUE))
toc.df$uncertain[which(is.na(toc.df$uncertain)==TRUE)] <- FALSE

runoff <- readRDS("runoff.1995.rds")
forest<- readRDS("forest.rds")
sdep.df <- readRDS("sdep.df.1995.rds")

fns <- catchment.poly %>% merge(toc.df, by = "ebint") %>% merge(runoff, by = "ebint") %>% merge(forest, by = "ebint") %>% merge(sdep.df, by = "ebint") %>% filter(uncertain == FALSE) %>% filter(toc_mg_l >= 0) %>% filter(runoff > 0) %>% filter(!is.na(forest))

saveRDS(fns, "fns.rds")
```

```{r prepare-df-for-model, eval = F}
fen <- readRDS("fns.rds")

fen$uncertain <- NULL

fen$TOC <- fen$toc_mg_l
fen$logTOC <- log10(fen$TOC)

fen$TSdep <- fen$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
fen$logTSdep <- log10(fen$TSdep)

fen$Runoff <- fen$runoff * 365 * 60 * 60 # converts to kg/year
fen$logRunoff <- log10(fen$Runoff)

saveRDS(fen, "fen.rds")
```


```{r histograms}
fen <- readRDS("fen.rds")

ghist <- function(df){
  df <- st_drop_geometry(df)
  i <- dim(df)[2]
  for(n in 1:i){
  hist(df[,n], main = names(df)[n], xlab = names(df)[n])
      }
}

ghist(fen)
```

# TOC modelled by SELM

```{r kmat, eval = F}
fen.spdf <- SpatialPointsDataFrame(st_drop_geometry(fen)[,c("longitude","latitude")], st_drop_geometry(fen))
fen.kmat <- knearneigh(fen.spdf, k = 100) %>% knn2nb() %>% nb2listw()
saveRDS(fen.kmat, "fen.kmat.rds")
```

```{r toc-map}

library(colorspace)
lims <- c(0,20) # 75% of TOC values under 20 mg/L

ggplot(fen)+geom_point(aes(x = longitude, y = latitude, col = TOC))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  theme_void()

```

## Redo SEM with bogs as in paper 2

```{r with-bogs-arable, eval = F}
bogs <- readRDS("bogs.clc.rds") #from CLC
arable <- readRDS("arable.clc.rds")
forest <- readRDS("forest.clc.rds")
fen <- readRDS("fen.rds") %>% merge(bogs, by = "ebint") %>% merge(forest, by = "ebint") %>% merge(arable, by = "ebint")

fen.kmat <- readRDS("fen.kmat.rds")

sem.fen.5 <- errorsarlm(logTOC ~ forest.y + bogs + arable + logRunoff + TSdep, fen, fen.kmat)
saveRDS(sem.fen.5, "sem.fen.5.rds")

```

```{r sem-5-plots}
sem.fen.5 <- readRDS("sem.fen.5.rds")
fen.kmat <- readRDS("fen.kmat.rds")

qplot(x = sem.fen.5$fitted.values, y = fen$logTOC) + geom_point() + labs(x = "logTOC fitted", y = "logTOC")+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  annotate(geom = "label", label = paste("AIC = ", round(AIC(sem.fen.5),2), ""), x = 1, y = -0.25)
qplot(x = sem.fen.5$fitted.values, y = sem.fen.5$residuals) + geom_point() + labs(x = "logTOC fitted", y = "Residuals")
hist(sem.fen.5$residuals)

fen$TOCfit <- 10^(sem.fen.5$fitted.values)

ggplot(fen)+geom_point(aes(x = TOCfit, y = TOC))+geom_abline(slope = 1, intercept = 0, lty = 2)
ggplot(fen)+geom_point(aes(x = TOCfit, y = TOC))+geom_abline(slope = 1, intercept = 0, lty = 2)+coord_trans(x= "log10", y = "log10")

moran.I.res.sem <- moran.test(sem.fen.5$residuals, fen.kmat, alternative = "two.sided")
print(summary(sem.fen.5))
print(moran.I.res.sem)
```

```{r sem-5-maps}
ggplot(fen)+geom_point(aes(x = longitude, y = latitude, col = TOCfit))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  theme_void()
```

## SEM logTOC ~ forest + logRunoff + logTSdep

```{r sem-log, eval = F}
library(spatialreg)
fen <- readRDS("fen.rds")
fen.kmat <- readRDS("fen.kmat.rds")

sem.fen.log <- errorsarlm(logTOC ~ forest + logRunoff + logTSdep, fen, fen.kmat)
saveRDS(sem.fen.log, "sem.fen.log.rds")
```

```{r sem-log-plots}
sem.fen.log <- readRDS("sem.fen.log.rds")
fen.kmat <- readRDS("fen.kmat.rds")


qplot(x = sem.fen.log$fitted.values, y = fen$logTOC) + geom_point()+ geom_abline(slope = 1, intercept = 0, lty = 2)+
  annotate(geom = "label", label = paste("AIC = ", round(AIC(sem.fen.log),2), ""), x = 1, y = -0.25)+
  labs(y = "logTOC", x = "logTOC fitted")

qplot(x = sem.fen.log$fitted.values, y = sem.fen.log$residuals) + geom_point()+ labs(x = "fitted values", y = "residuals")
hist(sem.fen.log$residuals)


fen$TOCfit <- 10^(sem.fen.log$fitted.values)

ggplot(fen)+geom_point(aes(x = TOCfit, y = TOC))+geom_abline(slope = 1, intercept = 0, lty = 2)+labs(x = "TOC fitted", y = "TOC")

moran.I.res.sem <- moran.test(sem.fen.log$residuals, fen.kmat, alternative = "two.sided")
print(moran.I.res.sem)

print(summary(sem.fen.log))
```

```{r sem-log-maps}
ggplot(fen)+geom_point(aes(x = longitude, y = latitude, col = TOCfit))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  theme_void()
```

Problem: logTSdep has a positive coefficient. Only reflects that the South (where there is more TOC) is more affected by TSdep.

## SEM logTOC ~ forest + logRunoff + logTSdep*latitude

This model includes the latitude in order to counterbalance the geographical repartition of TSdep. Now TSdep has a negative impact on TOC. 

```{r sem-log-lat, eval = F}
library(spatialreg)
fen <- readRDS("fen.rds")
fen.kmat <- readRDS("fen.kmat.rds")

sem.fen.log.lat <- errorsarlm(logTOC ~ forest + logRunoff + logTSdep*latitude, fen, fen.kmat)
saveRDS(sem.fen.log.lat, "sem.fen.log.lat.rds")
```

```{r sem-log-lat-plots}
sem.fen.log.lat <- readRDS("sem.fen.log.lat.rds")
fen.kmat <- readRDS("fen.kmat.rds")

qplot(x = sem.fen.log.lat$fitted.values, y = fen$logTOC) + geom_point()+ geom_abline(slope = 1, intercept = 0, lty = 2)+
  annotate(geom = "label", label = paste("AIC = ", round(AIC(sem.fen.log.lat),2), ""), x = 1, y = -0.25)+
  labs(y = "logTOC", x = "logTOC fitted")

qplot(x = sem.fen.log.lat$fitted.values, y = sem.fen.log.lat$residuals) + geom_point()+ labs(x = "fitted values", y = "residuals")
hist( sem.fen.log.lat$residuals)


fen$TOCfit <- 10^(sem.fen.log.lat$fitted.values)

ggplot(fen)+geom_point(aes(x = TOCfit, y = TOC))+geom_abline(slope = 1, intercept = 0, lty = 2)+labs(x = "TOC fitted", y = "TOC")

moran.I.res.sem <- moran.test(sem.fen.log$residuals, fen.kmat, alternative = "two.sided")
print(moran.I.res.sem)

print(summary(sem.fen.log.lat))
```

```{r sem-log-lat-maps}
ggplot(fen)+geom_point(aes(x = longitude, y = latitude, col = TOCfit))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  theme_void()
```


# TOC modelled by GLM 

In the GLM no value can be under 0. Small runoff and TOC values, once logged, can be negative -> therefore Runoff is transformed in mg/y and TOC in ug/L. 

## GLM logTOC ~ forest + logRunoff + logTSdep*latitude

```{r glm-log, eval = T}
fen <- readRDS("fen.rds")
fen.kmat <- readRDS("fen.kmat.rds")

fen$logRunoff.mg <- log10(fen$Runoff*1e6)
fen$TOC.ug <- fen$TOC *1e3
fen$logTOC.ug <- log10(fen$TOC.ug)

glm.log <- lm(logTOC.ug ~ forest + logRunoff.mg + latitude*logTSdep, data = fen)
print(summary(glm.log))

qplot(x = glm.log$fitted.values, y = fen$logTOC.ug)+geom_abline(slope = 1, intercept = 0, lty = 2)+
  annotate(geom = "label", label = paste("AIC = ", round(AIC(glm.log),2), ""), x = 4, y = 2.5)
qplot(x = glm.log$fitted.values,y = glm.log$residuals)
hist(glm.log$residuals)

moran.I.res.glm <- moran.test(glm.log$residuals, fen.kmat, alternative = "two.sided")
print(moran.I.res.glm)

qplot(x = fen$longitude, y = fen$latitude, col = (10^glm.log$fitted.values)*1e-3)+geom_point()+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC, mg")+
  theme_void()

saveRDS(glm.log,"glm.log.rds")

```



## GLM logTOC~forest*logTSdep + Runoff

```{r glm-toc, eval = T}
fen <- readRDS("fen.rds")
fen.kmat <- readRDS("fen.kmat.rds")

fen$logRunoff.mg <- log10(fen$Runoff*1e6) # from kg to mg
fen$TOC.ug <- fen$TOC *1e3
fen$logTOC.ug <- log10(fen$TOC.ug)

glm.toc <- lm(logTOC.ug ~ forest*logTSdep + logRunoff.mg, data = fen)
print(summary(glm.toc))

qplot(x = glm.toc$fitted.values, y = fen$logTOC.ug)+geom_abline(slope = 1, intercept = 0, lty = 2)+
  annotate(geom = "label", label = paste("AIC = ", round(AIC(glm.toc),2), ""), x = 4, y = 2.5)
qplot(x = glm.toc$fitted.values,y = glm.toc$residuals)
hist(glm.toc$residuals)

moran.I.res.glm <- moran.test(glm.toc$residuals, fen.kmat, alternative = "two.sided")
print(moran.I.res.glm)

qplot(x = fen$longitude, y = fen$latitude, col = (10^glm.toc$fitted.values)*1e-3)+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC, mg")+
  theme_void()

saveRDS(glm.toc, "glm.toc.rds")
```

# GLM with logTOC~ Forest + Runoff

```{r glm-no-sdep, eval = T}
fen <- readRDS("fen.rds")

fen$logRunoff.mg <- log10(fen$Runoff*1e6)
fen$TOC.ug <- fen$TOC *1e3
fen$logTOC.ug <- log10(fen$TOC.ug)

glm.nosdep <- lm(logTOC.ug ~ forest + logRunoff.mg, data = fen)
print(summary(glm.nosdep))

qplot(x = glm.nosdep$fitted.values, y = fen$logTOC.ug)+geom_abline(slope = 1, intercept = 0, lty = 2)+
  annotate(geom = "label", label = paste("AIC = ", round(AIC(glm.nosdep),2), ""), x = 4, y = 2.5)
qplot(x = glm.nosdep$fitted.values,y = glm.nosdep$residuals)
hist(glm.nosdep$residuals)

moran.I.res.glm <- moran.test(glm.nosdep$residuals, fen.kmat, alternative = "two.sided")
print(moran.I.res.glm)

qplot(x = fen$longitude, y = fen$latitude, col = (10^glm.nosdep$fitted.values)*1e-3)+geom_point()+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC, mg")+
  theme_void()

saveRDS(glm.nosdep, "glm.nosdep.rds")
```




# Estimate TOC export by watershed

```{r toc-export-1995}
library(units)
fen <- readRDS("fen.rds")

sf_use_s2(FALSE)
fen$area <- st_area(fen) %>% set_units(NULL)
fen$yearlyTOC.Tg <- with(fen, TOC * runoff * 365 * 60 * 60 * area)*1e-15 # TOC exported by year in Tg


basins <- st_read("basins_all_sea.shp") %>% st_cast("POLYGON")
st_crs(basins) <- st_crs(4326)
basins$sea <- with(basins, ifelse(Poly %in% c(1:161), "Baltic",
                                  ifelse(Poly %in% c(162:253), "North",
                                    "NCC")))

basins.fen <- st_join(st_transform(fen, st_crs(4326)), basins)

basins.fen.exp <- basins.fen %>% st_drop_geometry() %>% group_by(sea) %>% summarise(yearlyTOC.Tg = sum(yearlyTOC.Tg))

print(basins.fen.exp)

ggplot(fen)+geom_point(aes(x = TOC, y = yearlyTOC.Tg))

ggplot()+geom_sf(data = fen, aes(col = yearlyTOC.Tg, fill = yearlyTOC.Tg))+
  geom_sf(data = basins, col = "black", fill = NA)+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), rev = T,  na.value = "black")+
  ylim(55,71)+theme_void()
```