---
title: "Coastal Darkening in the 20th century"
author: "Camille Crapart"
date: "2023-06-06"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center", collapse = T)
options(knitr.kable.NA="", knitr.table.format = "html")
```

# Load data

```{r libraries}
library(raster)
library(sf)
library(dplyr)
library(ggplot2)
library(ggsflabel)
library(colorspace)
library(directlabels)
library(RColorBrewer)
library(ggpubr)
library(kableExtra)

library(spdep)
library(spatialreg)

lims <- c(0,20)

wr.sf <- readRDS("wr.sf.rds")

sf_use_s2(FALSE)
wr.centroid <- st_centroid(wr.sf) %>% st_transform(st_crs(4326))
wr.sf$latitude <- st_coordinates(wr.centroid)[,2]
wr.sf$longitude <- st_coordinates(wr.centroid)[1,]

wr.sf.wgs84 <- readRDS("wr.sf.wgs84.rds")

wr.basins <- readRDS("wr.basins.rds")
```

```{r function-plot}

plot.export <- function(df, main.title){
 g <- ggplot(df, aes(x=year, y = TOC, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+
  labs(y = "Predicted TOC concentration, mg/L", title = main.title, col = "Sea")+
  theme_minimal()+theme(axis.text.x =element_text(angle = 45))
h <- ggplot(df, aes(x=year, y = yearlyTOC.Tg, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+
  labs(y = "Yearly export of TOC, Tg", title = "", col = "Sea")+
  theme_minimal()+theme(axis.text.x =element_text(angle = 45))

ggpubr::ggarrange(g,h, common.legend = T, legend = "bottom") %>% print()
}

plot.historical <- function(df, main.title){

for(i in unique(df$gid)){
g <- ggplot(filter(df, gid == i))+
  geom_point(aes(x = Year, y = TOC, col = Name), size = 0.5)+
  #geom_line(aes(x = Year, y = TOC, col = Name, group = Name), lty = 2)+
  geom_point(aes(x = decade, y = TOC.obs), col = "mediumaquamarine")+
  geom_line(aes(x = decade, y = TOC.obs, group = gid), col = "mediumaquamarine", lty = 1)+
  geom_point(aes(x = as.numeric(year), y = TOC.fit), col = "firebrick")+
  geom_line(aes(x = as.numeric(year), y = TOC.fit, group = gid), col = "firebrick", lty = 1)+
  labs(x = "", y = "TOC, mg/L", col = "River", title = main.title)+
  scale_color_brewer(palette = "Dark2")+
  expand_limits(x = 2029)+
  #facet_grid(cols = vars(Name))+
  theme_minimal()+theme(legend.position = "none")
h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid == i))+geom_sf(data = filter(st_as_sf(df), gid == i), aes(color = Name))+
  borders(regions = "Sweden")+scale_color_brewer(palette = "Dark2")+
  labs(color = "River")+theme_void()+theme(legend.position = "bottom")
ggpubr::ggarrange(g,h, widths = c(2,1)) %>% print()
}
  
}

plot.historical2 <- function(df, main.title){

for(i in unique(df$gid)){
g <- ggplot(filter(df, gid == i))+
  geom_point(aes(x = Year, y = TOC, col = as.factor(gid)), size = 0.5)+
  #geom_line(aes(x = Year, y = TOC, col = Name, group = Name), lty = 2)+
  geom_point(aes(x = decade, y = TOC.obs), col = "mediumaquamarine")+
  geom_line(aes(x = decade, y = TOC.obs, group = gid), col = "mediumaquamarine", lty = 1)+
  geom_point(aes(x = as.numeric(year), y = TOC.fit), col = "firebrick")+
  geom_line(aes(x = as.numeric(year), y = TOC.fit, group = gid), col = "firebrick", lty = 1)+
  labs(x = "", y = "TOC, mg/L", col = "River", title = main.title)+
  scale_color_brewer(palette = "Dark2")+
  expand_limits(x = 2029)+
  #facet_grid(cols = vars(Name))+
  theme_minimal()+theme(legend.position = "none")
h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid == i))+geom_sf(data = filter(st_as_sf(df), gid == i), aes(color = as.factor(gid)))+
  borders(regions = "Sweden")+scale_color_brewer(palette = "Dark2")+
  labs(color = "River")+theme_void()+theme(legend.position = "bottom")
ggpubr::ggarrange(g,h, widths = c(2,1)) %>% print()
}
  
}
```

# SELM logTOC \~ forest + cropland + shrubland + logRunoff + logTSdep

## Model results

```{r kmat, eval = F}
fen <- readRDS("fen.rds")
fen.spdf <- SpatialPointsDataFrame(st_drop_geometry(fen)[,c("longitude","latitude")], st_drop_geometry(fen))
fen.kmat <- knearneigh(fen.spdf, k = 100) %>% knn2nb() %>% nb2listw()
saveRDS(fen.kmat, "fen.kmat.rds")
```

```{r sem-crop, eval = F}
library(spatialreg)
fen <- readRDS("fen.rds")
fen.kmat <- readRDS("fen.kmat.rds")

sem.fen.crop <- errorsarlm(logTOC ~ forest + cropland + schrubland + logRunoff + logTSdep, fen, fen.kmat)
saveRDS(sem.fen.crop, "sem.fen.crop.rds")
```

```{r sem-crop-plots}
fen <- readRDS("fen.rds")
sem.fen.crop <- readRDS("sem.fen.crop.rds")
fen.kmat <- readRDS("fen.kmat.rds")

qplot(x = sem.fen.crop$fitted.values, y = fen$logTOC) + geom_point()+ geom_abline(slope = 1, intercept = 0, lty = 2)+
  annotate(geom = "label", label = paste("AIC = ", round(AIC(sem.fen.crop),2), ""), x = 1, y = -0.25)+
  labs(y = "logTOC", x = "logTOC fitted")

qplot(x = sem.fen.crop$fitted.values, y = sem.fen.crop$residuals) + geom_point()+ labs(x = "fitted values", y = "residuals")
hist(sem.fen.crop$residuals)


fen$TOCfit <- 10^(sem.fen.crop$fitted.values)

ggplot(fen)+geom_point(aes(x = TOCfit, y = TOC))+geom_abline(slope = 1, intercept = 0, lty = 2)+labs(x = "TOC fitted", y = "TOC")

moran.I.res.sem <- moran.test(sem.fen.crop$residuals, fen.kmat, alternative = "two.sided")
print(moran.I.res.sem)

print(summary(sem.fen.crop))
```

```{r sem-crop-maps}
ggplot(fen)+geom_point(aes(x = longitude, y = latitude, col = TOCfit))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  theme_void()
```

## Prediction by decade

```{r load-sem-model}
toc_model <- readRDS("sem.fen.crop.rds")
wr.kmat <- readRDS("wr.kmat.rds")
```

```{r predict-1899-semcrop, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1899.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1899.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899, wr.kmat)[,1]
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.semcrop.rds")
```

```{r predict-1909-semcrop, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1909.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1909.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909, wr.kmat)[,1]
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.semcrop.rds")
```

```{r predict-1919-semcrop, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1919.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1919.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919, wr.kmat)[,1]
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.semcrop.rds")
```

```{r predict-1929-semcrop, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1929.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1929.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929, wr.kmat)[,1]
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.semcrop.rds")
```

```{r predict-1939-semcrop, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1939.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1939.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939, wr.kmat)[,1]
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.semcrop.rds")
```

```{r predict-1949-semcrop, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1949.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1949.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949, wr.kmat)[,1]
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.semcrop.rds")
```

```{r predict-1959-semcrop, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1959.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1959.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959, wr.kmat)[,1]
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.semcrop.rds")
```

```{r predict-1969-semcrop, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1969.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1969.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969, wr.kmat)[,1]
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.semcrop.rds")
```

```{r predict-1979-semcrop, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1979.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1979.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979, wr.kmat)[,1]
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.semcrop.rds")
```

```{r predict-1989-semcrop, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1989.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1989.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989, wr.kmat)[,1]
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.semcrop.rds")
```

```{r predict-1999-semcrop, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1999.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1999.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999, wr.kmat)[,1]
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.semcrop.rds")
```

```{r predict-1999-semcrop-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1999.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1999.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999, wr.kmat)[,1]
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.semcrop.emep.rds")
```

```{r predict-2009-semcrop-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.2009.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.2009.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009, wr.kmat)[,1]
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.semcrop.rds")
```

```{r predict-2019-semcrop-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.2019.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.2019.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019, wr.kmat)[,1]
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.semcrop.rds")
```

## Compare exports

```{r common-semcrop, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.semcrop.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.semcrop.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.semcrop.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.semcrop.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.semcrop.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.semcrop.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.semcrop.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.semcrop.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.semcrop.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.semcrop.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.semcrop.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.semcrop.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.semcrop.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

wr.basins <- readRDS("wr.basins.rds")

wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.semcrop.rds")
saveRDS(wr.exp, "wr.exp.semcrop.rds")
```

```{r plot-exp-semcrop}
wr.exp <- readRDS("wr.exp.semcrop.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, "LM logTOC ~ forest + cropland + shrubland + logRunoff + TSdep ")
```

```{r export}
plot.export <- function(df, main.title){
 g <- ggplot(df, aes(x=year, y = TOC, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+
  labs(y = "Predicted TOC concentration, mg/L", title = main.title, col = "Sea")+
  theme_minimal()+theme(axis.text.x =element_text(angle = 45))}
```

## Comparison with historical data

```{r compare-swedish-semcrop, eval = F}

merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.semcrop.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","TOC.decade","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, "LM logTOC ~ forest + cropland + shrubland + logRunoff + logTSdep")

```

# LM logTOC \~ forest + cropland + shrubland + logRunoff + logTSdep

```{r glm-crop, eval = T}
fen <- readRDS("fen.rds")

lm.log <- lm(logTOC ~ forest + cropland + schrubland + logRunoff + logTSdep, data = fen)
print(summary(lm.log))

plot(x = lm.log$fitted.values, y = fen$logTOC)
abline(b = 1, a = 0, lty = 2)
plot(x = lm.log$fitted.values,y = lm.log$residuals)
hist(lm.log$residuals)

qplot(x = fen$longitude, y = fen$latitude, col = (10^lm.log$fitted.values))+geom_point()+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC, mg")+
  theme_void()

saveRDS(lm.log,"lm.crop.rds")

```

## Prediction by decade

```{r load-lm-model}
toc_model <- readRDS("lm.crop.rds")
```

```{r predict-1899-lmcrop, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1899.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1899.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.lmcrop.rds")
```

```{r predict-1909-lmcrop, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1909.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1909.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.lmcrop.rds")
```

```{r predict-1919-lmcrop, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1919.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1919.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.lmcrop.rds")
```

```{r predict-1929-lmcrop, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1929.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1929.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.lmcrop.rds")
```

```{r predict-1939-lmcrop, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1939.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1939.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.lmcrop.rds")
```

```{r predict-1949-lmcrop, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1949.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1949.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.lmcrop.rds")
```

```{r predict-1959-lmcrop, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1959.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1959.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.lmcrop.rds")
```

```{r predict-1969-lmcrop, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1969.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1969.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.lmcrop.rds")
```

```{r predict-1979-lmcrop, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1979.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1979.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.lmcrop.rds")
```

```{r predict-1989-lmcrop, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1989.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1989.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.lmcrop.rds")
```

```{r predict-1999-lmcrop, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1999.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1999.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.lmcrop.rds")
```

```{r predict-1999-lmcrop-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1999.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1999.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.lmcrop.emep.rds")
```

```{r predict-2009-lmcrop-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.2009.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.2009.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009)
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.lmcrop.rds")
```

```{r predict-2019-lmcrop-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.2019.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.2019.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019)
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.lmcrop.rds")
```

## Compare exports

```{r common-lmcrop, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.lmcrop.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.lmcrop.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.lmcrop.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.lmcrop.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.lmcrop.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.lmcrop.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.lmcrop.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.lmcrop.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.lmcrop.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.lmcrop.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.lmcrop.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.lmcrop.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.lmcrop.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

wr.basins <- readRDS("wr.basins.rds")

wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.lmcrop.rds")
saveRDS(wr.exp, "wr.exp.lmcrop.rds")
```

```{r plot-exp-lmcrop}
wr.exp <- readRDS("wr.exp.lmcrop.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, "LM logTOC ~ forest + cropland + shrubland + logRunoff + TSdep ")
```

```{r updated-export}

 g <- ggplot(basins.exp, aes(x=year, y = TOC, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+
  labs(y = "Average predicted TOC concentration in surface waster\ngrouped by sea drainage basin, mg/L", title = "", col = "Sea")+
  theme_minimal(base_size = 15)+theme(axis.text.x =element_text(angle = 45))
h <- ggplot(basins.exp, aes(x=year, y = yearlyTOC.Tg, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+
  labs(y = "Yearly export of TOC\ngrouped by sea drainage basin, Tg", title = "", col = "Sea")+
  theme_minimal(base_size = 15)+theme(axis.text.x =element_text(angle = 45))

i <- ggpubr::ggarrange(g,h, common.legend = T, legend = "bottom") %>% print()

ggsave(filename = "updated.export.png", i, dpi = "retina", width = 10, height = 5)
```

## Comparison with historical data

```{r compare-swedish-lmcrop, eval = T}

merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.lmcrop.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","TOC.decade","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

#plot.historical(total, "LM logTOC ~ forest + cropland + shrubland + logRunoff + logTSdep")

df <- total %>% filter(Name != "Laxbacken")
for(i in unique(df$gid)){
g <- ggplot(filter(df, gid == i))+
  geom_point(aes(x = Year, y = TOC, col = Name), size = 0.5)+
  geom_smooth(aes(x = Year, y = TOC, col = Name, group = Name), method = "loess", n = 13, se = F, lty = 1, size = 0.5)+
  geom_point(aes(x = as.numeric(year), y = TOC.fit), col = "firebrick")+
  geom_line(aes(x = as.numeric(year), y = TOC.fit, group = gid), col = "firebrick", lty = 1)+
  labs(x = "", y = "TOC, mg/L", col = "River", title = i)+
  scale_color_brewer(palette = "Dark2")+
  expand_limits(x = 2029)+
  #facet_grid(cols = vars(Name))+
  theme_minimal()+theme(legend.position = "bottom")
h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid == i))+geom_sf(data = filter(st_as_sf(df), gid == i), aes(color = Name))+
  borders(regions = "Sweden")+scale_color_brewer(palette = "Dark2")+
  labs(color = "River")+theme_void()+theme(legend.position = "bottom")
ggpubr::ggarrange(g,h, widths = c(2,1), common.legend = T) %>% print()
}



```

```{r selected-rivers, fig.dim = c(8,6)}

rivers <- c("Tornealven","Klaralven", "Narkes Svarta","Tidan", "Motala Strom")

df <- filter(total, Name %in% rivers)
  
g <- ggplot(df)+
  geom_point(aes(x = Year, y = TOC, col = Name), size = 0.5)+
  geom_smooth(aes(x = Year, y = TOC, col = Name, group = Name), method = "loess", n = 13, se = F, lty = 1, linewidth = 0.2)+
  geom_point(aes(x = as.numeric(year), y = TOC.fit), col = "firebrick")+
  geom_line(aes(x = as.numeric(year), y = TOC.fit, group = gid), col = "firebrick", lty = 1)+
  labs(x = "", y = "TOC, mg/L", col = "River", title = "")+
  scale_y_continuous(limits = c(0.5, 19.5), breaks = c(5, 10, 15))+
  scale_color_brewer(palette = "Dark2")+
  expand_limits(x = 2029)+
  facet_grid(rows = vars(factor(Name, levels = rivers)))+
  theme_minimal()+theme(legend.position = "none")

df <- filter(total, Name %in% rivers) %>% distinct(Name, geometry, gid)

h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid %in% df$gid))+
  geom_sf(data = st_as_sf(df), aes(color = Name))+
  geom_sf_label_repel(data = st_as_sf(df), aes(color = Name, label = Name),
                      nudge_x = ifelse(df$Name %in% c("Narkes Svarta","Motala Strom"), +12, -10),
                      nudge_y = ifelse(df$Name %in% c("Flian","Motala Strom"), -2, 0))+
  borders(regions = "Sweden")+
  scale_color_brewer(palette = "Dark2")+
  theme_void()+theme(legend.position = "none")

ggarrange(g,h,ncol = 2, width = c(3,1))

```

```{r compare-swedish-lmcrop-all, eval = T}

merged.rivers <- readRDS("merged.rivers.all.rds") %>% group_by(gid,decade) %>% mutate(nb = n())

rivers.obs <- merged.rivers %>% filter(nb > 20) %>% group_by(gid,decade) %>% summarise(TOC = mean(TOC)) %>% st_drop_geometry() %>% as.data.frame()
rivers.obs$model <- "obs"
rm.gid <- count(rivers.obs, gid) %>% filter(n == 1) %>% pull(gid)
many.gid <- count(rivers.obs, gid) %>% filter(n > 4) %>% pull(gid)
#rivers.obs <- filter(rivers.obs, !gid %in% rm.gid) #remove gid for which there are enough data for only one decade

wr.exp <- readRDS("wr.exp.lmcrop.rds") %>% select(c("gid","year","TOC.fit")) %>% setNames(c("gid","decade","TOC")) %>% filter(gid %in% rivers.obs$gid)
wr.exp$model <- "fit"

match.exp <- rbind(rivers.obs, wr.exp) 
  
for(i in many.gid){
g <- ggplot(filter(match.exp, gid == i))+
  geom_point(aes(x = decade, y = TOC, col = model), size = 1)+
  geom_line(aes(x = decade, y = TOC, group = model,col=model), lty = 1)+
  labs(x = "", y = "TOC, mg/L", col = "Model", title = i)+
  scale_color_manual(values = c("firebrick","mediumaquamarine"))+
  ylim(0,20)+
  theme_minimal()+theme(legend.position = "bottom",axis.text.x = element_text(angle = 90))
h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid == i))+
  geom_sf(data = filter(merged.rivers, gid == i & nb > 20), aes(col = nb), size = 0.5)+
  borders(regions = "Sweden")+
  scale_color_stepsn(colours = c("cornsilk", "mediumaquamarine"), breaks = c(50, 100,200))+
  labs(color = "Nb of obs")+
  theme_void()+theme(legend.position = "bottom")
ggpubr::ggarrange(g,h, widths = c(2,1)) %>% print()
}

```

```{r selected-wr, fig.dim = c(8,6)}
df <- match.exp %>% filter(gid %in% c("38747","169834","167089","270060","264568","284972"))

g <- ggplot()+
  geom_point(data = filter(df, model == "fit"), 
             aes(x = as.numeric(decade), y = TOC), 
             col = "firebrick", size = 1)+
  geom_line(data = filter(df, model == "fit"), 
            aes(x = as.numeric(decade), y = TOC, group = model), 
            col = "firebrick", lty = 1)+
  geom_point(data = filter(df, model == "obs"), 
                           aes(x = as.numeric(decade), y = TOC, col = as.factor(gid)), 
                           size = 1)+
  geom_line(data = filter(df, model == "obs"), 
            aes(x = as.numeric(decade), y = TOC, group = model,col=as.factor(gid)), 
            lty = 1)+
  labs(x = "", y = "TOC, mg/L", title = "")+ 
  scale_y_continuous(limits = c(0, 20), breaks = c(5, 10, 15))+
  scale_color_brewer(palette = "Dark2", direction = 1)+
  expand_limits(x = 2029)+
  facet_grid(rows = vars(factor(gid, levels = c("38747","169834","167089","264568","270060","284972"))))+
  theme_minimal()+theme(legend.position = "none")

h <- ggplot()+
  geom_sf(data = filter(wr.sf.wgs84, gid %in% df$gid), aes(fill = as.factor(gid)), alpha = 0.7)+
  scale_fill_brewer(palette = "Dark2", direction = 1)+
 # geom_sf_label_repel(data = filter(wr.sf.wgs84, gid %in% df$gid), 
  #                    aes(label = gid), fill = "white",
   #                   fun.geometry = sf::st_centroid,
    #                  nudge_x = 10)+
  borders(regions = "Sweden")+
  theme_void()+theme(legend.position = "none")

ggarrange(g,h, ncol = 2, width = c(3,1))
```

## Comparison with historical data, converted COD

```{r compare-swedish-lmcrop-cod, eval = T}

merged.rivers <- readRDS("merged.rivers.convcod.rds")

wr.exp <- readRDS("wr.exp.lmcrop.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","TOC.decade","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

#plot.historical(total, "LM logTOC ~ forest + cropland + shrubland + logRunoff + logTSdep")

df <- total %>% filter(Name != "Laxbacken")
for(i in unique(df$gid)){
g <- ggplot(filter(df, gid == i))+
  geom_point(aes(x = Year, y = TOC, col = Name), size = 0.5)+
  geom_smooth(aes(x = Year, y = TOC, col = Name, group = Name), method = "loess", n = 13, se = F, lty = 1, size = 0.5)+
  geom_point(aes(x = as.numeric(year), y = TOC.fit), col = "firebrick")+
  geom_line(aes(x = as.numeric(year), y = TOC.fit, group = gid), col = "firebrick", lty = 1)+
  labs(x = "", y = "TOC, mg/L", col = "River", title = i)+
  scale_color_brewer(palette = "Dark2")+
  expand_limits(x = 2029)+
  #facet_grid(cols = vars(Name))+
  theme_minimal()+theme(legend.position = "bottom")
h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid == i))+geom_sf(data = filter(st_as_sf(df), gid == i), aes(color = Name))+
  borders(regions = "Sweden")+scale_color_brewer(palette = "Dark2")+
  labs(color = "River")+theme_void()+theme(legend.position = "bottom")
ggpubr::ggarrange(g,h, widths = c(2,1), common.legend = T) %>% print()
}
```


```{r selected-rivers-cod, fig.dim = c(8,6)}

rivers <- c("Tornealven","Klaralven", "Narkes Svarta","Tidan", "Motala Strom")

df <- filter(total, Name %in% rivers)
  
g <- ggplot(df)+
  geom_point(aes(x = Year, y = TOC, col = Name), size = 0.5)+
  geom_smooth(aes(x = Year, y = TOC, col = Name, group = Name), method = "loess", n = 13, se = F, lty = 1, linewidth = 0.2)+
  geom_point(aes(x = as.numeric(year), y = TOC.fit), col = "firebrick")+
  geom_line(aes(x = as.numeric(year), y = TOC.fit, group = gid), col = "firebrick", lty = 1)+
  labs(x = "", y = "TOC, mg/L", col = "River", title = "")+
  scale_y_continuous(limits = c(0.5, 19.5), breaks = c(5, 10, 15))+
  scale_color_brewer(palette = "Dark2")+
  expand_limits(x = 2029)+
  facet_grid(rows = vars(factor(Name, levels = rivers)))+
  theme_minimal()+theme(legend.position = "none")

df <- filter(total, Name %in% rivers) %>% distinct(Name, geometry, gid)

h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid %in% df$gid))+
  geom_sf(data = st_as_sf(df), aes(color = Name))+
  geom_sf_label_repel(data = st_as_sf(df), aes(color = Name, label = Name),
                      nudge_x = ifelse(df$Name %in% c("Narkes Svarta","Motala Strom"), +12, -10),
                      nudge_y = ifelse(df$Name %in% c("Flian","Motala Strom"), -2, 0))+
  borders(regions = "Sweden")+
  scale_color_brewer(palette = "Dark2")+
  theme_void()+theme(legend.position = "none")

ggarrange(g,h,ncol = 2, width = c(3,1))

```

```{r compare-swedish-lmcrop-all-cod, eval = T}

merged.rivers <- readRDS("merged.rivers.all.rds") %>% group_by(gid,decade) %>% mutate(nb = n())

rivers.obs <- merged.rivers %>% filter(nb > 20) %>% group_by(gid,decade) %>% summarise(TOC = mean(TOC)) %>% st_drop_geometry() %>% as.data.frame()
rivers.obs$model <- "obs"
rm.gid <- count(rivers.obs, gid) %>% filter(n == 1) %>% pull(gid)
many.gid <- count(rivers.obs, gid) %>% filter(n > 4) %>% pull(gid)
#rivers.obs <- filter(rivers.obs, !gid %in% rm.gid) #remove gid for which there are enough data for only one decade

wr.exp <- readRDS("wr.exp.lmcrop.rds") %>% select(c("gid","year","TOC.fit")) %>% setNames(c("gid","decade","TOC")) %>% filter(gid %in% rivers.obs$gid)
wr.exp$model <- "fit"

match.exp <- rbind(rivers.obs, wr.exp) 
  
for(i in many.gid){
g <- ggplot(filter(match.exp, gid == i))+
  geom_point(aes(x = decade, y = TOC, col = model), size = 1)+
  geom_line(aes(x = decade, y = TOC, group = model,col=model), lty = 1)+
  labs(x = "", y = "TOC, mg/L", col = "Model", title = i)+
  scale_color_manual(values = c("firebrick","mediumaquamarine"))+
  ylim(0,20)+
  theme_minimal()+theme(legend.position = "bottom",axis.text.x = element_text(angle = 90))
h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid == i))+
  geom_sf(data = filter(merged.rivers, gid == i & nb > 20), aes(col = nb), size = 0.5)+
  borders(regions = "Sweden")+
  scale_color_stepsn(colours = c("cornsilk", "mediumaquamarine"), breaks = c(50, 100,200))+
  labs(color = "Nb of obs")+
  theme_void()+theme(legend.position = "bottom")
ggpubr::ggarrange(g,h, widths = c(2,1)) %>% print()
}

```

```{r selected-wr-cod, fig.dim = c(8,6)}
df <- match.exp %>% filter(gid %in% c("38747","169834","167089","270060","264568","284972"))

g <- ggplot()+
  geom_point(data = filter(df, model == "fit"), 
             aes(x = as.numeric(decade), y = TOC), 
             col = "firebrick", size = 1)+
  geom_line(data = filter(df, model == "fit"), 
            aes(x = as.numeric(decade), y = TOC, group = model), 
            col = "firebrick", lty = 1)+
  geom_point(data = filter(df, model == "obs"), 
                           aes(x = as.numeric(decade), y = TOC, col = as.factor(gid)), 
                           size = 1)+
  geom_line(data = filter(df, model == "obs"), 
            aes(x = as.numeric(decade), y = TOC, group = model,col=as.factor(gid)), 
            lty = 1)+
  labs(x = "", y = "TOC, mg/L", title = "")+ 
  scale_y_continuous(limits = c(0, 20), breaks = c(5, 10, 15))+
  scale_color_brewer(palette = "Dark2", direction = 1)+
  expand_limits(x = 2029)+
  facet_grid(rows = vars(factor(gid, levels = c("38747","169834","167089","264568","270060","284972"))))+
  theme_minimal()+theme(legend.position = "none")

h <- ggplot()+
  geom_sf(data = filter(wr.sf.wgs84, gid %in% df$gid), aes(fill = as.factor(gid)), alpha = 0.7)+
  scale_fill_brewer(palette = "Dark2", direction = 1)+
 # geom_sf_label_repel(data = filter(wr.sf.wgs84, gid %in% df$gid), 
  #                    aes(label = gid), fill = "white",
   #                   fun.geometry = sf::st_centroid,
    #                  nudge_x = 10)+
  borders(regions = "Sweden")+
  theme_void()+theme(legend.position = "none")

ggarrange(g,h, ncol = 2, width = c(3,1))
```




# Catchment data selected rivers

```{r catchment-data-on-selected-rivers, eval = F}
sf_use_s2(FALSE)
merged.rivers <- readRDS("merged.rivers.rds")
decade.toc <- readRDS("decade.toc.rds")
lakes.catchment <- read_sf("Catchment_poly/catchment.poly.shp")

rivers.catchment <- st_join(decade.toc, lakes.catchment, st_within)
sel.rivers <- rivers.catchment %>% filter(Name %in% c("Tornealven","Klaralven", "Narkes Svarta","Tidan", "Motala Strom"))

ggplot()+geom_sf(data = filter(lakes.catchment, ebint %in% sel.rivers$ebint),aes(fill=as.factor(ebint)), alpha = 0.5)+
  geom_sf(data=sel.rivers)+
  scale_fill_viridis_d()+theme_void()

swe.catchment <- read_sf("VM_Avrinningsomraden/SW_DARO_2016_1.shp") %>% st_transform(crs = crs(merged.rivers))
#sel.rivers.swe <- st_join(decade.toc, swe.catchment, st_within) %>% filter(Name %in% c("Tornealven","Klaralven", "Narkes Svarta","Tidan", "Motala Strom"))
#saveRDS(sel.rivers.swe, "sel.rivers.swe.rds")
sel.rivers.swe <- readRDS("sel.rivers.swe.rds")

ggplot()+
  geom_sf(data = filter(swe.catchment, VDRID %in% sel.rivers.swe$VDRID), fill = "gray90", col = "gray80")+
  geom_sf(data = filter(swe.catchment, DAROID %in% sel.rivers.swe$DAROID), aes(fill = DAROID, col = DAROID))+
  # geom_sf(data = filter(swe.catchment, MS_CD %in% sel.rivers.swe$MS_CD), fill = "dodgerblue", col = "dodgerblue", alpha = 0.5)+
  geom_sf(data=sel.rivers)+
  ylim(58,62)+xlim(13,17)+
  scale_fill_viridis_d(aesthetics = c("color","fill"))+theme_void()

ggplot()+
  geom_sf(data = filter(swe.catchment, VDRID %in% sel.rivers.swe$VDRID), aes(fill = VDRID, col = VDRID))+
  geom_sf(data=sel.rivers)+
   geom_sf_text(data=sel.rivers, aes(label = Name))+
  ylim(58,62)+xlim(13,17)+
  scale_fill_viridis_d(aesthetics = c("color","fill"))+theme_void()


sel.swe.catch <- dplyr::filter(swe.catchment, VDRID %in% sel.rivers.swe$VDRID) %>% dplyr::select(c("VDRID","geometry","AREAL"))
saveRDS(sel.swe.catch, "sel.swe.catch.rds")
```

```{r hilda-swe, eval = F}

hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 11) 
sel.swe.catch <- readRDS("sel.swe.catch.rds")

# hilda.raster.sf <- hilda.raster %>% as("SpatialPointsDataFrame") %>% st_as_sf()
# st_crs(sel.swe.catch) <- crs(hilda.raster)
# hilda.within <- st_join(hilda.raster.sf,sel.swe.catch,left = F)
# 
# ggplot()+geom_sf(data = hilda.within, aes(col = as.factor(State)))+geom_sf(data=sel.swe.catch, alpha = 0.5)+
#   ylim(58,61)+theme_void()

hilda.1999 <- raster::extract(hilda.raster, sel.swe.catch)
saveRDS(hilda.1999,"hilda.sel.1999.rds")
hilda.tab <- sapply(hilda.1999, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/") 
names(hilda.tab.prop) <- sel.swe.catch$VDRID

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$VDRID <- sel.swe.catch$VDRID
forest.sum <- forest %>% group_by(VDRID) %>% summarise(forest = mean(forest, na.rm=T)) %>% as.data.frame()
saveRDS(forest.sum,"sel.swe.forest.1999.rds")

schrubland <- hilda.tab.prop[55,] %>% as.data.frame() %>% setNames("schrubland")
schrubland$VDRID <- sel.swe.catch$VDRID
schrubland.sum <- schrubland %>% group_by(VDRID) %>% summarise(scrubland = mean(schrubland, na.rm=T)) %>% as.data.frame()
saveRDS(schrubland.sum, "sel.swe.schrubland.1999.rds")

cropland <- hilda.tab.prop[22,] %>% as.data.frame() %>% setNames("cropland")
cropland$VDRID <- sel.swe.catch$VDRID
cropland.sum <- cropland %>% group_by(VDRID) %>% summarise(cropland = mean(cropland, na.rm=T)) %>% as.data.frame()
saveRDS(cropland.sum, "sel.swe.cropland.1999.rds")
```

```{r runoff.swe, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_199001-199912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_200001-200912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1999 <- raster::extract(runoff.mean, sel.swe.catch, fun = mean, df = T, sp = T, na.rm = T)

sel.swe.runoff.1999 <- runoff.1999@data
names(sel.swe.runoff.1999) <- c("VDRID","runoff")
sel.swe.runoff.1999.sum <- sel.swe.runoff.1999 %>% group_by(VDRID) %>% summarise(runoff = mean(runoff, na.rm=T)) %>% as.data.frame()
saveRDS(sel.swe.runoff.1999.sum,"sel.swe.runoff.1999.rds")
```

```{r sdep-swe, eval = F}
sel.swe.catch <- readRDS("sel.swe.catch.rds")

wsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.1994met_1994emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1995met_1995emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1996met_1996emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1997met_1997emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1998met_1998emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1999met_1999emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2000met_2000emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2001met_2001emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2002met_2002emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2003met_2003emis_rep2022.nc", varname = "WDEP_SOX")) %>% mean()

wsdep.1999 <- extract(wsdep.stack, sel.swe.catch, sp = T, df = T, na.rm = T, fun = mean)
names(wsdep.1999) <- c("VDRID","area","wsdep")
wsdep.sum <- wsdep.1999 %>% as.data.frame() %>% group_by(VDRID) %>% summarize(wsdep = mean(wsdep, na.rm = T))
saveRDS(wsdep.sum, "sel.swe.wsdep.1999.rds")

dsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.1994met_1994emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1995met_1995emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1996met_1996emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1997met_1997emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1998met_1998emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1999met_1999emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2000met_2000emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2001met_2001emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2002met_2002emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2003met_2003emis_rep2022.nc", varname = "DDEP_SOX_m2Grid")) %>% mean() 

dsdep.1999 <- extract(dsdep.stack, sel.swe.catch, sp = T, df = T, na.rm = T, fun = mean)
names(dsdep.1999) <- c("VDRID","area","dsdep")
dsdep.sum <- dsdep.1999 %>% as.data.frame() %>% group_by(VDRID) %>% summarize(dsdep = mean(dsdep, na.rm = T))
saveRDS(dsdep.sum, "sel.swe.dsdep.1999.rds")

sdep.1999 <- merge(wsdep.sum, dsdep.sum, by = "VDRID")
sdep.1999$tsdep <- sdep.1999$wsdep + sdep.1999$dsdep
saveRDS(sdep.1999,"sel.swe.sdep.1999.rds")
```

```{r merge-swe, results = T}
forest <- readRDS("sel.swe.forest.1999.rds")
schrubland <- readRDS("sel.swe.schrubland.1999.rds")
cropland <- readRDS("sel.swe.cropland.1999.rds")
sdep.df <- readRDS("sel.swe.sdep.1999.rds") 
runoff.1999 <- readRDS("sel.swe.runoff.1999.rds") 
sel.rivers.swe <- readRDS("sel.rivers.swe.rds")
sel.swe.catch  <- readRDS("sel.swe.catch.rds")

tot.swe <- merge(forest, schrubland, by = "VDRID")%>% merge(cropland, by = "VDRID") %>% 
  merge(runoff.1999, by = "VDRID") %>% 
  merge(sdep.df, by = "VDRID") 

tot.swe$Runoff <- tot.swe$runoff * 365 * 24 * 60 * 60 

runoff.1999$Runoff <- runoff.1999$runoff * 365 * 24 * 60 * 60 

area <- sel.swe.catch %>% group_by(VDRID) %>% summarise(area = sum(AREAL))

knitr::kable(tot.swe, digits = 4) %>% kable_styling(bootstrap_options = "bordered")
knitr::kable(area) %>% kable_styling(bootstrap_options = "bordered")
```

```{r wr-swe, results = T}
wr.sf.1999 <- readRDS("wr.sf.1999.lmcrop.rds")

swe.wr.1999 <- filter(wr.sf.1999, gid %in% c(38747,167089,220758,264568))

wr.sdep.1999 <- readRDS("sdep.1999.rds") %>% as.data.frame() %>% filter(gid %in% c(38747,167089,220758,264568))

# gid corresponding to 1) Tornehalven, 2) Klarälven and Tidan, 3) Narkes Svartå and 4) Motala Ström
# corresponding VDRID: 1) 732679-188094 2) 640285-126701 and 651150-138479, 3) 658088-162908, 4) 649943-152567

knitr::kable(select(swe.wr.1999,c("gid","forest","cropland","schrubland","Runoff","area"))) %>% kable_styling(bootstrap_options = "bordered")
knitr::kable(wr.sdep.1999) %>% kable_styling(bootstrap_options = "bordered")
```
`r knitr::knit_exit()`


# Extra

# LM logTOC \~ forest + cropland + shrubland + logRunoff + logTSdep + longitude + latitude

```{r glm-longlat, eval = T}
fen <- readRDS("fen.rds")

lm.log <- lm(logTOC ~ forest + cropland + schrubland + logRunoff + logTSdep + longitude + latitude, data = fen)
print(summary(lm.log))

plot(x = lm.log$fitted.values, y = fen$logTOC)
abline(b = 1, a = 0, lty = 2)
plot(x = lm.log$fitted.values,y = lm.log$residuals)
hist(lm.log$residuals)

qplot(x = fen$longitude, y = fen$latitude, col = (10^lm.log$fitted.values))+geom_point()+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC, mg")+
  theme_void()

saveRDS(lm.log,"lm.longlat.rds")

```

## Prediction by decade

```{r load-lm-model-longlat}
toc_model <- readRDS("lm.longlat.rds")
```

```{r predict-1899-lmlonglat, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1899.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1899.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.lmlonglat.rds")
```

```{r predict-1909-lmlonglat, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1909.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1909.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.lmlonglat.rds")
```

```{r predict-1919-lmlonglat, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1919.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1919.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.lmlonglat.rds")
```

```{r predict-1929-lmlonglat, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1929.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1929.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.lmlonglat.rds")
```

```{r predict-1939-lmlonglat, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1939.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1939.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.lmlonglat.rds")
```

```{r predict-1949-lmlonglat, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1949.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1949.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.lmlonglat.rds")
```

```{r predict-1959-lmlonglat, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1959.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1959.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.lmlonglat.rds")
```

```{r predict-1969-lmlonglat, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1969.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1969.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.lmlonglat.rds")
```

```{r predict-1979-lmlonglat, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1979.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1979.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.lmlonglat.rds")
```

```{r predict-1989-lmlonglat, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1989.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1989.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.lmlonglat.rds")
```

```{r predict-1999-lmlonglat, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1999.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1999.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.lmlonglat.rds")
```

```{r predict-1999-lmlonglat-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.1999.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.1999.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.lmlonglat.emep.rds")
```

```{r predict-2009-lmlonglat-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.2009.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.2009.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009)
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.lmlonglat.rds")
```

```{r predict-2019-lmlonglat-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))
cropland <- readRDS("cropland.2019.rds") %>% filter(!is.na(cropland))
schrubland <- readRDS("schrubland.2019.rds") %>% filter(!is.na(schrubland))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(cropland, by = "gid") %>% merge(schrubland, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019)
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.lmlonglat.rds")
```

## Compare exports

```{r common-lmlonglat, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.lmlonglat.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.lmlonglat.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.lmlonglat.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.lmlonglat.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

wr.basins <- readRDS("wr.basins.rds")

wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.lmlonglat.rds")
saveRDS(wr.exp, "wr.exp.lmlonglat.rds")
```

```{r plot-exp-lmlonglat}
wr.exp <- readRDS("wr.exp.lmlonglat.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, "LM logTOC ~ forest + cropland + shrubland + logRunoff + logTSdep + longitude + latitude")
```

## Comparison with historical data

```{r compare-swedish-lmlonglat}

merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.lmlonglat.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","TOC.decade","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, "LM logTOC ~ forest + cropland + shrubland + logRunoff + logTSdep + latitude + longitude")

```

# LM logTOC \~ longitude + latitude

```{r glm-space, eval = T}
fen <- readRDS("fen.rds")

lm.log <- lm(logTOC ~ latitude, data = fen)
print(summary(lm.log))

plot(x = lm.log$fitted.values, y = fen$logTOC)
abline(b = 1, a = 0, lty = 2)
plot(x = lm.log$fitted.values,y = lm.log$residuals)
hist(lm.log$residuals)

qplot(x = fen$longitude, y = fen$latitude, col = (10^lm.log$fitted.values))+geom_point()+
  scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC, mg")+
  theme_void()

saveRDS(lm.log,"lm.space.rds")

```

# Maps

```{r map-toc-1899, eval = F}
wr.sf.1899 <- readRDS("wr.sf.1899")

map.toc.1899 <- ggplot(wr.sf.1899)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1899", fill = "TOC concentration\nin mg/L in 1899")+
  theme_void()

ggsave("map.toc.1899.png", map.toc.1899)
```

```{r map-toc-1909, eval = F}
wr.sf.1909 <- readRDS("wr.sf.1909")

map.toc.1909 <- ggplot(wr.sf.1909)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1909", fill = "TOC concentration\nin mg/L in 1909")+
  theme_void()

ggsave("map.toc.1909.png", map.toc.1909)
```

```{r map-toc-1919, eval = F}
wr.sf.1919 <- readRDS("wr.sf.1919")

map.toc.1919 <- ggplot(wr.sf.1919)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1919", fill = "TOC concentration\nin mg/L in 1919")+
  theme_void()

ggsave("map.toc.1919.png", map.toc.1919)
```

```{r map-toc-1929, eval = F}
wr.sf.1929 <- readRDS("wr.sf.1929")

map.toc.1929 <- ggplot(wr.sf.1929)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1929", fill = "TOC concentration\nin mg/L in 1929")+
  theme_void()

ggsave("map.toc.1929.png", map.toc.1929)
```

```{r map-toc-1939, eval = F}
wr.sf.1939 <- readRDS("wr.sf.1939")

map.toc.1939 <- ggplot(wr.sf.1939)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1939", fill = "TOC concentration\nin mg/L in 1939")+
  theme_void()

ggsave("map.toc.1939.png", map.toc.1939)
```

```{r map-toc-1949, eval = F}
wr.sf.1949 <- readRDS("wr.sf.1949")

map.toc.1949 <- ggplot(wr.sf.1949)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1949", fill = "TOC concentration\nin mg/L in 1949")+
  theme_void()

ggsave("map.toc.1949.png", map.toc.1949)
```

```{r map-toc-1959, eval = F}
wr.sf.1959 <- readRDS("wr.sf.1959")

map.toc.1959 <- ggplot(wr.sf.1959)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1959", fill = "TOC concentration\nin mg/L in 1959")+
  theme_void()

ggsave("map.toc.1959.png", map.toc.1959)
```

```{r map-toc-1969, eval = F}
wr.sf.1969 <- readRDS("wr.sf.1969")

map.toc.1969 <- ggplot(wr.sf.1969)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1969", fill = "TOC concentration\nin mg/L in 1969")+
  theme_void()

ggsave("map.toc.1969.png", map.toc.1969)
```

```{r map-toc-1979, eval = F}
wr.sf.1979 <- readRDS("wr.sf.1979")

map.toc.1979 <- ggplot(wr.sf.1979)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1979", fill = "TOC concentration\nin mg/L in 1979")+
  theme_void()

ggsave("map.toc.1979.png", map.toc.1979)
```

```{r map-toc-1989, eval = F}
wr.sf.1989 <- readRDS("wr.sf.1989")

map.toc.1989 <- ggplot(wr.sf.1989)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1989", fill = "TOC concentration\nin mg/L in 1989")+
  theme_void()

ggsave("map.toc.1989.png", map.toc.1989)
```

```{r map-toc-1999, eval = F}
wr.sf.1999 <- readRDS("wr.sf.1999")

map.toc.1999 <- ggplot(wr.sf.1999)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1999", fill = "TOC concentration\nin mg/L in 1999")+
  theme_void()

ggsave("map.toc.1999.png", map.toc.1999)
```

```{r map-toc-2009, eval = F}
wr.sf.2009 <- readRDS("wr.sf.2009")

map.toc.2009 <- ggplot(wr.sf.2009)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1999", fill = "TOC concentration\nin mg/L in 1999")+
  theme_void()

ggsave("map.toc.2009.png", map.toc.2009)
```

```{r map-toc-2019, eval = F}
wr.sf.2019 <- readRDS("wr.sf.2019")

map.toc.2019 <- ggplot(wr.sf.2019)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1999", fill = "TOC concentration\nin mg/L in 1999")+
  theme_void()

ggsave("map.toc.2019.png", map.toc.2019)
```
