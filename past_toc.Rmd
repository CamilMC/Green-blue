---
title: "past_data"
date: "2023-04-21"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center", collapse = T)
options(knitr.kable.NA="", knitr.table.format = "html")
```

```{r libraries}
library(raster)
library(sf)
library(dplyr)
library(ggplot2)
library(colorspace)
library(directlabels)


library(spdep)
library(spatialreg)
```

# Extract past data

```{r wr}
wr.sf <- readRDS("wr.sf.rds")
```

```{r explore-wr}
wr.sf.wgs84 <- st_transform(wr.sf, st_crs(4326))

ggplot(slice_sample(wr.sf.wgs84, n = 50, weight_by = area))+
  borders(regions = c("Norway", "Sweden","Finland"))+
  geom_sf_label(aes(label = gid), size = 2, fill = "white", col = "red", check_overlap = T)+
  xlim(0,35)+ylim(53,73)+theme_void()

```

Selected wr:

-   Oslo fjord: 24085
-   West Norway: 157966
-   North Norway: 29877
-   South Sweden: 28116
-   Est Sweden: 261558
-   Central Sweden: 98655
-   Northern Sweden: 38747
-   South Finland: 127449
-   East Finland: 73788
-   North Finland: 16728

## HILDA

HILDA data are downloaded from <https://www.wur.nl/en/research-results/chair-groups/environmental-sciences/laboratory-of-geo-information-science-and-remote-sensing/models/hilda/hilda-data-downloads.html>

Hilda categories:

-   77: Water
-   66: Other land
-   55: Grass/schrubland
-   45: Forest, mixed
-   44: Forest, deciduous broad leaf
-   43: Forest: deciduous needle
-   42: Forest, evergreen borad leaf
-   41: Forest, evergreen needle
-   40: Forest, other
-   33: Pasture
-   22: Cropland
-   11: Urban

```{r extract-data-hilda-1899, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 1)

hilda.1899 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1899, "hilda.1899.wr.rds")

hilda.1899 <- readRDS("hilda.1899.wr.rds")
hilda.tab <- sapply(hilda.1899, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1899.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1899.rds")
```

```{r extract-data-hilda-1909, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 2)

hilda.1909 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1909, "hilda.1909.wr.rds")

hilda.1909 <- readRDS("hilda.1909.wr.rds")
hilda.tab <- sapply(hilda.1909, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1909.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1909.rds")
```

```{r extract-data-hilda-1919, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 3)

hilda.1919 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1919, "hilda.1919.wr.rds")

hilda.1919 <- readRDS("hilda.1919.wr.rds")
hilda.tab <- sapply(hilda.1919, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
saveRDS(hilda.tab.prop,"hilda.1919.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1919.rds")
```

```{r extract-data-hilda-1929, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 4)

hilda.1929 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1929, "hilda.1929.wr.rds")

hilda.1929 <- readRDS("hilda.1929.wr.rds")
hilda.tab <- sapply(hilda.1929, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
saveRDS(hilda.tab.prop,"hilda.1929.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid

saveRDS(forest,"forest.1929.rds")
```

```{r extract-data-hilda-1939, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 5)

hilda.1939 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1939, "hilda.1939.wr.rds")

hilda.1939 <- readRDS("hilda.1939.wr.rds")
hilda.tab <- sapply(hilda.1939, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
saveRDS(hilda.tab.prop,"hilda.1939.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1939.rds")
```

```{r extract-data-hilda-1949, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 6)

hilda.1949 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1949, "hilda.1949.wr.rds")

hilda.1949 <- readRDS("hilda.1949.wr.rds")
hilda.tab <- sapply(hilda.1949, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1949.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1949.rds")
```

```{r extract-data-hilda-1959, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 7)

hilda.1959 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1959, "hilda.1959.wr.rds")

hilda.1959 <- readRDS("hilda.1959.wr.rds")
hilda.tab <- sapply(hilda.1959, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1959.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1959.rds")
```

```{r extract-data-hilda-1969, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 8)

hilda.1969 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1969, "hilda.1969.wr.rds")

hilda.1969 <- readRDS("hilda.1969.wr.rds")
hilda.tab <- sapply(hilda.1969, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1969.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid

saveRDS(forest,"forest.1969.rds")
```

```{r extract-data-hilda-1979, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 9)

hilda.1979 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1979, "hilda.1979.wr.rds")

hilda.1979 <- readRDS("hilda.1979.wr.rds")
hilda.tab <- sapply(hilda.1979, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1979.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1979.rds")
```

```{r extract-data-hilda-1989, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 10)

hilda.1989 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1989, "hilda.1989.wr.rds")


hilda.1989 <- readRDS("hilda.1989.wr.rds")
hilda.tab <- sapply(hilda.1989, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1989.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1989.rds")
```

```{r extract-data-hilda-1999, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 11)

hilda.1999 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1999, "hilda.1999.wr.rds")

hilda.1999 <- readRDS("hilda.1999.wr.rds")
hilda.tab <- sapply(hilda.1999, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1999.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1999.rds")
```

```{r extract-data-hilda-2009, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 12)

hilda.2009 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.2009, "hilda.2009.wr.rds")

hilda.2009 <- readRDS("hilda.2009.wr.rds")
hilda.tab <- sapply(hilda.2009, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.2009.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid

saveRDS(forest,"forest.2009.rds")
```

```{r extract-data-hilda-2019, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 13)

hilda.2019 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.2019, "hilda.2019.wr.rds")

hilda.2019 <- readRDS("hilda.2019.wr.rds")
hilda.tab <- sapply(hilda.2019, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.2019.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.2019.rds")
```


 Bogs extracted from Corine Land Cover 2006
 
```{r compare-with-bogs}
wr.bogs <- readRDS("bogs.wr.rds")

forest.1899 <- wr.sf.wgs84 %>% merge(readRDS("forest.1899.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1899, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1899", subtitle = paste(round(sum(subset(forest.1899, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1909 <- wr.sf.wgs84 %>% merge(readRDS("forest.1909.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1909, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1909", subtitle = paste(round(sum(subset(forest.1909, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1919 <- wr.sf.wgs84 %>% merge(readRDS("forest.1919.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1919, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
   ylim(55,72)+xlim(4,33)+
  labs(title = "1919", subtitle = paste(round(sum(subset(forest.1919, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1929 <- wr.sf.wgs84 %>% merge(readRDS("forest.1929.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1929, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1929", subtitle = paste(round(sum(subset(forest.1929, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1939 <- wr.sf.wgs84 %>% merge(readRDS("forest.1939.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1939, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
    ylim(55,72)+xlim(4,33)+
  labs(title = "1939", subtitle = paste(round(sum(subset(forest.1939, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1949 <- wr.sf.wgs84 %>% merge(readRDS("forest.1949.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1949, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1949", subtitle = paste(round(sum(subset(forest.1949, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1959 <- wr.sf.wgs84 %>% merge(readRDS("forest.1959.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1959, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1959", subtitle = paste(round(sum(subset(forest.1959, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1969 <- wr.sf.wgs84 %>% merge(readRDS("forest.1969.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1969, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1969", subtitle = paste(round(sum(subset(forest.1969, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1979 <- wr.sf.wgs84 %>% merge(readRDS("forest.1979.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1979, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1979", subtitle = paste(round(sum(subset(forest.1979, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1989 <- wr.sf.wgs84 %>% merge(readRDS("forest.1989.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1989, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1989", subtitle = paste(round(sum(subset(forest.1989, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1999 <- wr.sf.wgs84 %>% merge(readRDS("forest.1999.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1999, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1999", subtitle = paste(round(sum(subset(forest.1999, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.2009 <- wr.sf.wgs84 %>% merge(readRDS("forest.2009.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.2009, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "2009", subtitle = paste(round(sum(subset(forest.2009, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.2019 <- wr.sf.wgs84 %>% merge(readRDS("forest.2019.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.2019, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "2019", subtitle = paste(round(sum(subset(forest.2019, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

```


## Sdep

Annual mean deposition in kg/m2/s, averaged in the water drainage basins polygons. 10 years average.

```{r load-wr-s, eval = F}
wr.sf <- readRDS("wr.sf.rds")
```

```{r extract-sulfur-1899, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(409:660)) %>% mean() # mean 1894-1904
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(409:660)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(409:660)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(409:660)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1899.rds")
```

```{r extract-sulfur-1909, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(661:780)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(661:780)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(661:780)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(661:780)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1909.rds")
```

```{r extract-sulfur-1919, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(781:900)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(781:900)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(781:900)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(781:900)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1919.rds")
```

```{r extract-sulfur-1929, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(901:1020)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(901:1020)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(901:1020)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(901:1020)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1929.rds")
```

```{r extract-sulfur-1939, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1021:1140)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1021:1140)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1021:1140)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1021:1140)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1939.rds")
```

```{r extract-sulfur-1949, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1041:1260)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1041:1260)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1041:1260)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1041:1260)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1949.rds")
```

```{r extract-sulfur-1959, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1261:1380)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1261:1380)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1261:1380)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1261:1380)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1959.rds")
```

```{r extract-sulfur-1969, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1381:1500)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1381:1500)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1381:1500)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1381:1500)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1969.rds")
```

```{r extract-sulfur-1979, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1501:1620))
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1501:1620)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1501:1620)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1501:1620)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1979.rds")
```

```{r extract-sulfur-1989, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1621:1740)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1621:1740)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1621:1740)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1621:1740)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1989.rds")
```

```{r extract-sulfur-1999, eval = F}
dryso2 <- raster("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1741:1860))
dryso4 <- raster("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1741:1860))
wetso2 <- raster("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1741:1860))
wetso4 <- raster("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1741:1860))

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1999.rds")
```

Does not exist for 2009. EMEP? In mg/m2 a priori

```{r sdep-1995, eval = F}

wsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.1990met_1990emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1991met_1991emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1992met_1992emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1993met_1993emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1994met_1994emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1995met_1995emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1996met_1996emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1997met_1997emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1998met_1998emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1999met_1999emis_rep2022.nc", varname = "WDEP_SOX")) %>% mean()

wsdep.1995 <- extract(wsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wsdep.1995) <- c("gid","area","wsdep")
saveRDS(wsdep.1995, "wsdep.1995.rds")

dsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.1990met_1990emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1991met_1991emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1992met_1992emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1993met_1993emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1994met_1994emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1995met_1995emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1996met_1996emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1997met_1997emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1998met_1998emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1999met_1999emis_rep2022.nc", varname = "DDEP_SOX_m2Grid")) %>% mean() 

dsdep.1995 <- extract(dsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dsdep.1995) <- c("gid","area","dsdep")
saveRDS(dsdep.1995, "dsdep.1995.rds")

sdep.1995 <- merge(wsdep.1995, dsdep.1995, by = "gid")
sdep.1995$tsdep <- sdep.1995$wsdep + sdep.1995$dsdep
saveRDS(sdep.1995, "sdep.1995.rds")
```

```{r sdep-1999, eval = F}

wsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.1994met_1994emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1995met_1995emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1996met_1996emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1997met_1997emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1998met_1998emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1999met_1999emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2000met_2000emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2001met_2001emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2002met_2002emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2003met_2003emis_rep2022.nc", varname = "WDEP_SOX")) %>% mean()

wsdep.1999 <- extract(wsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wsdep.1999) <- c("gid","area","wsdep")
saveRDS(wsdep.1999, "wsdep.1999.rds")

dsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.1994met_1994emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1995met_1995emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1996met_1996emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1997met_1997emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1998met_1998emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1999met_1999emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2000met_2000emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2001met_2001emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2002met_2002emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2003met_2003emis_rep2022.nc", varname = "DDEP_SOX_m2Grid")) %>% mean() 

dsdep.1999 <- extract(dsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dsdep.1999) <- c("gid","area","dsdep")
saveRDS(dsdep.1999, "dsdep.1999.rds")

sdep.1999 <- merge(wsdep.1999, dsdep.1999, by = "gid")
sdep.1999$tsdep <- sdep.1999$wsdep + sdep.1999$dsdep
saveRDS(sdep.1999,"sdep.1999.rds")
```

```{r sdep-2009, eval = F}

wsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.2004met_2004emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2005met_2005emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2006met_2006emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2007met_2007emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2008met_2008emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2009met_2009emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2010met_2010emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2011met_2011emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2012met_2012emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2013met_2013emis_rep2022.nc", varname = "WDEP_SOX")) %>% mean()

wsdep.2009 <- extract(wsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wsdep.2009) <- c("gid","area","wsdep")
saveRDS(wsdep.2009, "wsdep.2009.rds")

dsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.2004met_2004emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2005met_2005emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2006met_2006emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2007met_2007emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2008met_2008emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2009met_2009emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2010met_2010emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2011met_2011emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2012met_2012emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2013met_2013emis_rep2022.nc", varname = "DDEP_SOX_m2Grid")) %>% mean() 

dsdep.2009 <- extract(dsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dsdep.2009) <- c("gid","area","dsdep")
saveRDS(dsdep.2009, "dsdep.2009.rds")

sdep.2009 <- merge(wsdep.2009, dsdep.2009, by = "gid")
sdep.2009$tsdep <- sdep.2009$wsdep + sdep.2009$dsdep
saveRDS(sdep.2009, "sdep.2009.rds")
```

```{r sdep-2019}

wsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.2014met_2014emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2015met_2015emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2016met_2016emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2017met_2017emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2018met_2018emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2019met_2019emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2020met_2020emis.nc", varname = "WDEP_SOX")) %>% mean()

wsdep.2019 <- extract(wsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wsdep.2019) <- c("gid","area","wsdep")
saveRDS(wsdep.2019, "wsdep.2019.rds")

dsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.2014met_2014emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2015met_2015emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2016met_2016emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2017met_2017emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2018met_2018emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2019met_2019emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2020met_2020emis.nc", varname = "DDEP_SOX_m2Grid")) %>% mean() 

dsdep.2019 <- extract(dsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dsdep.2019) <- c("gid","area","dsdep")
saveRDS(dsdep.2019, "dsdep.2019.rds")

sdep.2019 <- merge(wsdep.2019, dsdep.2019, by = "gid")
sdep.2019$tsdep <- sdep.2019$wsdep + sdep.2019$dsdep
saveRDS(sdep.2019, "sdep.2019.rds")
```



## Runoff

CMIP6 information: https://pcmdi.llnl.gov/CMIP6/

https://wcrp-cmip.github.io/CMIP6_CVs/docs/CMIP6_source_id_experiment_citation.html

Information on AMIP: https://www.wdc-climate.de/ui/cmip6?input=CMIP6.CMIP.CNRM-CERFACS.CNRM-CM6-1.amip
Historical experiment: https://www.wdc-climate.de/ui/cmip6?input=CMIP6.CMIP.CNRM-CERFACS.CNRM-CM6-1.historical


10 years average

```{r load-wr, eval = F}
wr.sf <- readRDS("wr.sf.rds")
```

```{r runoff-1899, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(409:660))
runoff.mean <- runoff.stack %>% mean() 

runoff.1899 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1899) <- c("gid","area","runoff")
saveRDS(runoff.1899,"runoff.1899.rds")
```

```{r runoff-1909, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(661:780))
runoff.mean <- runoff.stack %>% mean() 

runoff.1909 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)



names(runoff.1909) <- c("gid","area","runoff")
saveRDS(runoff.1909,"runoff.1909.rds")
```

```{r runoff-1919, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(781:900)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1919 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1919) <- c("gid","area","runoff")
saveRDS(runoff.1919,"runoff.1919.rds")
```

```{r runoff-1929, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(901:1020)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1929 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1929) <- c("gid","area","runoff")
saveRDS(runoff.1929,"runoff.1929.rds")
```

```{r runoff-1939, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1021:1140)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1939 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1939) <- c("gid","area","runoff")
saveRDS(runoff.1939,"runoff.1939.rds")
```

```{r runoff-1949, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1041:1260)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1949 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)



names(runoff.1949) <- c("gid","area","runoff")
saveRDS(runoff.1949,"runoff.1949.rds")
```

```{r runoff-1959, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1261:1380))
runoff.mean <- runoff.stack %>% mean() 

runoff.1959 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1959) <- c("gid","area","runoff")
saveRDS(runoff.1959,"runoff.1959.rds")
```

```{r runoff-1969, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1381:1500)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1969 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1969) <- c("gid","area","runoff")
saveRDS(runoff.1969,"runoff.1969.rds")
```

```{r runoff-1979, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1501:1620)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1979 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1979) <- c("gid","area","runoff")
saveRDS(runoff.1979,"runoff.1979.rds")
```

```{r runoff-1989, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1621:1740)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1989 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1989) <- c("gid","area","runoff")
saveRDS(runoff.1989,"runoff.1989.rds")
```

```{r runoff-1999, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1741:1860)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1999 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1999) <- c("gid","area","runoff")
saveRDS(runoff.1999,"runoff.1999.rds")
```

The historical models in CMIP6 stops in 2014. Surface runoff is available for future projections. We used the projection for SSP245, taking into account the emissions during the COVID years. 

```{r runoff-2009, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1849:1980)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.2009 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.2009) <- c("gid","area","runoff")
saveRDS(runoff.2009,"runoff.2009.rds")
```

```{r runoff-2019, eval = F}
runoff.raster1 <- "mrros_Lmon_NorESM2-LM_ssp245-covid_r1i1p1f2_gn_201502-202012.nc"
runoff.raster2 <- "mrros_Lmon_NorESM2-LM_ssp245-covid_r1i1p1f2_gn_202101-203012.nc"

runoff.stack1 <- raster::stack(runoff.raster1, bands = c(1:71)) # all layers from 2015 to 2020
runoff.stack2 <- raster::stack(runoff.raster2, bands = c(1:48)) # layers from 2021 to 2024
runoff.mean <-  raster::stack(runoff.stack1, runoff.stack2) %>% mean() 

runoff.2019 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

runoff.2019 <- readRDS("runoff.2019.rds")
names(runoff.2019) <- c("gid","area","runoff")
saveRDS(runoff.2019,"runoff.2019.rds")
```


# Prepare WR and basins

```{r transform-wr}
wr.sf <- readRDS("wr.sf.rds")

sf_use_s2(FALSE)
wr.centroid <- st_centroid(wr.sf) %>% st_transform(st_crs(4326))
wr.sf$latitude <- st_coordinates(wr.centroid)[,2]

lims <- c(0,20)
```

```{r create-import basins}
basins <- st_read("basins_all_sea.shp") %>% st_cast("POLYGON")
st_crs(basins) <- st_crs(4326)
basins$sea <- with(basins, ifelse(Poly %in% c(1:161), "Baltic",
                                  ifelse(Poly %in% c(162:253), "North",
                                    "NCC")))
wr.basins <- st_join(wr.centroid, basins, st_join = st_within)

ggplot()+ geom_sf(data = basins, aes(col = sea), fill = NA)+geom_sf(data = wr.basins, aes(col = sea, size = area))

# wr.sf.mercator <- st_transform(wr.sf, st_crs(4326))
# ggplot() + geom_sf(data = head(wr.sf.mercator,100), col = "black")
# wr.coords <- st_coordinates(wr.sf.mercator)
# 
# sf_use_s2(FALSE)
# test <- st_join(st_centroid(wr.sf.mercator, of), basins, join = st_within)
# ggplot()+geom_sf(data = test, aes(fill = sea, color = sea, size = area), na.value = "black")+
#   geom_sf(data = basins, aes(col = sea), fill = NA)+
#   ylim(55,71)
# 
# test2 <- merge(wr.sf.mercator, st_drop_geometry(test), by = c("gid","area"))
# ggplot()+geom_sf(data = test2, aes(fill = sea, color = sea), na.value = "black")+
#   geom_sf(data = basins, aes(col = sea), fill = NA)+
#   ylim(55,71)
```



# Predict TOC, SELM forest + runoff + logTSdep*latitude

## Predict by decade

```{r load-model}
toc_model <- readRDS("sem.fen.log.lat.rds")
```

```{r wr.kmat, eval = F}
wr.spdf <- SpatialPointsDataFrame(st_coordinates(st_centroid(wr.sf)), st_drop_geometry(wr.sf))
wr.kmat <- knearneigh(wr.spdf, k = 100) %>% knn2nb() %>% nb2listw()
saveRDS(wr.kmat, "wr.kmat.rds")
```

```{r predict-1899, eval = T}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff %>% log10()
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)
wr.sf.1899$TSdep_emep <- NA

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899, wr.kmat)[,1]
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.rds")
```

```{r predict-1909, eval = T}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds")  %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60
wr.sf.1909$logRunoff <- wr.sf.1909$Runoff %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)
wr.sf.1909$TSdep_emep <- NA

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909, wr.kmat)[,1]
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.rds")
```

```{r predict-1919, eval = T}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60
wr.sf.1919$logRunoff <- wr.sf.1919$Runoff %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)
wr.sf.1919$TSdep_emep <- NA

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919, wr.kmat)[,1]
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.rds")
```

```{r predict-1929, eval = T}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60
wr.sf.1929$logRunoff <- wr.sf.1929$Runoff %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)
wr.sf.1929$TSdep_emep <- NA

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929, wr.kmat)[,1]
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.rds")
```

```{r predict-1939, eval = T}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60
wr.sf.1939$logRunoff <- wr.sf.1939$Runoff %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)
wr.sf.1939$TSdep_emep <- NA

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939, wr.kmat)[,1]
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.rds")
```

```{r predict-1949, eval = T}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60
wr.sf.1949$logRunoff <- wr.sf.1949$Runoff %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)
wr.sf.1949$TSdep_emep <- NA

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949, wr.kmat)[,1]
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.rds")
```

```{r predict-1959, eval = T}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60
wr.sf.1959$logRunoff <- wr.sf.1959$Runoff %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)
wr.sf.1959$TSdep_emep <- NA

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959, wr.kmat)[,1]
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.rds")
```

```{r predict-1969, eval = T}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- wr.sf.1969$Runoff %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)
wr.sf.1969$TSdep_emep <- NA

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969, wr.kmat)[,1]
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.rds")
```

```{r predict-1979, eval = T}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60
wr.sf.1979$logRunoff <- wr.sf.1979$Runoff %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)
wr.sf.1979$TSdep_emep <- NA

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979, wr.kmat)[,1]
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.rds")
```

```{r predict-1989, eval = T}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60
wr.sf.1989$logRunoff <- wr.sf.1989$Runoff %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)
wr.sf.1989$TSdep_emep <- NA

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989, wr.kmat)[,1]
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.rds")
```

```{r predict-1999, eval = T}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- wr.sf.1999$Runoff %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)
wr.sf.1999$TSdep_emep <- NA

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999, wr.kmat)[,1]
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.rds")
```

For 2009 and 2019: Need to download data from EMEP and fit a model on NLS with EMEP data

```{r load-model-emep}
toc_model <- readRDS("sem.fen.emep.rds")
```

```{r predict-1999-emep, eval = T}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- wr.sf.1999$Runoff %>% log10()
wr.sf.1999$TSdep <- NA
wr.sf.1999$TSdep_emep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep_emep <- log10(wr.sf.1999$TSdep_emep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999, wr.kmat)[,1]
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999_emep.rds")
```

```{r predict-2009, eval = T}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- wr.sf.2009$Runoff %>% log10()
wr.sf.2009$TSdep <- NA
wr.sf.2009$TSdep_emep <- wr.sf.2009$tsdep # converts to mg/year
wr.sf.2009$logTSdep_emep <- log10(wr.sf.2009$TSdep_emep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009, wr.kmat)[,1]
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.rds")
```

```{r predict-2019, eval = T}
toc_model <- readRDS("sem.fen.emep.rds")

forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- wr.sf.2019$Runoff %>% log10()
wr.sf.2019$TSdep <- NA
wr.sf.2019$TSdep_emep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep_emep <- log10(wr.sf.2019$TSdep_emep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019, wr.kmat)[,1]
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.rds")
```


## Compare exports

```{r common, eval = T}
selected.vars <- c("gid","TOC.fit","TOC.export","TSdep","TSdep_emep","Runoff","forest","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.1999.emep <- readRDS("wr.sf.1999_emep.rds") %>% select(selected.vars)
wr.sf.1999.emep$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.1999.emep) %>% 
              rbind(wr.sf.2009) %>% rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.rds")
saveRDS(wr.exp, "wr.exp.rds")
```

```{r plot-exp}
wr.exp <- readRDS("wr.exp.rds")

basins.exp <- wr.exp  %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), TSdep = mean(TSdep), TSdep_emep = mean(TSdep_emep), Runoff = mean(Runoff), forest = mean(forest))

basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

ggplot(basins.exp, aes(x=year, y = yearlyTOC.Tg, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  labs(y = "Yearly export of TOC, Tg", title = "SELM, forest + logRunoff + TSdep * latitude")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = TOC, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  labs(y = "Predicted TOC concentration, mg/L", title = "SELM, forest + logRunoff + TSdep * latitude")+
  theme_minimal()
ggplot(basins.exp, aes(x=year))+geom_point(aes(y = TSdep, col = sea, shape = "TSdep"))+
  geom_point(aes(y = TSdep_emep, col = sea, shape = "TSdep, EMEP"))+
  #geom_line(aes(y = TSdep, group = sea, col = sea))+
  #geom_line(aes(y = TSdep_emep, group = sea, col= sea))+
  ylab("Total S deposition mg/m2/year")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = Runoff, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  ylab("Runoff, kg/m2/y")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = forest, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  ylab("Forest cover, %")+
  theme_minimal()


```

Changes in selected wr:

-   Oslo fjord: 24085
-   West Norway: 157966
-   North Norway: 29877
-   South Sweden: 28116
-   Est Sweden: 261558
-   Central Sweden: 98655
-   Northern Sweden: 38747
-   South Finland: 127449
-   East Finland: 73788
-   North Finland: 16728

```{r forest-changes}
wr10 <- filter(wr.exp, gid %in% c("24085", "157966", "29877", "28116", "261558","98655","38747","127449","73788","16728"))

ggplot(wr10, aes(x=year, y = forest, col = as.factor(gid)))+geom_point()+
  geom_line(aes(group = as.factor(gid)))+
  ylab("Forest cover, %")+
  theme_minimal()

ggplot(wr10, aes(x=year, y = TOC.fit, col = as.factor(gid)))+geom_point()+
  geom_line(aes(group = as.factor(gid)))+
  ylab("TOC, mg/L")+
  theme_minimal()

```

```{r maps-past-toc, hold = T, fig.dim = c(10,30)}
library(grid)
library(png)
library(cowplot)

listgrob <- list("map.toc.1899.png","map.toc.1909.png","map.toc.1919.png","map.toc.1929.png","map.toc.1939.png","map.toc.1949.png","map.toc.1959.png","map.toc.1969.png","map.toc.1979.png","map.toc.1989.png", "map.toc.1999.png") %>% lapply(readPNG) %>% lapply(rasterGrob)

all.map <- plot_grid(plotlist = listgrob, ncol= 2, nrow = 6, align = "v", greedy = T)

print(all.map)
```

# Predict TOC, GLM with forest + runoff

## Prediction by decade

Model fitted with Runoff in mg/y and TOC in ug/L

```{r load-glm-model}
toc_model <- readRDS("glm.nosdep.rds")

```

```{r predict-1899-nosdep, eval = T}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60
wr.sf.1899$logRunoff.mg <- (wr.sf.1899$Runoff *1e6) %>% log10()
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899)
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit *1e-3
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.nosdep.rds")
```

```{r predict-1909-nosdep, eval = T}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff.mg <- (wr.sf.1909$Runoff * 1e6) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit *1e-3
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.nosdep.rds")
```

```{r predict-1919-nosdep, eval = T}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff.mg <- (wr.sf.1919$Runoff *1e6) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit *1e-3
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.nosdep.rds")
```

```{r predict-1929-nosdep, eval = T}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff.mg <- (wr.sf.1929$Runoff *1e6) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit *1e-3
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.nosdep.rds")
```

```{r predict-1939-nosdep, eval = T}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff.mg <- (wr.sf.1939$Runoff*1e6) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit *1e-3
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.nosdep.rds")
```

```{r predict-1949-nosdep, eval = T}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff.mg <- (wr.sf.1949$Runoff *1e6) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit *1e-3
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.nosdep.rds")
```

```{r predict-1959-nosdep, eval = T}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff.mg <- (wr.sf.1959$Runoff*1e6) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit *1e-3
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.nosdep.rds")
```

```{r predict-1969-nosdep, eval = T}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60
wr.sf.1969$logRunoff.mg <- (wr.sf.1969$Runoff*1e6) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit *1e-3
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.nosdep.rds")
```

```{r predict-1979-nosdep, eval = T}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff.mg <- (wr.sf.1979$Runoff *1e6)  %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit *1e-3
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.nosdep.rds")
```

```{r predict-1989-nosdep, eval = T}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff.mg <- (wr.sf.1989$Runoff * 1e6) %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit *1e-3
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.nosdep.rds")
```

```{r predict-1999-nosdep, eval = T}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff.mg <- (wr.sf.1999$Runoff * 1e6) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit *1e-3
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.nosdep.rds")
```


For 2009 and 2019: Need to download data from EMEP and fit a model on NLS with EMEP data



## Compare exports

```{r common-nosdep, eval = T}
selected.vars <- c("gid","TOC.fit","TOC.export","TSdep","Runoff","forest","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.nosdep.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.nosdep.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.nosdep.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.nosdep.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.nosdep.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.nosdep.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.nosdep.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.nosdep.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.nosdep.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.nosdep.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.nosdep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.nosdep.rds")
saveRDS(wr.exp, "wr.exp.nosdep.rds")
```

```{r plot-exp-nosdep}
wr.exp <- readRDS("wr.exp.nosdep.rds")

basins.exp <- wr.exp  %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), TSdep = mean(TSdep), Runoff = mean(Runoff), forest = mean(forest))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

ggplot(basins.exp, aes(x=year, y = yearlyTOC.Tg, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  labs(y = "Yearly export of TOC, Tg", title = "GLM, logTOC~forest + logRunoff")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = TOC, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  labs("Predicted TOC concentration, mg/L", title = "GLM, logTOC~forest + logRunoff")+
  theme_minimal()
```

Changes in selected wr:

-   Oslo fjord: 24085
-   West Norway: 157966
-   North Norway: 29877
-   South Sweden: 28116
-   Est Sweden: 261558
-   Central Sweden: 98655
-   Northern Sweden: 38747
-   South Finland: 127449
-   East Finland: 73788
-   North Finland: 16728


## Comparison with historical data

```{r eriksson-nosdep}
library(directlabels)

rivers <- st_read("rivers_sweden.shp")
rivers_swe <- readxl::read_xlsx("Rivers Sweden.xlsx")

sf_use_s2(FALSE)
match <- st_join(rivers,wr.sf.wgs84, st_within) %>% merge(select(rivers_swe, c("river_name","closest_year", "DOC_mg.L")), by = "river_name")

ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid %in% match$gid))+geom_sf(data = rivers, aes(color = River))
#ggplot()+geom_sf(data = wr.sf.wgs84)+geom_sf(data = rivers, col = "firebrick")+xlim(11.5,24)+ylim(57,69)
#ggplot()+geom_sf(data = wr.sf.wgs84)+geom_sf(data = rivers, col = "firebrick")+xlim(11.5,20)+ylim(62,64)

wr.exp <- readRDS("wr.exp.nosdep.rds")

match.exp <- wr.exp %>% filter(gid %in% match$gid) %>% merge(select(match, c("River","gid")), by = "gid")

ggplot(match.exp, aes(x=year, y = TOC.fit, col = River))+geom_point()+
  geom_line(aes(group = River))+
  ylab("TOC, mg/L")+
  geom_dl(aes(label = River), method = "last.points", position = "dodge2")+ #position_jitterdodge(jitter.width = 0.5, jitter.height = 0.5, dodge.width = 0.1, seed = 54) , 41, 54
  expand_limits(x = c("2009","2019"), y = c(0,12))+
 # geom_point(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River), shape = 2)+
  theme_minimal()+
  theme(legend.position = "none")

ggplot()+
  geom_point(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River))+
  geom_line(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River, group = River), lty = 2)+
  geom_point(data = filter(match.exp, year %in% c("1919","1989")), aes(x = year, y = TOC.fit, col = River))+
  geom_line(data = filter(match.exp, year %in% c("1919","1989")), aes(x = year, y = TOC.fit, col = River, group = River), lty = 1)+
  labs(x = "", y = "TOC, mg/L")+
  facet_grid(cols = vars(River))+
  theme_minimal()+theme(legend.position = "none")
```

# Predict TOC, GLM with forest*tsdep + runoff

## Prediction by decade

Model fitted with Runoff in mg/y and TOC in ug/L

```{r load-glm-model-toc}
toc_model <- readRDS("glm.toc.rds")
```

```{r predict-1899-toc, eval = T}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 
wr.sf.1899$logRunoff.mg <- (wr.sf.1899$Runoff *1e6) %>% log10()
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899)
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit *1e-3
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.toc.rds")
```

```{r predict-1909-toc, eval = T}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff.mg <- (wr.sf.1909$Runoff *1e6) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit *1e-3
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.toc.rds")
```

```{r predict-1919-toc, eval = T}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff.mg <- (wr.sf.1919$Runoff *1e6) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit *1e-3
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.toc.rds")
```

```{r predict-1929-toc, eval = T}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff.mg <- (wr.sf.1929$Runoff *1e6) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit *1e-3
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.toc.rds")
```

```{r predict-1939-toc, eval = T}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff.mg <- (wr.sf.1939$Runoff *1e6) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit *1e-3
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.toc.rds")
```

```{r predict-1949-toc, eval = T}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff.mg <- (wr.sf.1949$Runoff *1e6) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit *1e-3
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.toc.rds")
```

```{r predict-1959-toc, eval = T}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff.mg <- (wr.sf.1959$Runoff *1e6) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit *1e-3
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.toc.rds")
```

```{r predict-1969-toc, eval = T}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff.mg <- (wr.sf.1969$Runoff * 1e6) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit *1e-3
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.toc.rds")
```

```{r predict-1979-toc, eval = T}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff.mg <- (wr.sf.1979$Runoff *1e6) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit *1e-3
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.toc.rds")
```

```{r predict-1989-toc, eval = T}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff.mg <- (wr.sf.1989$Runoff *1e6) %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit *1e-3
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.toc.rds")
```

```{r predict-1999-toc, eval = T}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff.mg <- (wr.sf.1999$Runoff *1e6) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit *1e-3
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.toc.rds")
```


For 2009 and 2019: Need to download data from EMEP and fit a model on NLS with EMEP data

## Compare exports

```{r common-toc, eval = T}
selected.vars <- c("gid","TOC.fit","TOC.export","TSdep","Runoff","forest","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.toc.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.toc.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.toc.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.toc.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.toc.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.toc.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.toc.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.toc.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.toc.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.toc.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.toc.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.toc.rds")
saveRDS(wr.exp, "wr.exp.toc.rds")
```

```{r plot-exp-toc}
wr.exp <- readRDS("wr.exp.toc.rds")

basins.exp <- wr.exp  %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), TSdep = mean(TSdep), Runoff = mean(Runoff), forest = mean(forest))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

ggplot(basins.exp, aes(x=year, y = yearlyTOC.Tg, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  labs(y = "Yearly export of TOC, Tg", title = "GLM, logTOC~forest*logTSdep + logRunoff")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = TOC, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  labs(y = "Predicted TOC concentration, mg/L", title = "GLM, logTOC~forest*logTSdep + logRunoff")+
  theme_minimal()
```

Changes in selected wr:

-   Oslo fjord: 24085
-   West Norway: 157966
-   North Norway: 29877
-   South Sweden: 28116
-   Est Sweden: 261558
-   Central Sweden: 98655
-   Northern Sweden: 38747
-   South Finland: 127449
-   East Finland: 73788
-   North Finland: 16728


## Comparison with historical data


```{r eriksson-toc}
rivers <- st_read("rivers_sweden.shp")
rivers_swe <- readxl::read_xlsx("Rivers Sweden.xlsx")

sf_use_s2(FALSE)
match <- st_join(rivers,wr.sf.wgs84, st_within) %>% merge(select(rivers_swe, c("river_name","closest_year", "DOC_mg.L")), by = "river_name")

ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid %in% match$gid))+geom_sf(data = rivers, aes(color = River))
#ggplot()+geom_sf(data = wr.sf.wgs84)+geom_sf(data = rivers, col = "firebrick")+xlim(11.5,24)+ylim(57,69)
#ggplot()+geom_sf(data = wr.sf.wgs84)+geom_sf(data = rivers, col = "firebrick")+xlim(11.5,20)+ylim(62,64)

wr.exp <- readRDS("wr.exp.toc.rds")

match.exp <- wr.exp %>% filter(gid %in% match$gid) %>% merge(select(match, c("River","gid")), by = "gid")

ggplot(match.exp, aes(x=year, y = TOC.fit, col = River))+geom_point()+
  geom_line(aes(group = River))+
  ylab("TOC, mg/L")+
  geom_dl(aes(label = River), method = "last.points", position = "dodge2")+ #position_jitterdodge(jitter.width = 0.5, jitter.height = 0.5, dodge.width = 0.1, seed = 54) , 41, 54
  expand_limits(x = c("2009","2019"), y = c(0,12))+
 # geom_point(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River), shape = 2)+
  theme_minimal()+
  theme(legend.position = "none")

ggplot()+
  geom_point(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River))+
  geom_line(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River, group = River), lty = 2)+
  geom_point(data = filter(match.exp, year %in% c("1919","1989")), aes(x = year, y = TOC.fit, col = River))+
  geom_line(data = filter(match.exp, year %in% c("1919","1989")), aes(x = year, y = TOC.fit, col = River, group = River), lty = 1)+
  labs(x = "", y = "TOC, mg/L")+
  facet_grid(cols = vars(River))+
  theme_minimal()+theme(legend.position = "none")
```

# Predict TOC, GLM with forest + runoff + tsdep*latitude
 
## Prediction by decade

Model fitted with Runoff in mg/y and TOC in ug/L

```{r load-glm-model-lat}
toc_model <- readRDS("glm.log.rds")
```

```{r predict-1899-lat, eval = T}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff.mg <- (wr.sf.1899$Runoff *1e6) %>% log10() # mg/y, log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit *1e-3
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.lat.rds")
```

```{r predict-1909-lat, eval = T}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff.mg <- (wr.sf.1909$Runoff *1e6) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit *1e-3
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.lat.rds")
```

```{r predict-1919-lat, eval = T}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff.mg <- (wr.sf.1919$Runoff *1e6) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit *1e-3
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.lat.rds")
```

```{r predict-1929-lat, eval = T}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.wr.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff.mg <- (wr.sf.1929$Runoff *1e6) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit *1e-3
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.lat.rds")
```

```{r predict-1939-lat, eval = T}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff.mg <- (wr.sf.1939$Runoff *1e6) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit *1e-3
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.lat.rds")
```

```{r predict-1949-lat, eval = T}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff.mg <- (wr.sf.1949$Runoff *1e6) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit *1e-3
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.lat.rds")
```

```{r predict-1959-lat, eval = T}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff.mg <- (wr.sf.1959$Runoff *1e6) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit *1e-3
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.lat.rds")
```

```{r predict-1969-lat, eval = T}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff.mg <- (wr.sf.1969$Runoff * 1e6) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit *1e-3
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.lat.rds")
```

```{r predict-1979-lat, eval = T}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff.mg <- (wr.sf.1979$Runoff * 1e6) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit *1e-3
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.lat.rds")
```

```{r predict-1989-lat, eval = T}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff.mg <- (wr.sf.1989$Runoff * 1e6)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit *1e-3
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.lat.rds")
```

```{r predict-1999-lat, eval = T}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff.mg <- (wr.sf.1999$Runoff * 1e6) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit *1e-3
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.lat.rds")
```


For 2009 and 2019: Need to download data from EMEP and fit a model on NLS with EMEP data

## Compare exports

```{r common-lat, eval = T}
selected.vars <- c("gid","TOC.fit","TOC.export","TSdep","Runoff","forest","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.lat.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.lat.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.lat.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.lat.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.lat.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.lat.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.lat.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.lat.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.lat.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.lat.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.lat.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.lat.rds")
saveRDS(wr.exp, "wr.exp.lat.rds")
```

```{r plot-exp-lat}
wr.exp <- readRDS("wr.exp.lat.rds")

basins.exp <- wr.exp  %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), TSdep = mean(TSdep), Runoff = mean(Runoff), forest = mean(forest))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

ggplot(basins.exp, aes(x=year, y = yearlyTOC.Tg, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  labs(y = "Yearly export of TOC, Tg", title = "GLM logTOC~forest + logRunoff + logTSdep*latitude")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = TOC, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  labs(y = "Predicted TOC concentration, mg/L", title = "GLM logTOC~forest + logRunoff + logTSdep*latitude")+
  theme_minimal()
```

Changes in selected wr:

-   Oslo fjord: 24085
-   West Norway: 157966
-   North Norway: 29877
-   South Sweden: 28116
-   Est Sweden: 261558
-   Central Sweden: 98655
-   Northern Sweden: 38747
-   South Finland: 127449
-   East Finland: 73788
-   North Finland: 16728


## Comparison with historical data


```{r eriksson-lat}

rivers <- st_read("rivers_sweden.shp")
rivers_swe <- readxl::read_xlsx("Rivers Sweden.xlsx")

sf_use_s2(FALSE)
match <- st_join(rivers,wr.sf.wgs84, st_within) %>% merge(select(rivers_swe, c("river_name","closest_year", "DOC_mg.L")), by = "river_name")

ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid %in% match$gid))+geom_sf(data = rivers, aes(color = River))
#ggplot()+geom_sf(data = wr.sf.wgs84)+geom_sf(data = rivers, col = "firebrick")+xlim(11.5,24)+ylim(57,69)
#ggplot()+geom_sf(data = wr.sf.wgs84)+geom_sf(data = rivers, col = "firebrick")+xlim(11.5,20)+ylim(62,64)

wr.exp <- readRDS("wr.exp.lat.rds")

match.exp <- wr.exp %>% filter(gid %in% match$gid) %>% merge(select(match, c("River","gid")), by = "gid")

ggplot(match.exp, aes(x=year, y = TOC.fit, col = River))+geom_point()+
  geom_line(aes(group = River))+
  ylab("TOC, mg/L")+
  geom_dl(aes(label = River), method = "last.points", position = "dodge2")+ #position_jitterdodge(jitter.width = 0.5, jitter.height = 0.5, dodge.width = 0.1, seed = 54) , 41, 54
  expand_limits(x = c("2009","2019"), y = c(0,12))+
 # geom_point(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River), shape = 2)+
  theme_minimal()+
  theme(legend.position = "none")

ggplot()+
  geom_point(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River))+
  geom_line(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River, group = River), lty = 2)+
  geom_point(data = filter(match.exp, year %in% c("1919","1989")), aes(x = year, y = TOC.fit, col = River))+
  geom_line(data = filter(match.exp, year %in% c("1919","1989")), aes(x = year, y = TOC.fit, col = River, group = River), lty = 1)+
  labs(x = "", y = "TOC, mg/L")+
  facet_grid(cols = vars(River))+
  theme_minimal()+theme(legend.position = "none")
```

# Maps

```{r map-toc-1899, eval = F}
map.toc.1899 <- ggplot(wr.sf.1899)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1899", fill = "TOC concentration\nin mg/L in 1899")+
  theme_void()

ggsave("map.toc.1899.png", map.toc.1899)
```

```{r map-toc-1909, eval = F}
map.toc.1909 <- ggplot(wr.sf.1909)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1909", fill = "TOC concentration\nin mg/L in 1909")+
  theme_void()

ggsave("map.toc.1909.png", map.toc.1909)
```

```{r map-toc-1919, eval = F}
map.toc.1919 <- ggplot(wr.sf.1919)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1919", fill = "TOC concentration\nin mg/L in 1919")+
  theme_void()

ggsave("map.toc.1919.png", map.toc.1919)
```

```{r map-toc-1929, eval = F}
map.toc.1929 <- ggplot(wr.sf.1929)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1929", fill = "TOC concentration\nin mg/L in 1929")+
  theme_void()

ggsave("map.toc.1929.png", map.toc.1929)
```

```{r map-toc-1939, eval = F}
map.toc.1939 <- ggplot(wr.sf.1939)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1939", fill = "TOC concentration\nin mg/L in 1939")+
  theme_void()

ggsave("map.toc.1939.png", map.toc.1939)
```


```{r map-toc-1949, eval = F}
map.toc.1949 <- ggplot(wr.sf.1949)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1949", fill = "TOC concentration\nin mg/L in 1949")+
  theme_void()

ggsave("map.toc.1949.png", map.toc.1949)
```

```{r map-toc-1959, eval = F}
map.toc.1959 <- ggplot(wr.sf.1959)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1959", fill = "TOC concentration\nin mg/L in 1959")+
  theme_void()

ggsave("map.toc.1959.png", map.toc.1959)
```



```{r map-toc-1969, eval = F}
map.toc.1969 <- ggplot(wr.sf.1969)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1969", fill = "TOC concentration\nin mg/L in 1969")+
  theme_void()

ggsave("map.toc.1969.png", map.toc.1969)
```

```{r map-toc-1979, eval = F}
map.toc.1979 <- ggplot(wr.sf.1979)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1979", fill = "TOC concentration\nin mg/L in 1979")+
  theme_void()

ggsave("map.toc.1979.png", map.toc.1979)
```

```{r map-toc-1989, eval = F}
map.toc.1989 <- ggplot(wr.sf.1989)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1989", fill = "TOC concentration\nin mg/L in 1989")+
  theme_void()

ggsave("map.toc.1989.png", map.toc.1989)
```

```{r map-toc-1999, eval = F}
map.toc.1999 <- ggplot(wr.sf.1999)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1999", fill = "TOC concentration\nin mg/L in 1999")+
  theme_void()

ggsave("map.toc.1999.png", map.toc.1999)
```
