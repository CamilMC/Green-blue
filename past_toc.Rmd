---
title: "past_data"
date: "2023-04-21"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center", collapse = T)
options(knitr.kable.NA="", knitr.table.format = "html")
```

```{r libraries}
library(raster)
library(sf)
library(dplyr)
library(ggplot2)
library(colorspace)
library(directlabels)
library(RColorBrewer)
library(ggpubr)

library(spdep)
library(spatialreg)

lims <- c(0,20)
```

```{r function-plot}
plot.export <- function(df, main.title){
 g <- ggplot(df, aes(x=year, y = TOC, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+
  labs(y = "Predicted TOC concentration, mg/L", title = main.title, col = "Sea")+
  theme_minimal()+theme(axis.text.x =element_text(angle = 45))
h <- ggplot(df, aes(x=year, y = yearlyTOC.Tg, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+
  labs(y = "Yearly export of TOC, Tg", title = "", col = "Sea")+
  theme_minimal()+theme(axis.text.x =element_text(angle = 45))

ggpubr::ggarrange(g,h, common.legend = T, legend = "bottom") %>% print()
}

plot.historical <- function(df, main.title){

for(i in unique(df$gid)){
g <- ggplot(filter(df, gid == i))+
  geom_point(aes(x = Year, y = TOC, col = Name), size = 0.5)+
  #geom_line(aes(x = Year, y = TOC, col = Name, group = Name), lty = 2)+
  geom_point(aes(x = decade, y = TOC.obs), col = "mediumaquamarine")+
  geom_line(aes(x = decade, y = TOC.obs, group = gid), col = "mediumaquamarine", lty = 1)+
  geom_point(aes(x = as.numeric(year), y = TOC.fit), col = "firebrick")+
  geom_line(aes(x = as.numeric(year), y = TOC.fit, group = gid), col = "firebrick", lty = 1)+
  labs(x = "", y = "TOC, mg/L", col = "River", title = main.title)+
  scale_color_brewer(palette = "Dark2")+
  expand_limits(x = 2029)+
  #facet_grid(cols = vars(Name))+
  theme_minimal()+theme(legend.position = "none")
h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid == i))+geom_sf(data = filter(st_as_sf(df), gid == i), aes(color = Name))+
  borders(regions = "Sweden")+scale_color_brewer(palette = "Dark2")+labs(color = "River")+theme_void()+theme(legend.position = "bottom")
ggpubr::ggarrange(g,h, widths = c(2,1)) %>% print()
}
  
}
```

# Extract past data

## Catchment data

```{r wr}
wr.sf <- readRDS("wr.sf.rds")

sf_use_s2(FALSE)
wr.centroid <- st_centroid(wr.sf) %>% st_transform(st_crs(4326))
wr.sf$latitude <- st_coordinates(wr.centroid)[,2]

wr.sf.wgs84 <- st_transform(wr.sf, st_crs(4326))

lims <- c(0,20)
```

```{r create-import basins}
basins <- st_read("basins_all_sea.shp") %>% st_cast("POLYGON")
st_crs(basins) <- st_crs(4326)
basins$sea <- with(basins, ifelse(Poly %in% c(1:161), "Baltic",
                                  ifelse(Poly %in% c(162:253), "North",
                                    "NCC")))
wr.basins <- st_join(wr.centroid, basins, st_join = st_within)

ggplot()+ geom_sf(data = basins, aes(col = sea), fill = NA)+geom_sf(data = wr.basins, aes(col = sea, size = area))

saveRDS(wr.basins, "wr.basins.rds")
```

```{r swedish10, eval = F}
cod.table <- readxl::read_xlsx("Historical_COD.xlsx", sheet = "CODTable10km")
cod.sf <- st_as_sf(cod.table, coords = c("LonLinked","LatLinked"), crs = st_crs(4326))
cod.sf.sum <- cod.sf %>% group_by(Name, Year) %>% summarise(TOC = mean(as.numeric(COD), na.rm = T))

#match <- st_join(cod.sf.sum, wr.sf.wgs84, st_within)
#saveRDS(match,"match.swedish10.rds")

match <- readRDS("match.swedish10.rds")
merged.rivers <- match %>% select(c("Name","Year","TOC","gid"))

merged.rivers$decade <- ifelse(merged.rivers$Year %in% c(1894:1904), 1899, 
                               ifelse(merged.rivers$Year %in% c(1904:1914), 1909,
                                ifelse(merged.rivers$Year %in% c(1914:1924), 1919,
                                ifelse(merged.rivers$Year %in% c(1924:1934), 1929,
                                ifelse(merged.rivers$Year %in% c(1924:1934), 1929,
                                ifelse(merged.rivers$Year %in% c(1934:1944), 1939,
                                ifelse(merged.rivers$Year %in% c(1944:1954), 1949,
                                ifelse(merged.rivers$Year %in% c(1954:1964), 1959,
                                ifelse(merged.rivers$Year %in% c(1964:1974), 1969,
                                ifelse(merged.rivers$Year %in% c(1974:1984), 1979,
                                ifelse(merged.rivers$Year %in% c(1984:1994), 1989,
                                ifelse(merged.rivers$Year %in% c(1994:2004), 1999,
                                ifelse(merged.rivers$Year %in% c(2004:2014), 2009,
                        2019))))))))))))) 

ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid %in% merged.rivers$gid))+geom_sf(data = merged.rivers, aes(color = Name))

saveRDS(merged.rivers, "merged.rivers10.rds")
```

```{r swedish5, eval = F}
cod.table <- readxl::read_xlsx("Historical_COD.xlsx", sheet = "CODTable5km")
cod.sf <- st_as_sf(cod.table, coords = c("LonLinked","LatLinked"), crs = st_crs(4326))
cod.sf.sum <- cod.sf %>% group_by(Name, Year) %>% summarise(TOC = mean(as.numeric(COD), na.rm = T))

match <- st_join(cod.sf.sum, wr.sf.wgs84, st_within)
saveRDS(match,"match.swedish5.rds")

#match <- readRDS("match.swedish5.rds")
merged.rivers <- match %>% select(c("Name","Year","TOC","gid"))

merged.rivers$decade <- ifelse(merged.rivers$Year %in% c(1894:1904), 1899, 
                               ifelse(merged.rivers$Year %in% c(1904:1914), 1909,
                                ifelse(merged.rivers$Year %in% c(1914:1924), 1919,
                                ifelse(merged.rivers$Year %in% c(1924:1934), 1929,
                                ifelse(merged.rivers$Year %in% c(1924:1934), 1929,
                                ifelse(merged.rivers$Year %in% c(1934:1944), 1939,
                                ifelse(merged.rivers$Year %in% c(1944:1954), 1949,
                                ifelse(merged.rivers$Year %in% c(1954:1964), 1959,
                                ifelse(merged.rivers$Year %in% c(1964:1974), 1969,
                                ifelse(merged.rivers$Year %in% c(1974:1984), 1979,
                                ifelse(merged.rivers$Year %in% c(1984:1994), 1989,
                                ifelse(merged.rivers$Year %in% c(1994:2004), 1999,
                                ifelse(merged.rivers$Year %in% c(2004:2014), 2009,
                        2019))))))))))))) 

decade.toc <- merged.rivers %>% group_by(Name,decade) %>% summarise(TOC.decade = mean(as.numeric(TOC)))

merged.rivers <- merge(merged.rivers, st_drop_geometry(decade.toc), by = c("Name","decade"))

ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid %in% merged.rivers$gid))+geom_sf(data = merged.rivers, aes(color = Name))

saveRDS(merged.rivers, "merged.rivers.rds")
```

## HILDA

### Extracting forests

HILDA data are downloaded from <https://www.wur.nl/en/research-results/chair-groups/environmental-sciences/laboratory-of-geo-information-science-and-remote-sensing/models/hilda/hilda-data-downloads.html>

Hilda categories:

-   77: Water
-   66: Other land
-   55: Grass/schrubland
-   45: Forest, mixed
-   44: Forest, deciduous broad leaf
-   43: Forest: deciduous needle
-   42: Forest, evergreen borad leaf
-   41: Forest, evergreen needle
-   40: Forest, other
-   33: Pasture
-   22: Cropland
-   11: Urban

```{r extract-data-hilda-1899, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 1)

hilda.1899 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1899, "hilda.1899.wr.rds")

hilda.1899 <- readRDS("hilda.1899.wr.rds")
hilda.tab <- sapply(hilda.1899, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1899.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1899.rds")
```

```{r extract-data-hilda-1909, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 2)

hilda.1909 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1909, "hilda.1909.wr.rds")

hilda.1909 <- readRDS("hilda.1909.wr.rds")
hilda.tab <- sapply(hilda.1909, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1909.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1909.rds")
```

```{r extract-data-hilda-1919, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 3)

hilda.1919 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1919, "hilda.1919.wr.rds")

hilda.1919 <- readRDS("hilda.1919.wr.rds")
hilda.tab <- sapply(hilda.1919, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
saveRDS(hilda.tab.prop,"hilda.1919.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1919.rds")
```

```{r extract-data-hilda-1929, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 4)

hilda.1929 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1929, "hilda.1929.wr.rds")

hilda.1929 <- readRDS("hilda.1929.wr.rds")
hilda.tab <- sapply(hilda.1929, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
saveRDS(hilda.tab.prop,"hilda.1929.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid

saveRDS(forest,"forest.1929.rds")
```

```{r extract-data-hilda-1939, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 5)

hilda.1939 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1939, "hilda.1939.wr.rds")

hilda.1939 <- readRDS("hilda.1939.wr.rds")
hilda.tab <- sapply(hilda.1939, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
saveRDS(hilda.tab.prop,"hilda.1939.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1939.rds")
```

```{r extract-data-hilda-1949, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 6)

hilda.1949 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1949, "hilda.1949.wr.rds")

hilda.1949 <- readRDS("hilda.1949.wr.rds")
hilda.tab <- sapply(hilda.1949, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1949.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1949.rds")
```

```{r extract-data-hilda-1959, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 7)

hilda.1959 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1959, "hilda.1959.wr.rds")

hilda.1959 <- readRDS("hilda.1959.wr.rds")
hilda.tab <- sapply(hilda.1959, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1959.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1959.rds")
```

```{r extract-data-hilda-1969, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 8)

hilda.1969 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1969, "hilda.1969.wr.rds")

hilda.1969 <- readRDS("hilda.1969.wr.rds")
hilda.tab <- sapply(hilda.1969, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1969.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid

saveRDS(forest,"forest.1969.rds")
```

```{r extract-data-hilda-1979, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 9)

hilda.1979 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1979, "hilda.1979.wr.rds")

hilda.1979 <- readRDS("hilda.1979.wr.rds")
hilda.tab <- sapply(hilda.1979, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1979.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1979.rds")
```

```{r extract-data-hilda-1989, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 10)

hilda.1989 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1989, "hilda.1989.wr.rds")


hilda.1989 <- readRDS("hilda.1989.wr.rds")
hilda.tab <- sapply(hilda.1989, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1989.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1989.rds")
```

```{r extract-data-hilda-1999, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 11)

hilda.1999 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1999, "hilda.1999.wr.rds")

hilda.1999 <- readRDS("hilda.1999.wr.rds")
hilda.tab <- sapply(hilda.1999, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1999.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1999.rds")
```

```{r extract-data-hilda-2009, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 12)

hilda.2009 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.2009, "hilda.2009.wr.rds")

hilda.2009 <- readRDS("hilda.2009.wr.rds")
hilda.tab <- sapply(hilda.2009, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.2009.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid

saveRDS(forest,"forest.2009.rds")
```

```{r extract-data-hilda-2019, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 13)

hilda.2019 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.2019, "hilda.2019.wr.rds")

hilda.2019 <- readRDS("hilda.2019.wr.rds")
hilda.tab <- sapply(hilda.2019, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.2019.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.2019.rds")
```

### Evolution forest 

```{r evolution-forests}
forest.1899 <- readRDS("forest.1899.rds") %>% mutate(year = "1899")
forest.1909 <- readRDS("forest.1909.rds") %>% mutate(year = "1909")
forest.1919 <- readRDS("forest.1919.rds") %>% mutate(year = "1919")
forest.1929 <- readRDS("forest.1929.rds") %>% mutate(year = "1929")
forest.1939 <- readRDS("forest.1939.rds") %>% mutate(year = "1939")
forest.1949 <- readRDS("forest.1949.rds") %>% mutate(year = "1949")
forest.1959 <- readRDS("forest.1959.rds") %>% mutate(year = "1959")
forest.1969 <- readRDS("forest.1969.rds") %>% mutate(year = "1969")
forest.1979 <- readRDS("forest.1979.rds") %>% mutate(year = "1979")
forest.1989 <- readRDS("forest.1989.rds") %>% mutate(year = "1989")
forest.1999 <- readRDS("forest.1999.rds") %>% mutate(year = "1999")
forest.2009 <- readRDS("forest.2009.rds") %>% mutate(year = "2009")
forest.2019 <- readRDS("forest.2019.rds") %>% mutate(year = "2019")

wr.basins <- readRDS("wr.basins.rds")

all.forest <- forest.1899 %>% rbind(forest.1909) %>% rbind(forest.1919) %>% rbind(forest.1929) %>% rbind(forest.1939) %>% rbind(forest.1949) %>% rbind(forest.1959) %>% rbind(forest.1969) %>% rbind(forest.1979) %>% rbind(forest.1989) %>% rbind(forest.1999) %>% rbind(forest.2009) %>% rbind(forest.2019) %>% merge(st_drop_geometry(wr.basins), by = "gid") %>% group_by(sea,year) %>% summarise(forest = mean(forest, na.rm = T))



ggplot(all.forest, aes(x = year, y = forest, col = sea))+geom_point()+geom_line(aes(group = sea))+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+theme_minimal()

```

 Bogs extracted from Corine Land Cover 2006
 
```{r compare-with-bogs, eval = F}
wr.bogs <- readRDS("bogs.wr.rds")

forest.1899 <- wr.sf.wgs84 %>% merge(readRDS("forest.1899.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1899, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1899", subtitle = paste(round(sum(subset(forest.1899, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1909 <- wr.sf.wgs84 %>% merge(readRDS("forest.1909.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1909, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1909", subtitle = paste(round(sum(subset(forest.1909, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1919 <- wr.sf.wgs84 %>% merge(readRDS("forest.1919.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1919, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
   ylim(55,72)+xlim(4,33)+
  labs(title = "1919", subtitle = paste(round(sum(subset(forest.1919, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1929 <- wr.sf.wgs84 %>% merge(readRDS("forest.1929.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1929, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1929", subtitle = paste(round(sum(subset(forest.1929, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1939 <- wr.sf.wgs84 %>% merge(readRDS("forest.1939.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1939, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
    ylim(55,72)+xlim(4,33)+
  labs(title = "1939", subtitle = paste(round(sum(subset(forest.1939, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1949 <- wr.sf.wgs84 %>% merge(readRDS("forest.1949.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1949, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1949", subtitle = paste(round(sum(subset(forest.1949, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1959 <- wr.sf.wgs84 %>% merge(readRDS("forest.1959.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1959, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1959", subtitle = paste(round(sum(subset(forest.1959, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1969 <- wr.sf.wgs84 %>% merge(readRDS("forest.1969.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1969, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1969", subtitle = paste(round(sum(subset(forest.1969, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1979 <- wr.sf.wgs84 %>% merge(readRDS("forest.1979.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1979, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1979", subtitle = paste(round(sum(subset(forest.1979, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1989 <- wr.sf.wgs84 %>% merge(readRDS("forest.1989.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1989, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1989", subtitle = paste(round(sum(subset(forest.1989, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.1999 <- wr.sf.wgs84 %>% merge(readRDS("forest.1999.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.1999, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "1999", subtitle = paste(round(sum(subset(forest.1999, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.2009 <- wr.sf.wgs84 %>% merge(readRDS("forest.2009.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.2009, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "2009", subtitle = paste(round(sum(subset(forest.2009, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

forest.2019 <- wr.sf.wgs84 %>% merge(readRDS("forest.2019.rds"), by = "gid") %>% merge(wr.bogs, by = "gid") %>% mutate(sum = bogs + forest) 

ggplot(filter(forest.2019, sum >= 1))+geom_sf(aes(fill = sum, col = sum))+
  borders(database = "world", regions = c("Norway", "Sweden","Finland"))+
  scale_fill_viridis_c(limits = c(1,1.3), aesthetics = c("colour","fill"))+
  ylim(55,72)+xlim(4,33)+
  labs(title = "2019", subtitle = paste(round(sum(subset(forest.2019, sum >= 1)$area/sum(wr.sf.wgs84$area))*100, 2),"%"," "))+
  theme_void()

```

## Sdep

### Extracting Sdep 

Annual mean deposition in kg/m2/s, averaged in the water drainage basins polygons. 10 years average. REMEMBER TO LOAD WR.SF BEFORE EXTRACTING

```{r load-wr-s, eval = F}
wr.sf <- readRDS("wr.sf.rds")
```

```{r extract-sulfur-1899, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(409:660)) %>% mean() # mean 1894-1904
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(409:660)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(409:660)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(409:660)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1899.rds")
```

```{r extract-sulfur-1909, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(661:780)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(661:780)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(661:780)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(661:780)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1909.rds")
```

```{r extract-sulfur-1919, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(781:900)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(781:900)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(781:900)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(781:900)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1919.rds")
```

```{r extract-sulfur-1929, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(901:1020)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(901:1020)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(901:1020)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(901:1020)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1929.rds")
```

```{r extract-sulfur-1939, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1021:1140)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1021:1140)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1021:1140)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1021:1140)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1939.rds")
```

```{r extract-sulfur-1949, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1041:1260)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1041:1260)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1041:1260)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1041:1260)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1949.rds")
```

```{r extract-sulfur-1959, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1261:1380)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1261:1380)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1261:1380)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1261:1380)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1959.rds")
```

```{r extract-sulfur-1969, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1381:1500)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1381:1500)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1381:1500)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1381:1500)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1969.rds")
```

```{r extract-sulfur-1979, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1501:1620)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1501:1620)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1501:1620)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1501:1620)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1979.rds")
```

```{r extract-sulfur-1989, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1621:1740)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1621:1740)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1621:1740)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1621:1740)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1989.rds")
```

```{r extract-sulfur-1999, eval = F}
dryso2 <- raster("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1741:1860))
dryso4 <- raster("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1741:1860))
wetso2 <- raster("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1741:1860))
wetso4 <- raster("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1741:1860))

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1999.rds")
```

Does not exist for 2009. EMEP in mg/m2

```{r sdep-1999, eval = F}

wsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.1994met_1994emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1995met_1995emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1996met_1996emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1997met_1997emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1998met_1998emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.1999met_1999emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2000met_2000emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2001met_2001emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2002met_2002emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2003met_2003emis_rep2022.nc", varname = "WDEP_SOX")) %>% mean()

wsdep.1999 <- extract(wsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wsdep.1999) <- c("gid","area","wsdep")
saveRDS(wsdep.1999, "wsdep.1999.rds")

dsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.1994met_1994emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1995met_1995emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1996met_1996emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1997met_1997emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1998met_1998emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.1999met_1999emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2000met_2000emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2001met_2001emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2002met_2002emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2003met_2003emis_rep2022.nc", varname = "DDEP_SOX_m2Grid")) %>% mean() 

dsdep.1999 <- extract(dsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dsdep.1999) <- c("gid","area","dsdep")
saveRDS(dsdep.1999, "dsdep.1999.rds")

sdep.1999 <- merge(wsdep.1999, dsdep.1999, by = "gid")
sdep.1999$tsdep <- sdep.1999$wsdep + sdep.1999$dsdep
saveRDS(sdep.1999,"sdep.1999.rds")
```

```{r sdep-2009, eval = F}

wsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.2004met_2004emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2005met_2005emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2006met_2006emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2007met_2007emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2008met_2008emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2009met_2009emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2010met_2010emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2011met_2011emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2012met_2012emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2013met_2013emis_rep2022.nc", varname = "WDEP_SOX")) %>% mean()

wsdep.2009 <- extract(wsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wsdep.2009) <- c("gid","area","wsdep")
saveRDS(wsdep.2009, "wsdep.2009.rds")

dsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.2004met_2004emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2005met_2005emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2006met_2006emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2007met_2007emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2008met_2008emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2009met_2009emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2010met_2010emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2011met_2011emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2012met_2012emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2013met_2013emis_rep2022.nc", varname = "DDEP_SOX_m2Grid")) %>% mean() 

dsdep.2009 <- extract(dsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dsdep.2009) <- c("gid","area","dsdep")
saveRDS(dsdep.2009, "dsdep.2009.rds")

sdep.2009 <- merge(wsdep.2009, dsdep.2009, by = "gid")
sdep.2009$tsdep <- sdep.2009$wsdep + sdep.2009$dsdep
saveRDS(sdep.2009, "sdep.2009.rds")
```

```{r sdep-2019, eval = F}

wsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.2014met_2014emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2015met_2015emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2016met_2016emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2017met_2017emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2018met_2018emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2019met_2019emis_rep2022.nc", varname = "WDEP_SOX"),
  raster("Sdep/EMEP01_rv4.45_year.2020met_2020emis.nc", varname = "WDEP_SOX")) %>% mean()

wsdep.2019 <- extract(wsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wsdep.2019) <- c("gid","area","wsdep")
saveRDS(wsdep.2019, "wsdep.2019.rds")

dsdep.stack <- raster::stack(
  raster("Sdep/EMEP01_rv4.45_year.2014met_2014emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2015met_2015emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2016met_2016emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2017met_2017emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2018met_2018emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2019met_2019emis_rep2022.nc", varname = "DDEP_SOX_m2Grid"),
  raster("Sdep/EMEP01_rv4.45_year.2020met_2020emis.nc", varname = "DDEP_SOX_m2Grid")) %>% mean() 

dsdep.2019 <- extract(dsdep.stack, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dsdep.2019) <- c("gid","area","dsdep")
saveRDS(dsdep.2019, "dsdep.2019.rds")

sdep.2019 <- merge(wsdep.2019, dsdep.2019, by = "gid")
sdep.2019$tsdep <- sdep.2019$wsdep + sdep.2019$dsdep
saveRDS(sdep.2019, "sdep.2019.rds")
```

### Compare sdep 

```{r compare-sdep}
sdep.1899 <- readRDS("sdep.df.1899.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = (tsdep * (-1) * 365 * 24 * 60 * 60 *1e6), year = "1899", model = "historical") 
sdep.1909 <- readRDS("sdep.df.1909.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1909", model = "historical")
sdep.1919 <- readRDS("sdep.df.1919.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1919", model = "historical")
sdep.1929 <- readRDS("sdep.df.1929.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1929", model = "historical")
sdep.1939 <- readRDS("sdep.df.1939.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1939", model = "historical")
sdep.1949 <- readRDS("sdep.df.1949.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1949", model = "historical")
sdep.1959 <- readRDS("sdep.df.1959.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1959", model = "historical")
sdep.1969 <- readRDS("sdep.df.1969.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1969", model = "historical")
sdep.1979 <- readRDS("sdep.df.1979.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1979", model = "historical")
sdep.1989 <- readRDS("sdep.df.1989.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1989", model = "historical")
sdep.1999 <- readRDS("sdep.df.1999.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep * (-1) * 365 * 24 * 60 * 60*1e6, year = "1999", model = "historical")
sdep.1999_emep <- readRDS("sdep.1999.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep, year = "1999", model = "EMEP")
sdep.2009 <- readRDS("sdep.2009.rds")@data %>% select(c("gid","tsdep")) %>%  mutate(TSdep = tsdep,year = "2009", model = "EMEP")
sdep.2019 <- readRDS("sdep.2019.rds")@data %>% select(c("gid","tsdep")) %>% mutate(TSdep = tsdep,year = "2019", model = "EMEP")

wr.basins <- readRDS("wr.basins.rds")

sdep <- sdep.1899 %>% rbind(sdep.1909) %>% rbind(sdep.1919) %>% rbind(sdep.1929) %>% rbind(sdep.1939) %>% rbind(sdep.1939) %>% rbind(sdep.1949) %>% rbind(sdep.1959) %>% rbind(sdep.1969) %>% rbind(sdep.1979) %>% rbind(sdep.1989) %>% rbind(sdep.1999) %>% rbind(sdep.1999_emep) %>% rbind(sdep.2009) %>% rbind(sdep.2019) %>% merge(st_drop_geometry(wr.basins), by = "gid") %>% group_by(sea,year, model) %>% summarise(TSdep = mean(TSdep, na.rm = T))

ggplot()+geom_point(data = filter(sdep, model == "historical"), aes(x=year, y = TSdep, col = sea))+
         geom_line(data = filter(sdep, model == "historical"),aes(x=year, y = TSdep, col = sea, group = sea), lty = 1)+
  geom_point(data = filter(sdep, model == "EMEP"), aes(x=year, y = TSdep, col = sea))+
         geom_line(data = filter(sdep, model == "EMEP"),aes(x=year, y = TSdep, col = sea, group = sea), lty = 2)+
    ylab("TSdep, mg/m2/y")+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

## Runoff with CNRM

CMIP6 information: https://pcmdi.llnl.gov/CMIP6/

https://wcrp-cmip.github.io/CMIP6_CVs/docs/CMIP6_source_id_experiment_citation.html

Information on AMIP: https://www.wdc-climate.de/ui/cmip6?input=CMIP6.CMIP.CNRM-CERFACS.CNRM-CM6-1.amip
Historical experiment: https://www.wdc-climate.de/ui/cmip6?input=CMIP6.CMIP.CNRM-CERFACS.CNRM-CM6-1.historical


10 years average

```{r load-wr, eval = F}
wr.sf <- readRDS("wr.sf.rds")
```

```{r runoff-1899, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(409:660))
runoff.mean <- runoff.stack %>% mean() 

runoff.1899 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1899) <- c("gid","area","runoff")
saveRDS(runoff.1899,"runoff.1899.rds")
```

```{r runoff-1909, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(661:780))
runoff.mean <- runoff.stack %>% mean() 

runoff.1909 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)



names(runoff.1909) <- c("gid","area","runoff")
saveRDS(runoff.1909,"runoff.1909.rds")
```

```{r runoff-1919, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(781:900)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1919 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1919) <- c("gid","area","runoff")
saveRDS(runoff.1919,"runoff.1919.rds")
```

```{r runoff-1929, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(901:1020)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1929 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1929) <- c("gid","area","runoff")
saveRDS(runoff.1929,"runoff.1929.rds")
```

```{r runoff-1939, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1021:1140)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1939 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1939) <- c("gid","area","runoff")
saveRDS(runoff.1939,"runoff.1939.rds")
```

```{r runoff-1949, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1041:1260)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1949 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)



names(runoff.1949) <- c("gid","area","runoff")
saveRDS(runoff.1949,"runoff.1949.rds")
```

```{r runoff-1959, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1261:1380))
runoff.mean <- runoff.stack %>% mean() 

runoff.1959 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1959) <- c("gid","area","runoff")
saveRDS(runoff.1959,"runoff.1959.rds")
```

```{r runoff-1969, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1381:1500)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1969 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1969) <- c("gid","area","runoff")
saveRDS(runoff.1969,"runoff.1969.rds")
```

```{r runoff-1979, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1501:1620)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1979 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1979) <- c("gid","area","runoff")
saveRDS(runoff.1979,"runoff.1979.rds")
```

```{r runoff-1989, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1621:1740)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1989 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1989) <- c("gid","area","runoff")
saveRDS(runoff.1989,"runoff.1989.rds")
```

```{r runoff-1999, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1741:1860)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1999 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1999) <- c("gid","area","runoff")
saveRDS(runoff.1999,"runoff.1999.rds")
```

```{r runoff-2009, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1849:1980)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.2009 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.2009) <- c("gid","area","runoff")
saveRDS(runoff.2009,"runoff.2009.rds")
```

The historical models in CMIP6 stops in 2014. Surface runoff is available for future projections. We used the projection for SSP245, taking into account the emissions during the COVID years. 

```{r runoff-2019, eval = F}
runoff.raster1 <- "mrros_Lmon_NorESM2-LM_ssp245-covid_r1i1p1f2_gn_201502-202012.nc"
runoff.raster2 <- "mrros_Lmon_NorESM2-LM_ssp245-covid_r1i1p1f2_gn_202101-203012.nc"

runoff.stack1 <- raster::stack(runoff.raster1, bands = c(1:71)) # all layers from 2015 to 2020
runoff.stack2 <- raster::stack(runoff.raster2, bands = c(1:48)) # layers from 2021 to 2024
runoff.mean <-  raster::stack(runoff.stack1, runoff.stack2) %>% mean() 

runoff.2019 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

runoff.2019 <- readRDS("runoff.2019.rds")
names(runoff.2019) <- c("gid","area","runoff")
saveRDS(runoff.2019,"runoff.2019.rds")
```



## Runoff with NorESM

CMIP6 information: https://pcmdi.llnl.gov/CMIP6/

https://wcrp-cmip.github.io/CMIP6_CVs/docs/CMIP6_source_id_experiment_citation.html

Information on AMIP: https://www.wdc-climate.de/ui/cmip6?input=CMIP6.CMIP.CNRM-CERFACS.CNRM-CM6-1.amip
Historical experiment: https://www.wdc-climate.de/ui/cmip6?input=CMIP6.CMIP.CNRM-CERFACS.CNRM-CM6-1.historical


Resolution: 100 km

10 years average

```{r load-wr-noresm, eval = F}
wr.sf <- readRDS("wr.sf.rds")
```

```{r runoff-1899-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_189001-189912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_190001-190912.nc"


runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) # from 1894 to 1899
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) # from 1900 to 1904
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1899 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1899) <- c("gid","area","runoff")
saveRDS(runoff.1899,"runoff.1899.noresm.rds")
```

```{r runoff-1909-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_190001-190912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_191001-191912.nc"


runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1909 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)



names(runoff.1909) <- c("gid","area","runoff")
saveRDS(runoff.1909,"runoff.1909.noresm.rds")
```

```{r runoff-1919-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_191001-191912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_192001-192912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1919 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1919) <- c("gid","area","runoff")
saveRDS(runoff.1919,"runoff.1919.noresm.rds")
```

```{r runoff-1929-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_192001-192912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_193001-193912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1929 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1929) <- c("gid","area","runoff")
saveRDS(runoff.1929,"runoff.1929.noresm.rds")
```

```{r runoff-1939-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_193001-193912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_194001-194912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1939 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1939) <- c("gid","area","runoff")
saveRDS(runoff.1939,"runoff.1939.noresm.rds")
```

```{r runoff-1949-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_194001-194912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_195001-195912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1949 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1949) <- c("gid","area","runoff")
saveRDS(runoff.1949,"runoff.1949.noresm.rds")
```

```{r runoff-1959-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_195001-195912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_196001-196912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1959 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1959) <- c("gid","area","runoff")
saveRDS(runoff.1959,"runoff.1959.noresm.rds")
```

```{r runoff-1969-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_196001-196912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_197001-197912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1969 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1969) <- c("gid","area","runoff")
saveRDS(runoff.1969,"runoff.1969.noresm.rds")
```

```{r runoff-1979-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_197001-197912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_198001-198912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1979 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1979) <- c("gid","area","runoff")
saveRDS(runoff.1979,"runoff.1979.noresm.rds")
```

```{r runoff-1989-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_198001-198912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_199001-199912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1989 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1989) <- c("gid","area","runoff")
saveRDS(runoff.1989,"runoff.1989.noresm.rds")
```

```{r runoff-1999-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_199001-199912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_200001-200912.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.1999 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1999) <- c("gid","area","runoff")
saveRDS(runoff.1999,"runoff.1999.noresm.rds")
```

```{r runoff-2009-noresm, eval = F}
runoff.raster.1 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_200001-200912.nc"
runoff.raster.2 <- "mrros_Lmon_NorESM2-MM_historical_r1i1p1f1_gn_201001-201412.nc"

runoff.stack.1 <- raster::stack(runoff.raster.1, bands = c(49:120)) 
runoff.stack.2 <- raster::stack(runoff.raster.1, bands = c(1:48)) 
runoff.mean <- raster::stack(runoff.stack.1, runoff.stack.2) %>% mean() 

runoff.2009 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.2009) <- c("gid","area","runoff")
saveRDS(runoff.2009,"runoff.2009.noresm.rds")
```

The historical models in CMIP6 stops in 2014. Surface runoff is available for future projections. We used the projection for SSP245, taking into account the emissions during the COVID years. Also calculated with NorESM. 

```{r runoff-2019-noresm, eval = F}
runoff.raster1 <- "mrros_Lmon_NorESM2-LM_ssp245-covid_r1i1p1f2_gn_201502-202012.nc"
runoff.raster2 <- "mrros_Lmon_NorESM2-LM_ssp245-covid_r1i1p1f2_gn_202101-203012.nc"

runoff.stack1 <- raster::stack(runoff.raster1, bands = c(1:71)) # all layers from 2015 to 2020
runoff.stack2 <- raster::stack(runoff.raster2, bands = c(1:48)) # layers from 2021 to 2024
runoff.mean <-  raster::stack(runoff.stack1, runoff.stack2) %>% mean() 

runoff.2019 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)

runoff.2019 <- readRDS("runoff.2019.rds")
names(runoff.2019) <- c("gid","area","runoff")
saveRDS(runoff.2019,"runoff.2019.noresm.rds")
```




## Runoff copernicus 

https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-single-levels-monthly-means?tab=form

Runoff in m of water per day. *1000 to convert in kg/m2/day:
https://confluence.ecmwf.int/display/CKB/ERA5%3A+data+documentation#ERA5:datadocumentation-Meanrates/fluxesandaccumulations

2 levels in raster, only 1 is used.


```{r copernicus-runoff, eval = F}
raster("era.runoff.nc")
```

```{r runoff-1949-era, eval = F}
runoff.raster <- "era.runoff.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(49:168)) # 01-1944 to 12-1953
runoff.mean <- runoff.stack %>% mean() 

runoff.1949 <- raster::extract(runoff.mean, wr.sf.wgs84, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1949) <- c("gid","area","runoff")
saveRDS(runoff.1949,"runoff.1949.era.rds")
```

```{r runoff-1959-era, eval = F}
runoff.raster <- "era.runoff.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(169:288))
runoff.mean <- runoff.stack %>% mean() 

runoff.1959 <- raster::extract(runoff.mean, wr.sf.wgs84, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1959) <- c("gid","area","runoff")
saveRDS(runoff.1959,"runoff.1959.era.rds")
```

```{r runoff-1969-era, eval = F}
runoff.raster <- "era.runoff.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(289:408)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1969 <- raster::extract(runoff.mean, wr.sf.wgs84, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1969) <- c("gid","area","runoff")
saveRDS(runoff.1969,"runoff.1969.era.rds")
```

```{r runoff-1979-era, eval = F}
runoff.raster <- "era.runoff.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(409:528)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1979 <- raster::extract(runoff.mean, wr.sf.wgs84, fun = mean, df = T, sp = T, na.rm = T)


names(runoff.1979) <- c("gid","area","runoff")
saveRDS(runoff.1979,"runoff.1979.era.rds")
```

```{r runoff-1989-era, eval = F}
runoff.raster <- "era.runoff.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(529:648)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1989 <- raster::extract(runoff.mean, wr.sf.wgs84, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1989) <- c("gid","area","runoff")
saveRDS(runoff.1989,"runoff.1989.era.rds")
```

```{r runoff-1999-era, eval = F}
runoff.raster <- "era.runoff.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(649:768)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1999 <- raster::extract(runoff.mean, wr.sf.wgs84, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.1999) <- c("gid","area","runoff")
saveRDS(runoff.1999,"runoff.1999.era.rds")
```

```{r runoff-2009-era, eval = F}
runoff.raster <- "era.runoff.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(769:888)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.2009 <- raster::extract(runoff.mean, wr.sf.wgs84, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.2009) <- c("gid","area","runoff")
saveRDS(runoff.2009,"runoff.2009.era.rds")
```

```{r runoff-2019-era, eval = F}
runoff.raster <- "era.runoff.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(889:1001)) # from 01-2014 to 5-2023 
runoff.mean <- runoff.stack %>% mean(na.rm = T) 

runoff.2019 <- raster::extract(runoff.mean, wr.sf.wgs84, fun = mean, df = T, sp = T, na.rm = T)

names(runoff.2019) <- c("gid","area","runoff")
saveRDS(runoff.2019,"runoff.2019.era.rds")
```

## Compare CNRM-ERA-NorESM

```{r compare}
runoff.1949.era <- readRDS("runoff.1949.era.rds")@data %>% mutate(year = "1949")
runoff.1959.era <- readRDS("runoff.1959.era.rds")@data %>% mutate(year = "1959")
runoff.1969.era <- readRDS("runoff.1969.era.rds")@data %>% mutate(year = "1969")
runoff.1979.era <- readRDS("runoff.1979.era.rds")@data %>% mutate(year = "1979")
runoff.1989.era <- readRDS("runoff.1989.era.rds")@data %>% mutate(year = "1989")
runoff.1999.era <- readRDS("runoff.1999.era.rds")@data %>% mutate(year = "1999")
runoff.2009.era <- readRDS("runoff.2009.era.rds")@data %>% mutate(year = "2009")
runoff.2019.era <- readRDS("runoff.2019.era.rds")@data %>% mutate(year = "2019")

era <- runoff.1949.era %>% rbind(runoff.1959.era) %>% 
      rbind(runoff.1969.era) %>% rbind(runoff.1979.era) %>%
      rbind(runoff.1989.era) %>% rbind(runoff.1999.era) %>%
      rbind(runoff.2009.era) %>% rbind(runoff.2019.era)

era$Runoff <- era$runoff  * 365 * 24 * 60 * 60 # convert from kg/m2/s to kg/m2/year
era$Model <- "ERA"

runoff.1899 <- readRDS("runoff.1899.rds")@data %>% mutate(year = "1899")
runoff.1909 <- readRDS("runoff.1909.rds")@data %>% mutate(year = "1909")
runoff.1919 <- readRDS("runoff.1919.rds")@data %>% mutate(year = "1919")
runoff.1929 <- readRDS("runoff.1929.rds")@data %>% mutate(year = "1929")
runoff.1939 <- readRDS("runoff.1939.rds")@data %>% mutate(year = "1939")
runoff.1949 <- readRDS("runoff.1949.rds")@data %>% mutate(year = "1949")
runoff.1959 <- readRDS("runoff.1959.rds")@data %>% mutate(year = "1959")
runoff.1969 <- readRDS("runoff.1969.rds")@data %>% mutate(year = "1969")
runoff.1979 <- readRDS("runoff.1979.rds")@data %>% mutate(year = "1979")
runoff.1989 <- readRDS("runoff.1989.rds")@data %>% mutate(year = "1989")
runoff.1999 <- readRDS("runoff.1999.rds")@data %>% mutate(year = "1999")
runoff.2009 <- readRDS("runoff.2009.rds")@data %>% mutate(year = "2009")


cnrm <- runoff.1899 %>% rbind(runoff.1909) %>% rbind(runoff.1919) %>% 
      rbind(runoff.1929) %>% rbind(runoff.1939) %>%
      rbind(runoff.1949) %>% rbind(runoff.1959) %>% 
      rbind(runoff.1969) %>% rbind(runoff.1979) %>%
      rbind(runoff.1989) %>% rbind(runoff.1999) %>%
      rbind(runoff.2009) 
cnrm$Runoff <- cnrm$runoff * 365 * 24 * 60 * 60 # convert from kg/m2/s
cnrm$Model <- "CNRM"

runoff.1899.noresm <- readRDS("runoff.1899.noresm.rds")@data %>% mutate(year = "1899")
runoff.1909.noresm <- readRDS("runoff.1909.noresm.rds")@data %>% mutate(year = "1909")
runoff.1919.noresm <- readRDS("runoff.1919.noresm.rds")@data %>% mutate(year = "1919")
runoff.1929.noresm <- readRDS("runoff.1929.noresm.rds")@data %>% mutate(year = "1929")
runoff.1939.noresm <- readRDS("runoff.1939.noresm.rds")@data %>% mutate(year = "1939")
runoff.1949.noresm <- readRDS("runoff.1949.noresm.rds")@data %>% mutate(year = "1949")
runoff.1959.noresm <- readRDS("runoff.1959.noresm.rds")@data %>% mutate(year = "1959")
runoff.1969.noresm <- readRDS("runoff.1969.noresm.rds")@data %>% mutate(year = "1969")
runoff.1979.noresm <- readRDS("runoff.1979.noresm.rds")@data %>% mutate(year = "1979")
runoff.1989.noresm <- readRDS("runoff.1989.noresm.rds")@data %>% mutate(year = "1989")
runoff.1999.noresm <- readRDS("runoff.1999.noresm.rds")@data %>% mutate(year = "1999")
runoff.2009.noresm <- readRDS("runoff.2009.noresm.rds")@data %>% mutate(year = "2009")
runoff.2019.noresm <- readRDS("runoff.2019.noresm.rds")@data %>% mutate(year = "2019")

noresm <- runoff.1899.noresm %>% rbind(runoff.1909.noresm) %>% rbind(runoff.1919.noresm) %>% 
      rbind(runoff.1929.noresm) %>% rbind(runoff.1939.noresm) %>%
      rbind(runoff.1949.noresm) %>% rbind(runoff.1959.noresm) %>% 
      rbind(runoff.1969.noresm) %>% rbind(runoff.1979.noresm) %>%
      rbind(runoff.1989.noresm) %>% rbind(runoff.1999.noresm) %>%
      rbind(runoff.2009.noresm) %>% rbind(runoff.2019.noresm) 
noresm$Runoff <- noresm$runoff * 365 * 24 * 60 * 60 # convert from kg/m2/s
noresm$Model <- "NorESM"

wr.basins <- readRDS("wr.basins.rds")

all.runoff.model <- rbind(cnrm,noresm) %>% rbind(era) %>% merge(st_drop_geometry(wr.basins), by = "gid") %>% group_by(sea,year, Model) %>% summarise(Runoff = mean(Runoff, na.rm = T))

ggplot()+geom_point(data = filter(all.runoff.model, Model == "CNRM"), aes(x=year, y = Runoff, col = "CNRM"))+
         geom_line(data = filter(all.runoff.model, Model == "CNRM"),aes(x=year, y = Runoff, col = "CNRM", group = sea, lty = "CNRM"))+
         geom_point(data = filter(all.runoff.model, Model == "NorESM"), aes(x=year, y = Runoff, col = "NorESM"))+
         geom_line(data = filter(all.runoff.model, Model == "NorESM"),aes(x=year, y = Runoff, col = "NorESM", group = sea, lty = "NorESM"))+
         geom_point(data = filter(all.runoff.model, Model == "ERA"), aes(x=year, y = Runoff, col = "ERA"))+
         geom_line(data = filter(all.runoff.model, Model == "ERA"),aes(x=year, y = Runoff, col = "ERA", group = sea, lty = "ERA"))+
    ylab("Runoff, kg/m2/y")+
  scale_color_manual(values = c("firebrick","mediumaquamarine", "lightpink2"))+
  facet_grid(cols= vars(sea))+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
```

# Predict TOC, SELM forest + logRunoff + TSdep

## Predict by decade

```{r load-model-selm-ts}
toc_model <- readRDS("sem.fen.ts.rds")
```

```{r wr.kmat, eval = F}
wr.spdf <- SpatialPointsDataFrame(st_coordinates(st_centroid(wr.sf)), st_drop_geometry(wr.sf))
wr.kmat <- knearneigh(wr.spdf, k = 100) %>% knn2nb() %>% nb2listw()
saveRDS(wr.kmat, "wr.kmat.rds")
```

```{r predict-1899-selm-ts, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff %>% log10()
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899, wr.kmat)[,1]
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.selm.ts.rds")
```

```{r predict-1909-selm-ts, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds")  %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60
wr.sf.1909$logRunoff <- wr.sf.1909$Runoff %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909, wr.kmat)[,1]
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.selm.ts.rds")
```

```{r predict-1919-selm-ts, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60
wr.sf.1919$logRunoff <- wr.sf.1919$Runoff %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919, wr.kmat)[,1]
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.selm.ts.rds")
```

```{r predict-1929-selm-ts, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60
wr.sf.1929$logRunoff <- wr.sf.1929$Runoff %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929, wr.kmat)[,1]
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.selm.ts.rds")
```

```{r predict-1939-selm-ts, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60
wr.sf.1939$logRunoff <- wr.sf.1939$Runoff %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939, wr.kmat)[,1]
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.selm.ts.rds")
```

```{r predict-1949-selm-ts, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60
wr.sf.1949$logRunoff <- wr.sf.1949$Runoff %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949, wr.kmat)[,1]
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.selm.ts.rds")
```

```{r predict-1959-selm-ts, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60
wr.sf.1959$logRunoff <- wr.sf.1959$Runoff %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959, wr.kmat)[,1]
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.selm.ts.rds")
```

```{r predict-1969-selm-ts, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- wr.sf.1969$Runoff %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969, wr.kmat)[,1]
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.selm.ts.rds")
```

```{r predict-1979-selm-ts, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60
wr.sf.1979$logRunoff <- wr.sf.1979$Runoff %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979, wr.kmat)[,1]
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.selm.ts.rds")
```

```{r predict-1989-selm-ts, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60
wr.sf.1989$logRunoff <- wr.sf.1989$Runoff %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989, wr.kmat)[,1]
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.selm.ts.rds")
```

```{r predict-1999-selm-ts, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- wr.sf.1999$Runoff %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999, wr.kmat)[,1]
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.selm.ts.rds")
```

```{r predict-1999-selm-ts-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- wr.sf.1999$Runoff %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999, wr.kmat)[,1]
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.selm.ts_emep.rds")
```

```{r predict-2009-selm-ts, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- wr.sf.2009$Runoff %>% log10()
wr.sf.2009$TSdep <- wr.sf.2009$tsdep 
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009, wr.kmat)[,1]
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.selm.ts.rds")
```

```{r predict-2019-selm-ts, eval = F}

forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- wr.sf.2019$Runoff %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019, wr.kmat)[,1]
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.selm.ts.rds")
```


## Compare exports

```{r common-selm-ts, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","TSdep","Runoff","forest","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.selm.ts.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.selm.ts.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.selm.ts.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.selm.ts.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.selm.ts.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.selm.ts.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.selm.ts.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.selm.ts.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.selm.ts.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.selm.ts.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.selm.ts.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.1999.emep <- readRDS("wr.sf.1999.selm.ts_emep.rds") %>% select(selected.vars)
wr.sf.1999.emep$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.selm.ts.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.selm.ts.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999.emep) %>% 
              rbind(wr.sf.2009) %>% rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.selm.ts.rds")
saveRDS(wr.exp, "wr.exp.selm.ts.rds")
```

```{r plot-exp-selm-ts}
wr.exp <- readRDS("wr.exp.selm.ts.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export, na.rm = T), TOC = mean(TOC.fit, na.rm = T))


basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, "SELM, forest + logRunoff + TSdep")

# ggplot(basins.exp, aes(x=year, y = TOC, col = sea))+geom_point()+
#   geom_line(aes(group = sea))+
#   scale_color_brewer(palette = "Accent")+
#   labs(y = "Predicted TOC concentration, mg/L", title = "SELM, forest + logRunoff + TSdep")+
#   theme_minimal()
# ggplot(basins.exp, aes(x=year, y = yearlyTOC.Tg, col = sea))+geom_point()+
#   geom_line(aes(group = sea))+
#     scale_color_brewer(palette = "Accent")+
#   labs(y = "Yearly export of TOC, Tg", title = "SELM, forest + logRunoff + TSdep")+
#   theme_minimal()


```

## Comparison with historical data

```{r compare-swedish-selm-ts}
merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.selm.ts.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, "SELM, forest + logRunoff + TSdep")

# for(i in unique(total$gid)){
# g <- ggplot(filter(total, gid == i))+
#   geom_point(aes(x = Year, y = TOC, col = Name), size = 0.5)+
#   #geom_line(aes(x = Year, y = TOC, col = Name, group = Name), lty = 2)+
#   geom_point(aes(x = decade, y = TOC.obs), col = "mediumaquamarine")+
#   geom_line(aes(x = decade, y = TOC.obs, group = gid), col = "mediumaquamarine", lty = 1)+
#   geom_point(aes(x = as.numeric(year), y = TOC.fit), col = "firebrick")+
#   geom_line(aes(x = as.numeric(year), y = TOC.fit, group = gid), col = "firebrick", lty = 1)+
#   labs(x = "", y = "TOC, mg/L", title = i, col = "River")+
#   scale_color_brewer(palette = "Dark2")+
#   expand_limits(x = 2029)+
#   #facet_grid(cols = vars(Name))+
#   theme_minimal()+theme(legend.position = "none")
# h <- ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid == i))+geom_sf(data = filter(st_as_sf(total), gid == i), aes(color = Name))+
#   borders(regions = "Sweden")+scale_color_brewer(palette = "Dark2")+labs(color = "River")+theme_void()+theme(legend.position = "bottom")
# ggpubr::ggarrange(g,h, widths = c(2,1)) %>% print()
# }

```




# Predict TOC, SELM forest + Runoff + logTSdep*latitude

## Predict by decade

```{r load-model}
toc_model <- readRDS("sem.fen.log.lat.rds")
```

```{r predict-1899, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff %>% log10()
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899, wr.kmat)[,1]
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.rds")
```

```{r predict-1909, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds")  %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60
wr.sf.1909$logRunoff <- wr.sf.1909$Runoff %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909, wr.kmat)[,1]
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.rds")
```

```{r predict-1919, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60
wr.sf.1919$logRunoff <- wr.sf.1919$Runoff %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919, wr.kmat)[,1]
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.rds")
```

```{r predict-1929, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60
wr.sf.1929$logRunoff <- wr.sf.1929$Runoff %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929, wr.kmat)[,1]
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.rds")
```

```{r predict-1939, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60
wr.sf.1939$logRunoff <- wr.sf.1939$Runoff %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939, wr.kmat)[,1]
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.rds")
```

```{r predict-1949, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60
wr.sf.1949$logRunoff <- wr.sf.1949$Runoff %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949, wr.kmat)[,1]
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.rds")
```

```{r predict-1959, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60
wr.sf.1959$logRunoff <- wr.sf.1959$Runoff %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959, wr.kmat)[,1]
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.rds")
```

```{r predict-1969, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- wr.sf.1969$Runoff %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969, wr.kmat)[,1]
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.rds")
```

```{r predict-1979, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60
wr.sf.1979$logRunoff <- wr.sf.1979$Runoff %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979, wr.kmat)[,1]
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.rds")
```

```{r predict-1989, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60
wr.sf.1989$logRunoff <- wr.sf.1989$Runoff %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989, wr.kmat)[,1]
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.rds")
```

```{r predict-1999, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- wr.sf.1999$Runoff %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999, wr.kmat)[,1]
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.rds")
```

```{r predict-1999-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- wr.sf.1999$Runoff %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999, wr.kmat)[,1]
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999_emep.rds")
```

```{r predict-2009, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- wr.sf.2009$Runoff %>% log10()
wr.sf.2009$TSdep <- wr.sf.2009$tsdep 
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009, wr.kmat)[,1]
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.rds")
```

```{r predict-2019, eval = F}

forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- wr.sf.2019$Runoff %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019, wr.kmat)[,1]
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.rds")
```


## Compare exports

```{r common, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","TSdep","Runoff","forest","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.1999.emep <- readRDS("wr.sf.1999_emep.rds") %>% select(selected.vars)
wr.sf.1999.emep$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999.emep) %>% 
              rbind(wr.sf.2009) %>% rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.rds")
saveRDS(wr.exp, "wr.exp.rds")
```

```{r plot-exp}
wr.exp <- readRDS("wr.exp.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export, na.rm = T), TOC = mean(TOC.fit, na.rm = T))

basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, main.title = "SELM, forest + logRunoff + logTSdep * latitude") 

```

```{r compare-swedish-selm}
merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, main.title = "SELM, forest + logRunoff + logTSdep * latitude")

```




# Predict TOC, SELM with forest * logRunoff * TSdep
 
## Prediction by decade


```{r load-selm-itr}
toc_model <- readRDS("sem.fen.itr.rds")
```

```{r predict-1899-selm-itr, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.selm.itr.rds")
```

```{r predict-1909-selm-itr, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.selm.itr.rds")
```

```{r predict-1919-selm-itr, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.selm.itr.rds")
```

```{r predict-1929-selm-itr, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.selm.itr.rds")
```

```{r predict-1939-selm-itr, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.selm.itr.rds")
```

```{r predict-1949-selm-itr, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.selm.itr.rds")
```

```{r predict-1959-selm-itr, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.selm.itr.rds")
```

```{r predict-1969-selm-itr, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.selm.itr.rds")
```

```{r predict-1979-selm-itr, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.selm.itr.rds")
```

```{r predict-1989-selm-itr, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.selm.itr.rds")
```

```{r predict-1999-selm-itr, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.selm.itr.rds")
```

```{r predict-1999-lm-selm-itr-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.selm.itr.emep.rds")
```

```{r predict-2009-lm-selm-itr-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009)
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.selm.itr.rds")
```

```{r predict-2019-lm-selm-itr-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019)
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.selm.itr.rds")
```

## Compare exports

```{r common-selm-itr, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.selm.itr.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.selm.itr.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.selm.itr.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.selm.itr.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.selm.itr.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.selm.itr.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.selm.itr.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.selm.itr.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.selm.itr.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.selm.itr.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.selm.itr.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.selm.itr.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.selm.itr.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.selm.itr.rds")
saveRDS(wr.exp, "wr.exp.selm.itr.rds")
```

```{r plot-exp-selm-itr}
wr.exp <- readRDS("wr.exp.selm.itr.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, "SELM logTOC~forest*logRunoff*TSdep")
```



## Comparison with historical data


```{r compare-swedish-lm-selm-itr}
merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.selm.itr.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","TOC.decade","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, "SELM logTOC~forest*logRunoff*TSdep")

```




# Predict TOC, SELM with forest * logRunoff * logTSdep
 
## Prediction by decade


```{r load-selm-itr2}
toc_model <- readRDS("sem.fen.itr2.rds")
```

```{r predict-1899-selm-itr2, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.selm.itr2.rds")
```

```{r predict-1909-selm-itr2, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.selm.itr2.rds")
```

```{r predict-1919-selm-itr2, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.selm.itr2.rds")
```

```{r predict-1929-selm-itr2, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.selm.itr2.rds")
```

```{r predict-1939-selm-itr2, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.selm.itr2.rds")
```

```{r predict-1949-selm-itr2, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.selm.itr2.rds")
```

```{r predict-1959-selm-itr2, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.selm.itr2.rds")
```

```{r predict-1969-selm-itr2, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.selm.itr2.rds")
```

```{r predict-1979-selm-itr2, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.selm.itr2.rds")
```

```{r predict-1989-selm-itr2, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.selm.itr2.rds")
```

```{r predict-1999-selm-itr2, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.selm.itr2.rds")
```

```{r predict-1999-lm-selm-itr2-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.selm.itr2.emep.rds")
```

```{r predict-2009-lm-selm-itr2-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009)
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.selm.itr2.rds")
```

```{r predict-2019-lm-selm-itr2-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019)
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.selm.itr2.rds")
```

## Compare exports

```{r common-selm-itr2, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.selm.itr2.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.selm.itr2.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.selm.itr2.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.selm.itr2.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.selm.itr2.rds")
saveRDS(wr.exp, "wr.exp.selm.itr2.rds")
```

```{r plot-exp-selm-itr2}
wr.exp <- readRDS("wr.exp.selm.itr2.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, main.title = "SELM logTOC ~ forest * logRunoff * TSdep")

```



## Comparison with historical data


```{r compare-swedish-lm-selm-itr2}
merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.selm.itr2.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, main.title = "SELM, logTOC ~ forest * logRunoff * logTSdep")


```



# Predict TOC, LM with forest + logRunoff + logTSdep*latitude
 
## Prediction by decade


```{r load-glm-model}
toc_model <- readRDS("glm.log.rds")
```

```{r predict-1899-lat, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.lat.rds")
```

```{r predict-1909-lat, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.lat.rds")
```

```{r predict-1919-lat, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.lat.rds")
```

```{r predict-1929-lat, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.lat.rds")
```

```{r predict-1939-lat, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.lat.rds")
```

```{r predict-1949-lat, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.lat.rds")
```

```{r predict-1959-lat, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.lat.rds")
```

```{r predict-1969-lat, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.lat.rds")
```

```{r predict-1979-lat, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.lat.rds")
```

```{r predict-1989-lat, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.lat.rds")
```

```{r predict-1999-lat, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.lat.rds")
```

```{r predict-1999-lm-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.lat.emep.rds")
```

```{r predict-2009-lm-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009)
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.lat.rds")
```

```{r predict-2019-lm-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019)
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.lat.rds")
```

## Compare exports

```{r common-lat, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.lat.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.lat.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.lat.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.lat.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.lat.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.lat.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.lat.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.lat.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.lat.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.lat.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.lat.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.lat.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.lat.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.lat.rds")
saveRDS(wr.exp, "wr.exp.lat.rds")
```

```{r plot-exp-lat}
wr.exp <- readRDS("wr.exp.lat.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, "LM logTOC ~ forest + logRunoff + logTSdep*latitude")


```



## Comparison with historical data


```{r compare-swedish-lm}
merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.lat.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, main.title = "LM, logTOC ~ forest + logRunoff + logTSdep*latitude")

```

# Predict TOC, LM with forest + logRunoff + TSdep*latitude
 
## Prediction by decade


```{r load-lm-model-ts}
toc_model <- readRDS("glm.tsdep.rds")
```

```{r predict-1899-ts, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.ts.rds")
```

```{r predict-1909-ts, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.ts.rds")
```

```{r predict-1919-ts, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.ts.rds")
```

```{r predict-1929-ts, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.ts.rds")
```

```{r predict-1939-ts, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.ts.rds")
```

```{r predict-1949-ts, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.ts.rds")
```

```{r predict-1959-ts, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.ts.rds")
```

```{r predict-1969-ts, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.ts.rds")
```

```{r predict-1979-ts, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.ts.rds")
```

```{r predict-1989-ts, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.ts.rds")
```

```{r predict-1999-ts, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.ts.rds")
```

```{r predict-1999-lm-ts-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.ts.emep.rds")
```

```{r predict-2009-lm-ts-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009)
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.ts.rds")
```

```{r predict-2019-lm-ts-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019)
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.ts.rds")
```

## Compare exports

```{r common-ts, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.ts.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.ts.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.ts.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.ts.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.ts.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.ts.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.ts.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.ts.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.ts.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.ts.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.ts.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.ts.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.ts.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.ts.rds")
saveRDS(wr.exp, "wr.exp.ts.rds")
```

```{r plot-exp-ts}
wr.exp <- readRDS("wr.exp.ts.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, main.title = "LM, logTOC ~ forest + logRunoff + TSdep * latitude")

```



## Comparison with historical data


```{r compare-swedish-lm-ts}
merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.ts.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, main.title = "LM, logTOC ~ forest + logRunoff + TSdep * latitude")
```



# Predict TOC, LM with forest + logRunoff*TSdep
 
## Prediction by decade


```{r load-lm-model-r-ts}
toc_model <- readRDS("lm.r.ts.rds")
```

```{r predict-1899-r-ts, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.r.ts.rds")
```

```{r predict-1909-r-ts, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.r.ts.rds")
```

```{r predict-1919-r-ts, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.r.ts.rds")
```

```{r predict-1929-r-ts, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.r.ts.rds")
```

```{r predict-1939-r-ts, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.r.ts.rds")
```

```{r predict-1949-r-ts, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.r.ts.rds")
```

```{r predict-1959-r-ts, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.r.ts.rds")
```

```{r predict-1969-r-ts, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.r.ts.rds")
```

```{r predict-1979-r-ts, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.r.ts.rds")
```

```{r predict-1989-r-ts, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.r.ts.rds")
```

```{r predict-1999-r-ts, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.r.ts.rds")
```

```{r predict-1999-lm-r-ts-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.r.ts.emep.rds")
```

```{r predict-2009-lm-r-ts-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009)
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.r.ts.rds")
```

```{r predict-2019-lm-r-ts-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019)
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.r.ts.rds")
```

## Compare exports

```{r common-r-ts, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.r.ts.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.r.ts.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.r.ts.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.r.ts.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.r.ts.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.r.ts.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.r.ts.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.r.ts.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.r.ts.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.r.ts.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.r.ts.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.r.ts.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.r.ts.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.r.ts.rds")
saveRDS(wr.exp, "wr.exp.r.ts.rds")
```

```{r plot-exp-r-ts}
wr.exp <- readRDS("wr.exp.r.ts.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0 & !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, "LM, logTOC ~ forest + logRunoff*logTSdep")

```



## Comparison with historical data


```{r compare-swedish-lm-r-ts}
merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.r.ts.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, "LM, logTOC ~ forest + logRunoff*logTSdep")
```



# Predict TOC, LM with forest * logRunoff * TSdep
 
## Prediction by decade


```{r load-lm-itr}
toc_model <- readRDS("lm.itr.rds")
```

```{r predict-1899-itr, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.itr.rds")
```

```{r predict-1909-itr, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.itr.rds")
```

```{r predict-1919-itr, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.itr.rds")
```

```{r predict-1929-itr, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.itr.rds")
```

```{r predict-1939-itr, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.itr.rds")
```

```{r predict-1949-itr, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.itr.rds")
```

```{r predict-1959-itr, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.itr.rds")
```

```{r predict-1969-itr, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.itr.rds")
```

```{r predict-1979-itr, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.itr.rds")
```

```{r predict-1989-itr, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.itr.rds")
```

```{r predict-1999-itr, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.itr.rds")
```

```{r predict-1999-lm-itr-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.itr.emep.rds")
```

```{r predict-2009-lm-itr-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009)
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.itr.rds")
```

```{r predict-2019-lm-itr-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019)
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.itr.rds")
```

## Compare exports

```{r common-itr, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.itr.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.itr.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.itr.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.itr.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.itr.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.itr.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.itr.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.itr.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.itr.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.itr.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.itr.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.itr.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.itr.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.itr.rds")
saveRDS(wr.exp, "wr.exp.itr.rds")
```

```{r plot-exp-itr}
wr.exp <- readRDS("wr.exp.itr.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0, !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, "LM logTOC~forest*logRunoff*TSdep")

```



## Comparison with historical data


```{r compare-swedish-lm-itr}
merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.itr.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, main.title = "LM logTOC~forest*logRunoff*TSdep")

```



# Predict TOC, LM with forest * logRunoff * logTSdep
 
## Prediction by decade


```{r load-lm-itr2}
toc_model <- readRDS("lm.itr2.rds")
```

```{r predict-1899-itr2, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1899.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 24 * 60 * 60 # kg/y
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff  %>% log10() #log10
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899) # predicts TOC in ug/L
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit 
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.itr2.rds")
```

```{r predict-1909-itr2, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1909.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 24 * 60 * 60 
wr.sf.1909$logRunoff <- (wr.sf.1909$Runoff) %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909)
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.itr2.rds")
```

```{r predict-1919-itr2, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1919.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 24 * 60 * 60 
wr.sf.1919$logRunoff <- (wr.sf.1919$Runoff) %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919)
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.itr2.rds")
```

```{r predict-1929-itr2, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1929.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 24 * 60 * 60 
wr.sf.1929$logRunoff <- (wr.sf.1929$Runoff) %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929)
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit 
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.itr2.rds")
```

```{r predict-1939-itr2, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1939.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 24 * 60 * 60 
wr.sf.1939$logRunoff <- (wr.sf.1939$Runoff) %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939)
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.itr2.rds")
```

```{r predict-1949-itr2, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1949.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 24 * 60 * 60 
wr.sf.1949$logRunoff <- (wr.sf.1949$Runoff) %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949)
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.itr2.rds")
```

```{r predict-1959-itr2, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1959.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")
 
wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 24 * 60 * 60 
wr.sf.1959$logRunoff <- (wr.sf.1959$Runoff) %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959)
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.itr2.rds")
```

```{r predict-1969-itr2, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1969.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 24 * 60 * 60 
wr.sf.1969$logRunoff <- (wr.sf.1969$Runoff) %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969)
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.itr2.rds")
```

```{r predict-1979-itr2, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1979.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 24 * 60 * 60 
wr.sf.1979$logRunoff <- (wr.sf.1979$Runoff) %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979)
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.itr2.rds")
```

```{r predict-1989-itr2, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1989.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 24 * 60 * 60 
wr.sf.1989$logRunoff <- (wr.sf.1989$Runoff)  %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989)
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.itr2.rds")
```

```{r predict-1999-itr2, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60 
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 24 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.itr2.rds")
```

```{r predict-1999-lm-itr2-emep, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.1999.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.1999.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 24 * 60 * 60
wr.sf.1999$logRunoff <- (wr.sf.1999$Runoff) %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep # already mg/m2/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999)
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.itr2.emep.rds")
```

```{r predict-2009-lm-itr2-emep, eval = F}
forest <- readRDS("forest.2009.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2009.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2009.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff))

wr.sf.2009 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2009$Runoff <- wr.sf.2009$runoff * 365 * 24 * 60 * 60
wr.sf.2009$logRunoff <- (wr.sf.2009$Runoff) %>% log10()
wr.sf.2009$TSdep <-  wr.sf.2009$tsdep
wr.sf.2009$logTSdep <- log10(wr.sf.2009$TSdep)

wr.sf.2009$logTOC.fit <- predict(toc_model, newdata = wr.sf.2009)
wr.sf.2009$TOC.fit <- 10^wr.sf.2009$logTOC.fit
wr.sf.2009$TOC.export <- with(wr.sf.2009, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2009, "wr.sf.2009.itr2.rds")
```

```{r predict-2019-lm-itr2-emep, eval = F}
forest <- readRDS("forest.2019.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.2019.rds") %>% st_as_sf() %>% dplyr::select(c("gid","tsdep")) %>% st_drop_geometry()
runoff <- readRDS("runoff.2019.noresm.rds") %>% as.data.frame() %>% dplyr::select(c("gid","runoff")) %>% filter(!is.na(runoff)) %>% filter(runoff > 0)

wr.sf.2019 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.2019$Runoff <- wr.sf.2019$runoff * 365 * 24 * 60 * 60
wr.sf.2019$logRunoff <- (wr.sf.2019$Runoff) %>% log10()
wr.sf.2019$TSdep <- wr.sf.2019$tsdep
wr.sf.2019$logTSdep <- log10(wr.sf.2019$TSdep)

wr.sf.2019$logTOC.fit <- predict(toc_model, newdata = wr.sf.2019)
wr.sf.2019$TOC.fit <- 10^wr.sf.2019$logTOC.fit
wr.sf.2019$TOC.export <- with(wr.sf.2019, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.2019, "wr.sf.2019.itr2.rds")
```

## Compare exports

```{r common-itr2, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","forest","Runoff","TSdep","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.itr2.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.itr2.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.itr2.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.itr2.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.itr2.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.itr2.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.itr2.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.itr2.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.itr2.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.itr2.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.itr2.emep.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.2009 <- readRDS("wr.sf.2009.itr2.rds") %>% select(selected.vars)
wr.sf.2009$year <- "2009"

wr.sf.2019 <- readRDS("wr.sf.2019.itr2.rds") %>% select(selected.vars)
wr.sf.2019$year <- "2019"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999) %>% rbind(wr.sf.2009) %>%
              rbind(wr.sf.2019)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.itr2.rds")
saveRDS(wr.exp, "wr.exp.itr2.rds")
```

```{r plot-exp-itr2}
wr.exp <- readRDS("wr.exp.itr2.rds")

basins.exp <- wr.exp  %>% filter(Runoff > 0, !is.na(sea)) %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), forest = mean(forest), TSdep = mean(TSdep), Runoff = mean(Runoff))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

plot.export(basins.exp, "LM logTOC ~forest * logRunoff * logTSdep")

```



## Comparison with historical data


```{r compare-swedish-lm-itr2}
merged.rivers <- readRDS("merged.rivers.rds")

wr.exp <- readRDS("wr.exp.itr2.rds")

match.exp <- wr.exp %>% filter(gid %in% merged.rivers$gid) %>% merge(select(merged.rivers, c("Name","Year","decade","TOC","gid")), by = "gid") 

obs.TOC.decade <- match.exp %>% group_by(gid,decade) %>% summarise(TOC.obs = mean(TOC))

total <- merge(match.exp, obs.TOC.decade, by = c("gid","decade"))

plot.historical(total, "LM logTOC ~ forest * logRunoff * logTSdep")
```



# Maps

```{r map-toc-1899, eval = F}
map.toc.1899 <- ggplot(wr.sf.1899)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1899", fill = "TOC concentration\nin mg/L in 1899")+
  theme_void()

ggsave("map.toc.1899.png", map.toc.1899)
```

```{r map-toc-1909, eval = F}
map.toc.1909 <- ggplot(wr.sf.1909)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1909", fill = "TOC concentration\nin mg/L in 1909")+
  theme_void()

ggsave("map.toc.1909.png", map.toc.1909)
```

```{r map-toc-1919, eval = F}
map.toc.1919 <- ggplot(wr.sf.1919)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1919", fill = "TOC concentration\nin mg/L in 1919")+
  theme_void()

ggsave("map.toc.1919.png", map.toc.1919)
```

```{r map-toc-1929, eval = F}
map.toc.1929 <- ggplot(wr.sf.1929)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1929", fill = "TOC concentration\nin mg/L in 1929")+
  theme_void()

ggsave("map.toc.1929.png", map.toc.1929)
```

```{r map-toc-1939, eval = F}
map.toc.1939 <- ggplot(wr.sf.1939)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1939", fill = "TOC concentration\nin mg/L in 1939")+
  theme_void()

ggsave("map.toc.1939.png", map.toc.1939)
```


```{r map-toc-1949, eval = F}
map.toc.1949 <- ggplot(wr.sf.1949)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1949", fill = "TOC concentration\nin mg/L in 1949")+
  theme_void()

ggsave("map.toc.1949.png", map.toc.1949)
```

```{r map-toc-1959, eval = F}
map.toc.1959 <- ggplot(wr.sf.1959)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1959", fill = "TOC concentration\nin mg/L in 1959")+
  theme_void()

ggsave("map.toc.1959.png", map.toc.1959)
```



```{r map-toc-1969, eval = F}
map.toc.1969 <- ggplot(wr.sf.1969)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1969", fill = "TOC concentration\nin mg/L in 1969")+
  theme_void()

ggsave("map.toc.1969.png", map.toc.1969)
```

```{r map-toc-1979, eval = F}
map.toc.1979 <- ggplot(wr.sf.1979)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1979", fill = "TOC concentration\nin mg/L in 1979")+
  theme_void()

ggsave("map.toc.1979.png", map.toc.1979)
```

```{r map-toc-1989, eval = F}
map.toc.1989 <- ggplot(wr.sf.1989)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1989", fill = "TOC concentration\nin mg/L in 1989")+
  theme_void()

ggsave("map.toc.1989.png", map.toc.1989)
```

```{r map-toc-1999, eval = F}
map.toc.1999 <- ggplot(wr.sf.1999)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1999", fill = "TOC concentration\nin mg/L in 1999")+
  theme_void()

ggsave("map.toc.1999.png", map.toc.1999)
```


```{r eriksson-sem, eval = F}

rivers <- st_read("rivers_sweden.shp")
rivers_swe <- readxl::read_xlsx("Rivers Sweden.xlsx")

sf_use_s2(FALSE)
match <- st_join(rivers,wr.sf.wgs84, st_within) %>% merge(select(rivers_swe, c("river_name","closest_year", "DOC_mg.L")), by = "river_name")

ggplot()+geom_sf(data = filter(wr.sf.wgs84, gid %in% match$gid))+geom_sf(data = rivers, aes(color = River))
#ggplot()+geom_sf(data = wr.sf.wgs84)+geom_sf(data = rivers, col = "firebrick")+xlim(11.5,24)+ylim(57,69)
#ggplot()+geom_sf(data = wr.sf.wgs84)+geom_sf(data = rivers, col = "firebrick")+xlim(11.5,20)+ylim(62,64)

wr.exp <- readRDS("wr.exp.rds")

match.exp <- wr.exp %>% filter(gid %in% match$gid) %>% merge(select(match, c("River","gid")), by = "gid")

ggplot(match.exp, aes(x=year, y = TOC.fit, col = River))+geom_point()+
  geom_line(aes(group = River))+
  ylab("TOC, mg/L")+
  geom_dl(aes(label = River), method = "last.points", position = "dodge2")+ #position_jitterdodge(jitter.width = 0.5, jitter.height = 0.5, dodge.width = 0.1, seed = 54) , 41, 54
  expand_limits(x = c("2009","2019"), y = c(0,12))+
 # geom_point(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River), shape = 2)+
  theme_minimal()+
  theme(legend.position = "none")

ggplot()+
  geom_point(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River))+
  geom_line(data = match, aes(x = as.character(closest_year), y = DOC_mg.L, col = River, group = River), lty = 2)+
  geom_point(data = filter(match.exp, year %in% c("1919","1989")), aes(x = year, y = TOC.fit, col = River))+
  geom_line(data = filter(match.exp, year %in% c("1919","1989")), aes(x = year, y = TOC.fit, col = River, group = River), lty = 1)+
  labs(x = "", y = "TOC, mg/L")+
  facet_grid(cols = vars(River))+
  theme_minimal()+theme(legend.position = "none")
```