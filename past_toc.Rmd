---
title: "past_data"
date: "2023-04-21"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, error = F, fig.align = "center", collapse = T)
options(knitr.kable.NA="", knitr.table.format = "html")
```

```{r libraries}
library(raster)
library(sf)
library(dplyr)
library(ggplot2)
library(colorspace)


library(spdep)
library(spatialreg)
```

# Extract past data

```{r wr}
wr.sf <- readRDS("wr.sf.rds")
```

```{r explore-wr}
wr.sf.wgs84 <- st_transform(wr.sf, st_crs(4326))

ggplot(slice_sample(wr.sf.wgs84, n = 50, weight_by = area))+
  borders(regions = c("Norway", "Sweden","Finland"))+
  geom_sf_label(aes(label = gid), size = 2, fill = "white", col = "red", check_overlap = T)+
  xlim(0,35)+ylim(53,73)+theme_void()

```
Selected wr:

* Oslo fjord: 24085
* West Norway: 157966
* North Norway: 29877
* South Sweden: 28116
* Est Sweden: 261558
* Central Sweden: 98655
* Northern Sweden: 38747
* South Finland: 127449
* East Finland: 73788
* North Finland: 16728

## HILDA

HILDA data are downloaded from https://www.wur.nl/en/research-results/chair-groups/environmental-sciences/laboratory-of-geo-information-science-and-remote-sensing/models/hilda/hilda-data-downloads.html

Hilda categories:

* 77: Water
* 66: Other land
* 55: Grass/schrubland
* 45: Forest, mixed
* 44: Forest, deciduous broad leaf
* 43: Forest: deciduous needle
* 42: Forest, evergreen borad leaf
* 41: Forest, evergreen needle
* 40: Forest, other
* 33: Pasture
* 22: Cropland
* 11: Urban

```{r extract-data-hilda-1899, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 1)

hilda.1899 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1899, "hilda.1899.wr.rds")

hilda.1899 <- readRDS("hilda.1899.wr.rds")
hilda.tab <- sapply(hilda.1899, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1899.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1899.rds")
```

```{r extract-data-hilda-1909, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 2)

hilda.1909 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1909, "hilda.1909.wr.rds")

hilda.1909 <- readRDS("hilda.1909.wr.rds")
hilda.tab <- sapply(hilda.1909, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1909.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1909.rds")
```

```{r extract-data-hilda-1919, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 3)

hilda.1919 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1919, "hilda.1919.wr.rds")

hilda.1919 <- readRDS("hilda.1919.wr.rds")
hilda.tab <- sapply(hilda.1919, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
saveRDS(hilda.tab.prop,"hilda.1919.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1919.rds")
```

```{r extract-data-hilda-1929, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 4)

hilda.1929 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1929, "hilda.1929.wr.rds")

hilda.1929 <- readRDS("hilda.1929.wr.rds")
hilda.tab <- sapply(hilda.1929, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
saveRDS(hilda.tab.prop,"hilda.1929.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid

saveRDS(forest,"forest.1929.rds")
```

```{r extract-data-hilda-1939, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 5)

hilda.1939 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1939, "hilda.1939.wr.rds")

hilda.1939 <- readRDS("hilda.1939.wr.rds")
hilda.tab <- sapply(hilda.1939, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
saveRDS(hilda.tab.prop,"hilda.1939.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1939.rds")
```

```{r extract-data-hilda-1949, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 6)

hilda.1949 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1949, "hilda.1949.wr.rds")

hilda.1949 <- readRDS("hilda.1949.wr.rds")
hilda.tab <- sapply(hilda.1949, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1949.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1949.rds")
```

```{r extract-data-hilda-1959, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 7)

hilda.1959 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1959, "hilda.1959.wr.rds")

hilda.1959 <- readRDS("hilda.1959.wr.rds")
hilda.tab <- sapply(hilda.1959, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1959.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1959.rds")
```

```{r extract-data-hilda-1969, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 8)

hilda.1969 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1969, "hilda.1969.wr.rds")

hilda.1969 <- readRDS("hilda.1969.wr.rds")
hilda.tab <- sapply(hilda.1969, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1969.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid

saveRDS(forest,"forest.1969.rds")
```

```{r extract-data-hilda-1979, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 9)

hilda.1979 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1979, "hilda.1979.wr.rds")

hilda.1979 <- readRDS("hilda.1979.wr.rds")
hilda.tab <- sapply(hilda.1979, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1979.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1979.rds")
```

```{r extract-data-hilda-1989, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 10)

hilda.1989 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1989, "hilda.1989.wr.rds")


hilda.1989 <- readRDS("hilda.1989.wr.rds")
hilda.tab <- sapply(hilda.1989, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1989.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1989.rds")
```

```{r extract-data-hilda-1999, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 11)

hilda.1999 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.1999, "hilda.1999.wr.rds")

hilda.1999 <- readRDS("hilda.1999.wr.rds")
hilda.tab <- sapply(hilda.1999, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.1999.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.1999.rds")
```

```{r extract-data-hilda-2009, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 12)

hilda.2009 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.2009, "hilda.2009.wr.rds")

hilda.2009 <- readRDS("hilda.2009.wr.rds")
hilda.tab <- sapply(hilda.2009, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.2009.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest") 
forest$gid <- wr.sf$gid

saveRDS(forest,"forest.2009.rds")
```

```{r extract-data-hilda-2019, eval = F}
hilda.raster <- "HILDA_plus_decadal.nc" %>% raster(band = 13)

hilda.2019 <- raster::extract(hilda.raster, wr.sf)

saveRDS(hilda.2019, "hilda.2019.wr.rds")

hilda.2019 <- readRDS("hilda.2019.wr.rds")
hilda.tab <- sapply(hilda.2019, function(x) tabulate(x,77))
hilda.tab.area <- hilda.tab*prod(res(hilda.raster))
catchment.area <- colSums(hilda.tab.area)
hilda.tab.prop <- sweep(hilda.tab.area,2,catchment.area, FUN = "/")
names(hilda.tab.prop) <- wr.sf$gid
saveRDS(hilda.tab.prop,"hilda.2019.tab.prop.Rdata")

forest <- colSums(hilda.tab.prop[c(40,41,42,43,44,45),]) %>% as.data.frame() %>% setNames("forest")
forest$gid <- wr.sf$gid
saveRDS(forest,"forest.2019.rds")
```

## Sdep

 Annual mean deposition in kg/m2/s, averaged in the water drainage basins polygons.
 
```{r load-wr-s, eval = F}
wr.sf <- readRDS("wr.sf.rds")
```

```{r extract-sulfur-1899, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(589:600)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(589:600)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(589:600)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(589:600)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1899.rds")
```

```{r extract-sulfur-1909, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(709:720)) %>% mean()
dryso4 <- raster::stak("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(709:720)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(709:720)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(709:720)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1909.rds")
```

```{r extract-sulfur-1919, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(829:840)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(829:840)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(829:840)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(829:840)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1919.rds")
```

```{r extract-sulfur-1929, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(949:960)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(949:960)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(949:960)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(949:960)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1929.rds")
```

```{r extract-sulfur-1939, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1069:1080)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1069:1080)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1069:1080)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1069:1080)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1939.rds")
```

```{r extract-sulfur-1949, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1189:1200)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1189:1200)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1189:1200)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1189:1200)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1949.rds")
```

```{r extract-sulfur-1959, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1309:1320)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1309:1320)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1309:1320)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1309:1320)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1959.rds")
```

```{r extract-sulfur-1969, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1429:1440)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1429:1440)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1429:1440)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1429:1440)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1969.rds")
```

```{r extract-sulfur-1979, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1549:1560))
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1549:1560)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1549:1560)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1549:1560)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1979.rds")
```

```{r extract-sulfur-1989, eval = F}
dryso2 <- raster::stack("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1669:1680)) %>% mean()
dryso4 <- raster::stack("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1669:1680)) %>% mean()
wetso2 <- raster::stack("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1669:1680)) %>% mean()
wetso4 <- raster::stack("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc", bands = c(1669:1680)) %>% mean()

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1989.rds")
```

```{r extract-sulfur-1999, eval = F}
dryso2 <- raster("Sdep/dryso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1789:1800))
dryso4 <- raster("Sdep/dryso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1789:1800))
wetso2 <- raster("Sdep/wetso2_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1789:1800))
wetso4 <- raster("Sdep/wetso4_aero_NorESM1-ME_historical_r1i1p1_185001-200512.nc") %>% stack(bands = c(1789:1800))

dryso2.df <- extract(dryso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso2.df) <- c("gid","area","dso2")
dryso4.df <- extract(dryso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(dryso4.df) <- c("gid","area","dso4")
wetso2.df <- extract(wetso2, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso2.df) <- c("gid","area","wso2")
wetso4.df <- extract(wetso4, wr.sf, sp = T, df = T, na.rm = T, fun = mean)
names(wetso4.df) <- c("gid","area","wso4")

sdep.df <- merge(dryso2.df, dryso4.df, by = "gid") %>% merge(wetso2.df, by = "gid") %>% merge(wetso4.df, by = c("gid","area"))
sdep.df$tsdep <- rowSums(sdep.df@data[,c(3:6)])

saveRDS(sdep.df, "sdep.df.1999.rds")
```

Does not exist for 2009. EMEP?

## Runoff


```{r load-wr, eval = F}
wr.sf <- readRDS("wr.sf.rds")
```

```{r runoff-1899, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(409:780)) # Correspond to January 1970 to December 2000
runoff.mean <- runoff.stack %>% mean() 

runoff.1899 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1899) <- c("gid","runoff")
saveRDS(runoff.1899,"runoff.1899.rds")
```

```{r runoff-1909, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(529:900)) # Correspond to January 1970 to December 2000
runoff.mean <- runoff.stack %>% mean() 

runoff.1909 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1909) <- c("gid","runoff")
saveRDS(runoff.1909,"runoff.1909.rds")
```

```{r runoff-1919, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(649:1020)) # Correspond to January 1970 to December 2000
runoff.mean <- runoff.stack %>% mean() 

runoff.1919 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1919) <- c("gid","runoff")
saveRDS(runoff.1919,"runoff.1919.rds")
```

```{r runoff-1929, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(769:1140)) # Correspond to January 1970 to December 2000
runoff.mean <- runoff.stack %>% mean() 

runoff.1929 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1929) <- c("gid","runoff")
saveRDS(runoff.1929,"runoff.1929.rds")
```

```{r runoff-1939, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(889:1260)) # Correspond to January 1970 to December 2000
runoff.mean <- runoff.stack %>% mean() 

runoff.1939 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1939) <- c("gid","runoff")
saveRDS(runoff.1939,"runoff.1939.rds")
```

```{r runoff-1949, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1009:1380)) # Correspond to January 1970 to December 2000
runoff.mean <- runoff.stack %>% mean() 

runoff.1949 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1949) <- c("gid","runoff")
saveRDS(runoff.1949,"runoff.1949.rds")
```

```{r runoff-1959, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1129:1500))
runoff.mean <- runoff.stack %>% mean() 

runoff.1959 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1959) <- c("gid","runoff")
saveRDS(runoff.1959,"runoff.1959.rds")
```

```{r runoff-1969, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1249:1620)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1969 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1969) <- c("gid","runoff")
saveRDS(runoff.1969,"runoff.1969.rds")
```

```{r runoff-1979, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1369:1740)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1979 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1979) <- c("gid","runoff")
saveRDS(runoff.1979,"runoff.1979.rds")
```

```{r runoff-1989, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1489:1860)) 
runoff.mean <- runoff.stack %>% mean() 

runoff.1989 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1989) <- c("gid","runoff")
saveRDS(runoff.1989,"runoff.1989.rds")
```

```{r runoff-1999, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1609:1872)) # no later than 1872 = 2005
runoff.mean <- runoff.stack %>% mean() 

runoff.1989 <- raster::extract(runoff.mean, wr.sf, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.1989) <- c("gid","runoff")
saveRDS(runoff.1989,"runoff.1989.rds")
```

# Predict TOC

```{r load-model}
toc_model <- readRDS("sem.fen.log.lat.rds")
wr.sf <- readRDS("wr.sf.rds")

sf_use_s2(FALSE)
wr.centroid <- st_centroid(wr.sf) %>% st_transform(st_crs(4326))
wr.sf$latitude <- st_coordinates(wr.centroid)[,2]

lims <- c(0,20)

```

```{r wr.kmat, eval = F}
wr.spdf <- SpatialPointsDataFrame(st_coordinates(st_centroid(wr.sf)), st_drop_geometry(wr.sf))
wr.kmat <- knearneigh(wr.spdf, k = 100) %>% knn2nb() %>% nb2listw()
saveRDS(wr.kmat, "wr.kmat.rds")
```

```{r predict-1899, eval = F}
forest <- readRDS("forest.1899.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1899.rds")
runoff <- readRDS("runoff.1899.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1899 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1899$Runoff <- wr.sf.1899$runoff * 365 * 60 * 60
wr.sf.1899$logRunoff <- wr.sf.1899$Runoff %>% log10()
wr.sf.1899$TSdep <- wr.sf.1899$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1899$logTSdep <- log10(wr.sf.1899$TSdep)

wr.sf.1899$logTOC.fit <- predict(toc_model, newdata = wr.sf.1899, wr.kmat)[,1]
wr.sf.1899$TOC.fit <- 10^wr.sf.1899$logTOC.fit
wr.sf.1899$TOC.export <- with(wr.sf.1899, TOC.fit* Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1899, "wr.sf.1899.rds")
```

```{r map-toc-1899, eval = F}
map.toc.1899 <- ggplot(wr.sf.1899)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1899", fill = "TOC concentration\nin mg/L in 1899")+
  theme_void()

ggsave("map.toc.1899.png", map.toc.1899)
```

```{r predict-1909, eval = F}
forest <- readRDS("forest.1909.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1909.rds")
runoff <- readRDS("runoff.1909.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1909 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1909$Runoff <- wr.sf.1909$runoff * 365 * 60 * 60
wr.sf.1909$logRunoff <- wr.sf.1909$Runoff %>% log10()
wr.sf.1909$TSdep <- wr.sf.1909$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1909$logTSdep <- log10(wr.sf.1909$TSdep)

wr.sf.1909$logTOC.fit <- predict(toc_model, newdata = wr.sf.1909, wr.kmat)[,1]
wr.sf.1909$TOC.fit <- 10^wr.sf.1909$logTOC.fit
wr.sf.1909$TOC.export <- with(wr.sf.1909, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1909, "wr.sf.1909.rds")
```

```{r map-toc-1909, eval = F}
map.toc.1909 <- ggplot(wr.sf.1909)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1909", fill = "TOC concentration\nin mg/L in 1909")+
  theme_void()

ggsave("map.toc.1909.png", map.toc.1909)
```

```{r predict-1919, eval = F}
forest <- readRDS("forest.1919.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1919.rds")
runoff <- readRDS("runoff.1919.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1919 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1919$Runoff <- wr.sf.1919$runoff * 365 * 60 * 60
wr.sf.1919$logRunoff <- wr.sf.1919$Runoff %>% log10() 
wr.sf.1919$TSdep <- wr.sf.1919$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1919$logTSdep <- log10(wr.sf.1919$TSdep)

wr.sf.1919$logTOC.fit <- predict(toc_model, newdata = wr.sf.1919, wr.kmat)[,1]
wr.sf.1919$TOC.fit <- 10^wr.sf.1919$logTOC.fit
wr.sf.1919$TOC.export <- with(wr.sf.1919, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1919, "wr.sf.1919.rds")
```

```{r map-toc-1919, eval = F}
map.toc.1919 <- ggplot(wr.sf.1919)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1919", fill = "TOC concentration\nin mg/L in 1919")+
  theme_void()

ggsave("map.toc.1919.png", map.toc.1919)
```

```{r predict-1929, eval = F}
forest <- readRDS("forest.1929.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1929.rds")
runoff <- readRDS("runoff.1929.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1929 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1929$Runoff <- wr.sf.1929$runoff * 365 * 60 * 60
wr.sf.1929$logRunoff <- wr.sf.1929$Runoff %>% log10()
wr.sf.1929$TSdep <- wr.sf.1929$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1929$logTSdep <- log10(wr.sf.1929$TSdep)

wr.sf.1929$logTOC.fit <- predict(toc_model, newdata = wr.sf.1929, wr.kmat)[,1]
wr.sf.1929$TOC.fit <- 10^wr.sf.1929$logTOC.fit
wr.sf.1929$TOC.export <- with(wr.sf.1929, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1929, "wr.sf.1929.rds")
```

```{r map-toc-1929, eval = F}
map.toc.1929 <- ggplot(wr.sf.1929)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1929", fill = "TOC concentration\nin mg/L in 1929")+
  theme_void()

ggsave("map.toc.1929.png", map.toc.1929)
```

```{r predict-1939, eval = F}
forest <- readRDS("forest.1939.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1939.rds")
runoff <- readRDS("runoff.1939.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1939 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1939$Runoff <- wr.sf.1939$runoff * 365 * 60 * 60
wr.sf.1939$logRunoff <- wr.sf.1939$Runoff %>% log10()
wr.sf.1939$TSdep <- wr.sf.1939$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1939$logTSdep <- log10(wr.sf.1939$TSdep)

wr.sf.1939$logTOC.fit <- predict(toc_model, newdata = wr.sf.1939, wr.kmat)[,1]
wr.sf.1939$TOC.fit <- 10^wr.sf.1939$logTOC.fit
wr.sf.1939$TOC.export <- with(wr.sf.1939, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1939, "wr.sf.1939.rds")
```

```{r map-toc-1939, eval = F}
map.toc.1939 <- ggplot(wr.sf.1939)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1939", fill = "TOC concentration\nin mg/L in 1939")+
  theme_void()

ggsave("map.toc.1939.png", map.toc.1939)
```

```{r predict-1949, eval = F}
forest <- readRDS("forest.1949.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1949.rds")
runoff <- readRDS("runoff.1949.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1949 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1949$Runoff <- wr.sf.1949$runoff * 365 * 60 * 60
wr.sf.1949$logRunoff <- wr.sf.1949$Runoff %>% log10()
wr.sf.1949$TSdep <- wr.sf.1949$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1949$logTSdep <- log10(wr.sf.1949$TSdep)

wr.sf.1949$logTOC.fit <- predict(toc_model, newdata = wr.sf.1949, wr.kmat)[,1]
wr.sf.1949$TOC.fit <- 10^wr.sf.1949$logTOC.fit
wr.sf.1949$TOC.export <- with(wr.sf.1949, TOC.fit*Runoff * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1949, "wr.sf.1949.rds")
```

```{r map-toc-1949, eval = F}
map.toc.1949 <- ggplot(wr.sf.1949)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1949", fill = "TOC concentration\nin mg/L in 1949")+
  theme_void()

ggsave("map.toc.1949.png", map.toc.1949)
```

```{r predict-1959, eval = F}
forest <- readRDS("forest.1959.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1959.rds")
runoff <- readRDS("runoff.1959.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1959 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1959$Runoff <- wr.sf.1959$runoff * 365 * 60 * 60
wr.sf.1959$logRunoff <- wr.sf.1959$Runoff %>% log10()
wr.sf.1959$TSdep <- wr.sf.1959$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1959$logTSdep <- log10(wr.sf.1959$TSdep)

wr.sf.1959$logTOC.fit <- predict(toc_model, newdata = wr.sf.1959, wr.kmat)[,1]
wr.sf.1959$TOC.fit <- 10^wr.sf.1959$logTOC.fit
wr.sf.1959$TOC.export <- with(wr.sf.1959, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1959, "wr.sf.1959.rds")
```

```{r map-toc-1959, eval = F}
map.toc.1959 <- ggplot(wr.sf.1959)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1959", fill = "TOC concentration\nin mg/L in 1959")+
  theme_void()

ggsave("map.toc.1959.png", map.toc.1959)
```

```{r predict-1969, eval = F}
forest <- readRDS("forest.1969.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1969.rds")
runoff <- readRDS("runoff.1969.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1969 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1969$Runoff <- wr.sf.1969$runoff * 365 * 60 * 60 
wr.sf.1969$logRunoff <- wr.sf.1969$Runoff %>% log10()
wr.sf.1969$TSdep <- wr.sf.1969$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1969$logTSdep <- log10(wr.sf.1969$TSdep)

wr.sf.1969$logTOC.fit <- predict(toc_model, newdata = wr.sf.1969, wr.kmat)[,1]
wr.sf.1969$TOC.fit <- 10^wr.sf.1969$logTOC.fit
wr.sf.1969$TOC.export <- with(wr.sf.1969, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1969, "wr.sf.1969.rds")
```

```{r map-toc-1969, eval = F}
map.toc.1969 <- ggplot(wr.sf.1969)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1969", fill = "TOC concentration\nin mg/L in 1969")+
  theme_void()

ggsave("map.toc.1969.png", map.toc.1969)
```

```{r predict-1979, eval = F}
forest <- readRDS("forest.1979.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1979.rds")
runoff <- readRDS("runoff.1979.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1979 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1979$Runoff <- wr.sf.1979$runoff * 365 * 60 * 60
wr.sf.1979$logRunoff <- wr.sf.1979$Runoff %>% log10()
wr.sf.1979$TSdep <- wr.sf.1979$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1979$logTSdep <- log10(wr.sf.1979$TSdep)

wr.sf.1979$logTOC.fit <- predict(toc_model, newdata = wr.sf.1979, wr.kmat)[,1]
wr.sf.1979$TOC.fit <- 10^wr.sf.1979$logTOC.fit
wr.sf.1979$TOC.export <- with(wr.sf.1979, TOC.fit*Runoff * area) # mg/L * kg/m2/s * m2 -> mg/year

saveRDS(wr.sf.1979, "wr.sf.1979.rds")
```

```{r map-toc-1979, eval = F}
map.toc.1979 <- ggplot(wr.sf.1979)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1979", fill = "TOC concentration\nin mg/L in 1979")+
  theme_void()

ggsave("map.toc.1979.png", map.toc.1979)
```

```{r predict-1989, eval = F}
forest <- readRDS("forest.1989.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1989.rds")
runoff <- readRDS("runoff.1989.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1989 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1989$Runoff <- wr.sf.1989$runoff * 365 * 60 * 60
wr.sf.1989$logRunoff <- wr.sf.1989$Runoff %>% log10()
wr.sf.1989$TSdep <- wr.sf.1989$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1989$logTSdep <- log10(wr.sf.1989$TSdep)

wr.sf.1989$logTOC.fit <- predict(toc_model, newdata = wr.sf.1989, wr.kmat)[,1]
wr.sf.1989$TOC.fit <- 10^wr.sf.1989$logTOC.fit
wr.sf.1989$TOC.export <- with(wr.sf.1989, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1989, "wr.sf.1989.rds")
```

```{r map-toc-1989, eval = F}
map.toc.1989 <- ggplot(wr.sf.1989)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1989", fill = "TOC concentration\nin mg/L in 1989")+
  theme_void()

ggsave("map.toc.1989.png", map.toc.1989)
```

```{r predict-1999, eval = F}
forest <- readRDS("forest.1999.rds") %>% filter(!is.na(forest))

sdep <- readRDS("sdep.df.1999.rds")
runoff <- readRDS("runoff.1999.wr.rds") %>% as.data.frame() %>% filter(!is.na(runoff))

wr.sf.1999 <- merge(wr.sf, forest, by = "gid") %>% merge(sdep, by = "gid") %>% merge(runoff, by = "gid")

wr.sf.1999$Runoff <- wr.sf.1999$runoff * 365 * 60 * 60
wr.sf.1999$logRunoff <- wr.sf.1999$Runoff %>% log10()
wr.sf.1999$TSdep <- wr.sf.1999$tsdep * (-1) * 365 * 60 * 60 * 1e6 # converts to mg/year
wr.sf.1999$logTSdep <- log10(wr.sf.1999$TSdep)

wr.sf.1999$logTOC.fit <- predict(toc_model, newdata = wr.sf.1999, wr.kmat)[,1]
wr.sf.1999$TOC.fit <- 10^wr.sf.1999$logTOC.fit
wr.sf.1999$TOC.export <- with(wr.sf.1999, TOC.fit*Runoff  * area) # mg/L * kg/m2/y * m2 -> mg/year

saveRDS(wr.sf.1999, "wr.sf.1999.rds")
```

```{r map-toc-1999, eval = F}
map.toc.1999 <- ggplot(wr.sf.1999)+geom_sf(aes(fill = TOC.fit, col = TOC.fit))+
   scale_colour_continuous_divergingx(palette = "RdYlBu", aesthetics = c("col","fill"), mid = 10, rev = T, limits = lims, na.value = "black")+
  labs(col = "TOC concentration\nin mg/L in 1999", fill = "TOC concentration\nin mg/L in 1999")+
  theme_void()

ggsave("map.toc.1999.png", map.toc.1999)
```

For 2009 and 2019: Need to download data from EMEP and fit a model on NLS with EMEP data

# Compare exports

```{r create-import basins}
basins <- st_read("basins_all_sea.shp") %>% st_cast("POLYGON")
st_crs(basins) <- st_crs(4326)
basins$sea <- with(basins, ifelse(Poly %in% c(1:161), "Baltic",
                                  ifelse(Poly %in% c(162:253), "North",
                                    "NCC")))
wr.basins <- st_join(wr.centroid, basins, st_join = st_within)

ggplot()+ geom_sf(data = basins, aes(col = sea), fill = NA)+geom_sf(data = wr.basins, aes(col = sea, size = area))

# wr.sf.mercator <- st_transform(wr.sf, st_crs(4326))
# ggplot() + geom_sf(data = head(wr.sf.mercator,100), col = "black")
# wr.coords <- st_coordinates(wr.sf.mercator)
# 
# sf_use_s2(FALSE)
# test <- st_join(st_centroid(wr.sf.mercator, of), basins, join = st_within)
# ggplot()+geom_sf(data = test, aes(fill = sea, color = sea, size = area), na.value = "black")+
#   geom_sf(data = basins, aes(col = sea), fill = NA)+
#   ylim(55,71)
# 
# test2 <- merge(wr.sf.mercator, st_drop_geometry(test), by = c("gid","area"))
# ggplot()+geom_sf(data = test2, aes(fill = sea, color = sea), na.value = "black")+
#   geom_sf(data = basins, aes(col = sea), fill = NA)+
#   ylim(55,71)
```

```{r common, eval = F}
selected.vars <- c("gid","TOC.fit","TOC.export","TSdep","Runoff","forest","geometry")

wr.sf.1899 <- readRDS("wr.sf.1899.rds") %>% select(selected.vars)
wr.sf.1899$year <- "1899"

wr.sf.1909 <- readRDS("wr.sf.1909.rds") %>% select(selected.vars)
wr.sf.1909$year <- "1909"

wr.sf.1919 <- readRDS("wr.sf.1919.rds") %>% select(selected.vars)
wr.sf.1919$year <- "1919"

wr.sf.1929 <- readRDS("wr.sf.1929.rds") %>% select(selected.vars)
wr.sf.1929$year <- "1929"

wr.sf.1939 <- readRDS("wr.sf.1939.rds") %>% select(selected.vars)
wr.sf.1939$year <- "1939"

wr.sf.1949 <- readRDS("wr.sf.1949.rds") %>% select(selected.vars)
wr.sf.1949$year <- "1949"

wr.sf.1959 <- readRDS("wr.sf.1959.rds") %>% select(selected.vars)
wr.sf.1959$year <- "1959"

wr.sf.1969 <- readRDS("wr.sf.1969.rds") %>% select(selected.vars)
wr.sf.1969$year <- "1969"

wr.sf.1979 <- readRDS("wr.sf.1979.rds") %>% select(selected.vars)
wr.sf.1979$year <- "1979"

wr.sf.1989 <- readRDS("wr.sf.1989.rds") %>% select(selected.vars)
wr.sf.1989$year <- "1989"

wr.sf.1999 <- readRDS("wr.sf.1999.rds") %>% select(selected.vars)
wr.sf.1999$year <- "1999"

wr.sf.past <- rbind(wr.sf.1899, wr.sf.1909) %>% rbind(wr.sf.1919) %>% 
              rbind(wr.sf.1929) %>% rbind(wr.sf.1939) %>% rbind(wr.sf.1949) %>% 
              rbind(wr.sf.1959) %>% rbind(wr.sf.1969) %>% rbind(wr.sf.1979) %>% 
              rbind(wr.sf.1989) %>% rbind(wr.sf.1999)

#wr.sf.past.mercator <- st_transform(wr.sf.past, st_crs(4326))
wr.sf.exp <- merge(wr.sf.past, st_drop_geometry(wr.basins), by = "gid")
wr.exp <- wr.sf.exp %>% st_drop_geometry()

saveRDS(wr.sf.exp, "wr.sf.exp.rds")
saveRDS(wr.exp, "wr.exp.rds")
```


```{r plot-exp}
wr.exp <- readRDS("wr.exp.rds")

basins.exp <- wr.exp  %>% group_by(sea,year) %>% summarise(TOCyearly = sum(TOC.export), TOC = mean(TOC.fit), TSdep = mean(TSdep), Runoff = mean(Runoff), forest = mean(forest))
basins.exp$yearlyTOC.Tg <- basins.exp$TOCyearly * 1e-15 # from mg to Tg

ggplot(basins.exp, aes(x=year, y = yearlyTOC.Tg, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  ylab("Yearly export of TOC, Tg")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = TOC, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  ylab("Predicted TOC concentration, mg/L")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = TSdep, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  ylab("Total S deposition mg/m2/year")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = Runoff, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  ylab("Runoff, kg/m2/y")+
  theme_minimal()
ggplot(basins.exp, aes(x=year, y = forest, col = sea))+geom_point()+
  geom_line(aes(group = sea))+
  ylab("Forest cover, %")+
  theme_minimal()


```

Changes in selected wr:

* Oslo fjord: 24085
* West Norway: 157966
* North Norway: 29877
* South Sweden: 28116
* Est Sweden: 261558
* Central Sweden: 98655
* Northern Sweden: 38747
* South Finland: 127449
* East Finland: 73788
* North Finland: 16728

```{r forest-changes}
wr10 <- filter(wr.exp, gid %in% c("24085", "157966", "29877", "28116", "261558","98655","38747","127449","73788","16728"))

ggplot(wr10, aes(x=year, y = forest, col = as.factor(gid)))+geom_point()+
  geom_line(aes(group = as.factor(gid)))+
  ylab("Forest cover, %")+
  theme_minimal()

```

```{r maps-past-toc, hold = T, fig.dim = c(10,30)}
library(grid)
library(png)
library(cowplot)

listgrob <- list("map.toc.1899.png","map.toc.1909.png","map.toc.1919.png","map.toc.1929.png","map.toc.1939.png","map.toc.1949.png","map.toc.1959.png","map.toc.1969.png","map.toc.1979.png","map.toc.1989.png", "map.toc.1999.png") %>% lapply(readPNG) %>% lapply(rasterGrob)

all.map <- plot_grid(plotlist = listgrob, ncol= 2, nrow = 6, align = "v", greedy = T)

print(all.map)
```